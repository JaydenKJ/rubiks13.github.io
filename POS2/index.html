<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple POS System</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        /* Dark Theme Styles */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #1a1a1a; /* Dark background */
            color: #e0e0e0; /* Light text */
            overflow-y: scroll; /* Allow scrolling for long content */
        }
        .tab-container {
            width: 90%;
            max-width: 1200px;
            background-color: #2c2c2c; /* Slightly lighter dark background */
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #444; /* Darker border */
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background-color: #3a3a3a; /* Dark button background */
            border: none;
            outline: none;
            font-size: 18px;
            color: #b0b0b0; /* Lighter button text */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-button:hover {
            background-color: #4a4a4a; /* Darker hover */
        }
        .tab-button.active {
            background-color: #007bff; /* Accent color */
            color: white;
            border-bottom: 3px solid #007bff;
        }
        .tab-content {
            padding: 20px;
            display: none; /* Hidden by default */
        }
        .tab-content.active {
            display: block; /* Shown when active */
        }
        h1, h2, h3 {
            color: #ffffff; /* White headings */
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #e0e0e0;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #555; /* Darker border for inputs */
            border-radius: 4px;
            font-size: 16px;
            background-color: #3a3a3a; /* Dark input background */
            color: #e0e0e0; /* Light input text */
        }
        /* Hidden input for barcode scanning - Refined for focusability */
        .hidden-input-for-scan {
            position: absolute;
            left: -9999px; /* Move off-screen */
            width: 1px; /* Make it take minimal space */
            height: 1px; /* Make it take minimal space */
            border: none; /* Remove any visible border */
            padding: 0; /* Remove padding */
            margin: 0; /* Remove margin */
            font-size: 0; /* Hide text if any */
            line-height: 0; /* Hide line height */
            /* Do NOT use display: none or visibility: hidden as they prevent focus */
            /* Do NOT use opacity: 0; and pointer-events: none; as pointer-events can interfere with focus */
        }
        input[type="file"] {
            margin-bottom: 15px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-top: 5px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.red {
            background-color: #dc3545;
        }
        button.red:hover {
            background-color: #c82333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444; /* Darker table border */
        }
        th {
            background-color: #3a3a3a; /* Darker table header */
            border-bottom: 1px solid #555;
            color: #ffffff;
        }
        #cart-total {
            font-size: 20px;
            font-weight: bold;
            margin-top: 20px;
            text-align: right;
            color: #ffffff;
        }
        .receipt-container {
            display: none; /* Hidden by default */
            /* Width controlled by JS now via setting posReceiptWidth */
            padding: 10px;
            border: 1px solid #000;
            margin-top: 20px;
            background-color: #ffffff; /* White background for receipt to ensure printability */
            color: #000000; /* Black text for receipt */
            font-family: 'Consolas', 'Monospace';
            font-size: 12px;
            line-height: 1.4;
        }
        .receipt-header, .receipt-footer {
            text-align: center;
            margin-bottom: 10px;
        }
        .receipt-header img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        .receipt-items div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        .receipt-total {
            text-align: right;
            margin-top: 10px;
            font-weight: bold;
        }
        .receipt-separator {
            border-top: 1px dashed #000;
            margin: 10px 0;
        }
        #receipt-barcode-container {
            text-align: center;
            margin-top: 15px;
        }
        #receipt-barcode-container svg {
            width: 100%; /* Make barcode fill container width */
            height: 50px; /* Adjust height as needed */
        }
        #logo-preview {
            max-width: 150px;
            max-height: 150px;
            margin-top: 10px;
            border: 1px solid #555;
            display: block;
        }

        /* Modal specific styles */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark semi-transparent background */
            z-index: 1000; /* On top of everything */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2c2c2c; /* Same as tab container */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            width: 90%;
            max-width: 800px;
            position: relative;
            color: #e0e0e0;
            max-height: 90vh; /* Max height to allow scrolling if content is long */
            overflow-y: auto; /* Enable scrolling for modal content */
        }
        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close-button:hover {
            color: #fff;
        }
        .modal-content h2, .modal-content h3 {
            color: #ffffff;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-content table {
            margin-bottom: 20px;
        }

        /* Styling for the data string display area - now hidden */
        #dataStringDisplay {
            word-wrap: break-word; /* Allow long words to break and wrap to the next line */
            max-width: 100%;
            background-color: #3a3a3a;
            border: 1px solid #555;
            padding: 0px; /* No padding to make it truly hidden */
            height: 0px; /* Collapse its height */
            overflow: hidden; /* Hide any overflow */
            margin-top: 10px;
            margin-bottom: 15px;
            font-family: 'Consolas', 'Monospace';
            font-size: 14px;
            color: #e0e0e0;
        }

        /* Styles for radio buttons in Item Management */
        .item-type-selection, .discount-type-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        .item-type-selection label, .discount-type-selection label {
            display: inline-flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
        }
        .item-type-selection input[type="radio"], .discount-type-selection input[type="radio"] {
            margin-right: 5px;
            appearance: none; /* Hide default radio button */
            width: 16px;
            height: 16px;
            border: 2px solid #007bff;
            border-radius: 50%;
            background-color: #3a3a3a;
            outline: none;
            cursor: pointer;
            position: relative;
            top: 1px;
        }
        .item-type-selection input[type="radio"]:checked, .discount-type-selection input[type="radio"]:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        .item-type-selection input[type="radio"]:checked::before, .discount-type-selection input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Style for discount barcodes in the table */
        .discount-barcode-container {
            padding: 5px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #3a3a3a;
            display: inline-block; /* Keep it compact */
            margin-top: 5px;
        }
        .discount-barcode-container svg {
            display: block;
            width: 120px; /* Adjust as needed */
            height: 40px; /* Adjust as needed */
        }

        /* Responsive adjustments for layout */
        .coupons-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .coupons-header h2 {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        .discount-type-fields > div {
            margin-bottom: 15px;
        }
        .discount-type-fields input {
            width: calc(100% - 22px); /* Adjust for padding and border */
        }
        .receipt-discount-section, .receipt-recommendations-section {
            margin-top: 10px;
            margin-bottom: 10px;
            padding-top: 5px;
            padding-bottom: 5px;
        }
        .receipt-recommendations-section h4 {
            text-align: center;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        .receipt-recommendation-item {
            margin-bottom: 8px;
            border: 1px dashed #bbb;
            padding: 5px;
            text-align: center;
            page-break-inside: avoid; /* Prevent breaking across pages in print */
        }
        .receipt-recommendation-item p {
            margin: 0;
            font-size: 0.9em;
        }
        .receipt-recommendation-item svg {
            display: block;
            margin: 0 auto;
            width: 100px; /* Smaller barcode for recommendations */
            height: 30px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-container, .receipt-container * {
                visibility: visible;
            }
            .receipt-container {
                position: absolute;
                left: 0;
                top: 0;
                /* Width is set by JS from posReceiptWidth */
                border: none;
                box-shadow: none;
            }
            .modal-overlay {
                display: none !important; /* Hide modal during print */
            }
        }
    </style>
</head>
<body>
    <h1>Simple POS System</h1>

    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab(event, 'ItemManagement')">Item Management</button>
            <button class="tab-button" onclick="openTab(event, 'Checkout')">Checkout</button>
            <button class="tab-button" onclick="openTab(event, 'Coupons')">Coupons</button>
            <button class="tab-button" onclick="openTab(event, 'Members')">Members</button>
            <button class="tab-button" onclick="openTab(event, 'SalesHistory')">Sales History</button>
            <button class="tab-button" onclick="openTab(event, 'Settings')">Settings</button>
        </div>

        <div id="ItemManagement" class="tab-content active">
            <h2>Item Management</h2>
            <label for="itemName">Item Name:</label>
            <input type="text" id="itemName" placeholder="e.g., Apple">

            <label for="itemBarcode">Barcode:</label>
            <input type="text" id="itemBarcode" placeholder="e.g., 123456789012">

            <div class="item-type-selection">
                <p style="margin-bottom: 0;">Item Type:</p>
                <label>
                    <input type="radio" name="itemType" value="normal" checked onchange="togglePriceLabel()"> Normal
                </label>
                <label>
                    <input type="radio" name="itemType" value="produce" onchange="togglePriceLabel()"> Produce
                </label>
            </div>

            <label for="itemPrice" id="itemPriceLabel">Price:</label>
            <input type="number" id="itemPrice" step="0.01" min="0" value="0.00">

            <label for="itemStock">Stock:</label>
            <input type="number" id="itemStock" min="0" value="1">
            <p style="font-size: 0.9em; color: #b0b0b0;">*Stock is not tracked for produce items.</p>


            <button id="addItemButton" onclick="addItem()">Add Item</button>
            <button id="cancelEditButton" class="red" style="display: none;" onclick="clearItemFormAndState()">Cancel Edit</button>

            <h2>Available Items</h2>
            <table id="item-list">
                <thead>
                    <tr>
                        <th>Barcode</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="Checkout" class="tab-content">
            <h2>Checkout</h2>
            <label for="memberBarcode">Scan Member Barcode (or enter 0 to skip):</label>
            <input type="text" id="memberBarcode" class="hidden-input-for-scan" placeholder="Scan member barcode" onkeyup="if(event.keyCode === 13) checkMemberBarcode()">
            <div style="padding: 10px; border: 1px dashed #555; text-align: center; margin-bottom: 15px;">
                Member status: <span id="memberStatus">Ready for member scan.</span>
            </div>
            <p id="appliedDiscountStatus" style="padding: 10px; border: 1px dashed #007bff; text-align: center; margin-bottom: 15px; display: none;">
                Applied Discount: <span id="appliedDiscountTitle"></span> (Valid Thru: <span id="appliedDiscountValidThru"></span>)
            </p>

            <label for="checkoutBarcode">Scan/Enter Item or Discount Barcode Here:</label>
            <input type="text" id="checkoutBarcode" class="hidden-input-for-scan" placeholder="Enter item or discount barcode" onkeyup="if(event.keyCode === 13) processCheckoutBarcode()">
            <div style="padding: 10px; border: 1px dashed #555; text-align: center; margin-bottom: 15px;">
                Ready to scan item or discount barcode...
            </div>
            <button onclick="processCheckoutBarcode()">Add to Cart / Apply Discount</button>

            <h3>Shopping Cart</h3>
            <table id="cart-items">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Price</th>
                        <th>Qty</th>
                        <th>Subtotal</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="cart-total">Subtotal: $0.00</div>
            <button onclick="checkout()">Checkout</button>
            <button class="red" onclick="clearCart()">Clear Cart</button>

            <hr style="border-top: 1px dashed #555; margin: 30px 0;">

            <h2>Returns</h2>
            <button onclick="openReturnsModal()">Process Returns</button>
        </div>

        <div id="Coupons" class="tab-content">
            <div class="coupons-header">
                <h2>Current Discounts</h2>
                <button onclick="openAddDiscountModal()">Add Discount</button>
            </div>
            <table id="discount-list">
                <thead>
                    <tr>
                        <th>Barcode</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Details</th>
                        <th>% Off</th>
                        <th>Valid Thru</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="Members" class="tab-content">
            <h2>Member Management</h2>
            <label for="memberName">Member Name:</label>
            <input type="text" id="memberName" placeholder="e.g., John Doe">

            <label for="memberAddBarcode">Member Barcode:</label>
            <input type="text" id="memberAddBarcode" placeholder="e.g., M123456789">

            <button id="addMemberButton" onclick="addMember()">Add Member</button>
            <button id="cancelEditMemberButton" class="red" style="display: none;" onclick="clearMemberFormAndState()">Cancel Edit</button>

            <h2>Current Members</h2>
            <table id="member-list">
                <thead>
                    <tr>
                        <th>Barcode</th>
                        <th>Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="SalesHistory" class="tab-content">
            <h2>Sales History</h2>
            <table id="sales-history">
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Transaction ID</th>
                        <th>Member</th>
                        <th>Total</th>
                        <th>Items</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="Settings" class="tab-content">
            <h2>Settings</h2>
            <h3>Store Information</h3>
            <label for="settingStoreName">Store Name:</label>
            <input type="text" id="settingStoreName" placeholder="e.g., My Awesome Store">

            <label for="settingStoreAddress">Street Address:</label>
            <input type="text" id="settingStoreAddress" placeholder="e.g., 123 Main Street, Anytown, USA">

            <label for="settingStorePhone">Telephone:</label>
            <input type="text" id="settingStorePhone" placeholder="e.g., (123) 456-7890">

            <h3>Tax Percentage</h3>
            <label for="settingTaxPercentage">Sales Tax Percentage (%):</label>
            <input type="number" id="settingTaxPercentage" step="0.01" min="0" max="100" value="7.25">
            <p style="font-size: 0.9em; color: #b0b0b0;">Enter as a percentage, e.g., 7.25 for 7.25%</p>

            <h3>Membership Fee</h3>
            <label for="settingMembershipFee">Non-Member Fee ($):</label>
            <input type="number" id="settingMembershipFee" step="0.01" min="0" value="0.20">
            <p style="font-size: 0.9em; color: #b0b0b0;">This fee is applied if no valid member barcode is scanned at checkout.</p>

            <h3>Receipt Settings</h3>
            <label for="settingReceiptWidth">Receipt Width (mm):</label>
            <input type="number" id="settingReceiptWidth" step="1" min="50" max="120" value="80">
            <p style="font-size: 0.9em; color: #b0b0b0;">Typical thermal printer widths are 58mm or 80mm.</p>

            <button onclick="saveStoreSettings()">Save Store Settings</button>

            <hr style="border-top: 1px dashed #555; margin: 30px 0;">

            <h3>Receipt Logo</h3>
            <label for="logoUpload">Upload Logo Image (PNG, JPG, JPEG, GIF):</label>
            <input type="file" id="logoUpload" accept="image/png, image/jpeg, image/gif" onchange="handleLogoUpload(event)">
            <img id="logo-preview" src="#" alt="Logo Preview" style="display: none;">
            <button onclick="saveLogo()">Save Logo</button>
            <button class="red" onclick="clearLogo()">Clear Logo</button>

            <hr style="border-top: 1px dashed #555; margin: 30px 0;">

            <h2>Data Transfer</h2>
            <h3>Give Data</h3>
            <p>The full POS data string is generated and can be copied using the button below. It is hidden for display purposes.</p>
            <div id="dataStringDisplay"></div>
            <button onclick="copyDataCode()">Copy Data String</button>


            <h3>Receive Data</h3>
            <p>Paste the data string from another device here to load its data. This will overwrite existing data.</p>
            <input type="text" id="receiveDataCode" placeholder="Paste data string here">
            <button onclick="receiveData()">Load Data</button>
        </div>
    </div>

    <div id="returnsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeReturnsModal()">&times;</button>
            <h2>Process Returns</h2>
            <label for="returnTransactionId">Scan Barcode or Enter Transaction ID Here:</label>
            <input type="text" id="returnTransactionId" class="hidden-input-for-scan" placeholder="Enter Transaction ID" onkeyup="if(event.keyCode === 13) loadReturnItems()">
            <div style="padding: 10px; border: 1px dashed #555; text-align: center; margin-bottom: 15px;">
                Ready to scan receipt barcode or enter Transaction ID...
            </div>
            <button onclick="loadReturnItems()">Load Items for Return</button>

            <div id="return-items-section">
                <h3>Items from Transaction: <span id="return-trans-id-display"></span></h3>
                <table id="return-items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Original Qty</th>
                            <th>Qty to Return</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                <button onclick="processReturn()">Process Selected Returns</button>
                <button class="red" onclick="clearReturnForm()">Clear Return Form</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="cancelPayment()">&times;</button>
            <h2>Select Payment Method</h2>

            <div id="paymentMethodSelection">
                <p>Total Due: $<span id="overallTotalDue">0.00</span></p>
                <button onclick="showCashPayment()">Cash</button>
                <button onclick="showCardPayment()">Card</button>
                <button class="red" onclick="cancelPayment()">Cancel</button>
            </div>

            <div id="cashPaymentSection" style="display: none;">
                <h3>Cash Payment</h3>
                <p>Total Due: $<span id="cashTotalDue">0.00</span></p>
                <label for="amountGiven">Amount Given:</label>
                <input type="number" id="amountGiven" step="0.01" min="0" value="0.00">
                <p>Change Due: $<span id="changeDue">0.00</span></p>
                <button onclick="calculateChange()">Tender</button>
                <button class="red" onclick="backToPaymentSelection()">Back</button>
            </div>

            <div id="cardPaymentSection" style="display: none;">
                <h3>Card Payment</h3>
                <p>Total Due: $<span id="cardTotalDue">0.00</span></p>
                <label for="creditCardNumber">Enter Credit Card Number:</label>
                <input type="text" id="creditCardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
                <button onclick="processCardPayment()">Process</button>
                <button class="red" onclick="backToPaymentSelection()">Back</button>
            </div>
        </div>
    </div>

    <div id="produceWeightModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="cancelProduceWeightEntry()">&times;</button>
            <h2>Enter Produce Weight</h2>
            <p>Item: <strong id="produceItemName"></strong></p>
            <p>Price per Ounce: $<span id="produceItemPricePerOz"></span></p>
            <label for="produceWeight">Weight (ounces):</label>
            <input type="number" id="produceWeight" step="0.01" min="0.01" value="0.00">
            <button onclick="addProduceToCart()">Add to Cart</button>
            <button class="red" onclick="cancelProduceWeightEntry()">Cancel</button>
        </div>
    </div>

    <div id="addDiscountModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeAddDiscountModal()">&times;</button>
            <h2><span id="discountModalTitle">Add New Discount</span></h2>

            <label for="discountTitle">Discount Title:</label>
            <input type="text" id="discountTitle" placeholder="e.g., Summer Sale">

            <label for="discountDescription">Description:</label>
            <textarea id="discountDescription" rows="3" placeholder="e.g., Get 15% off all summer items!"></textarea>

            <label for="discountPercentage">Percentage Off (%):</label>
            <input type="number" id="discountPercentage" step="0.01" min="0.01" max="100" value="0.01">

            <label for="discountValidThru">Valid Thru Date:</label>
            <input type="date" id="discountValidThru">


            <div class="discount-type-selection">
                <p style="margin-bottom: 0;">Discount Type:</p>
                <label>
                    <input type="radio" name="discountType" value="fullTotal" checked onchange="toggleDiscountFields()"> Full Total
                </label>
                <label>
                    <input type="radio" name="discountType" value="purchaseMinimum" onchange="toggleDiscountFields()"> Purchase Minimum
                </label>
                <label>
                    <input type="radio" name="discountType" value="oneItem" onchange="toggleDiscountFields()"> One Item Discount
                </label>
            </div>

            <div id="discountTypeFields" class="discount-type-fields">
                <div id="oneItemDiscountFields" style="display: none;">
                    <label for="discountItemBarcode">Target Item Barcode (for 'One Item Discount'):</label>
                    <input type="text" id="discountItemBarcode" placeholder="Barcode of the item to discount">
                </div>
                <div id="purchaseMinimumFields" style="display: none;">
                    <label for="discountMinimumPrice">Minimum Purchase Price ($):</label>
                    <input type="number" id="discountMinimumPrice" step="0.01" min="0.01" value="0.01">
                </div>
            </div>

            <button id="saveDiscountButton" onclick="saveDiscount()">Add Discount</button>
            <button id="cancelEditDiscountButton" class="red" style="display: none;" onclick="clearDiscountFormAndState()">Cancel Edit</button>
        </div>
    </div>


    <div id="receipt" class="receipt-container">
        <div class="receipt-header">
            <img id="receipt-logo" src="#" alt="Store Logo" style="display: none;">
            <h3 id="receipt-store-name">Your Store Name</h3>
            <p id="receipt-address">123 Main Street, Anytown, USA</p>
            <p id="receipt-phone">Tel: (123) 456-7890</p>
            <p>Date: <span id="receipt-date"></span></p>
            <p>Time: <span id="receipt-time"></span></p>
            <p>Trans ID: <span id="receipt-transaction-id"></span></p>
            <p id="receipt-member-info"></p> <div class="receipt-separator"></div>
        </div>
        <div class="receipt-body">
            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px;">
                <span style="width: 40%;">ITEM</span><span style="width: 25%; text-align: center;">QTY</span><span style="width: 15%; text-align: right;">PRICE</span><span style="width: 20%; text-align: right;">TOTAL</span>
            </div>
            <div class="receipt-items">
            </div>
            <div class="receipt-separator"></div>

            <div id="receipt-discount-applied" class="receipt-discount-section" style="display: none;">
                <p style="font-weight: bold;">DISCOUNT APPLIED:</p>
                <p style="font-style: italic;"><span id="applied-discount-title"></span>: <span id="applied-discount-desc"></span></p>
                <p style="font-style: italic;">Valid Thru: <span id="applied-discount-valid-thru"></span></p>
                <p style="text-align: right; font-weight: bold;">SAVED: $<span id="applied-discount-amount"></span></p>
                <div class="receipt-separator"></div>
            </div>

            <div class="receipt-total">
                <p>SUBTOTAL: $<span id="receipt-subtotal"></span></p>
                <p>NON-MEMBERSHIP FEE: $<span id="receipt-membership-fee"></span></p>
                <p>TAX: $<span id="receipt-tax"></span></p>
                <p>TOTAL: $<span id="receipt-final-total"></span></p>
                <div class="receipt-separator"></div>
                <p>PAYMENT METHOD: <span id="receipt-payment-method"></span></p>
            </div>
        </div>
        <div class="receipt-footer">
            <div class="receipt-separator"></div>
            <p>THANK YOU FOR YOUR PURCHASE!</p>
            <p>Please come again!</p>
            <div id="receipt-barcode-container"></div> <div id="receipt-recommendations" class="receipt-recommendations-section" style="display: none;">
                <div class="receipt-separator" style="border-top: 1px dashed #888;"></div>
                <h4>RECOMMENDED DISCOUNTS FOR YOU!</h4>
                <div id="recommended-discounts-list">
                    </div>
                <div class="receipt-separator" style="border-top: 1px dashed #888;"></div>
            </div>

        </div>
    </div>

    <script>
        let items = {}; // Stores items by barcode: {barcode: {name, price, stock, isProduce}}
        let cart = {}; // Stores items in cart: {barcode: {name, price, qty, isProduce, originalPricePerOz (for produce)}}
        let salesHistory = [];
        let members = {}; // Stores members by barcode: {barcode: {name}}
        let discounts = {}; // Stores discounts: {discountId: {title, description, percentage, type, itemBarcode?, minimumPrice?, validThru}}
        let transactionIdCounter = 1000; // Simple counter for transaction IDs
        let discountIdCounter = 1; // Counter for discount IDs
        let currentReturnTransaction = null; // Store the sale object for the current return process
        let receiptLogo = null; // Stores the Base64 string of the logo
        let generatedDataString = ""; // Store the generated data string for copying/QR

        // Global variables for store settings
        let storeName = "Your Store Name";
        let storeAddress = "123 Main Street, Anytown, USA";
        let storePhone = "(123) 456-7890";
        let salesTaxPercentage = 7.25; // Stored as percentage (e.g., 7.25 for 7.25%)
        let nonMemberFee = 0.20; // Default non-member fee
        let receiptWidth = 80; // Default receipt width in mm

        // Global variable for editing item
        let editingBarcode = null;
        // Global variable for editing member
        let editingMemberBarcode = null;
        // Global variable for editing discount
        let editingDiscountId = null;

        // Global variables for the current transaction totals
        let currentTransactionSubtotal = 0;
        let currentTransactionDiscountAmount = 0; // NEW: Discount amount for the current transaction
        let currentTransactionMembershipFee = 0;
        let currentTransactionTaxAmount = 0;
        let currentTransactionFinalTotal = 0;
        let currentTransactionMember = null; // Store the member object for the current transaction
        let appliedDiscount = null; // Stores the discount object currently applied to the cart

        // Global variable for produce checkout
        let currentProduceBarcode = null;

        // --- Local Storage Functions ---
        function saveData() {
            localStorage.setItem('posItems', JSON.stringify(items));
            localStorage.setItem('posCart', JSON.stringify(cart));
            localStorage.setItem('posSalesHistory', JSON.stringify(salesHistory));
            localStorage.setItem('posMembers', JSON.stringify(members)); // Save members
            localStorage.setItem('posDiscounts', JSON.stringify(discounts)); // Save discounts
            localStorage.setItem('posTransactionIdCounter', transactionIdCounter);
            localStorage.setItem('posDiscountIdCounter', discountIdCounter); // Save discount ID counter
            if (receiptLogo) {
                localStorage.setItem('posReceiptLogo', receiptLogo);
            } else {
                localStorage.removeItem('posReceiptLogo');
            }
            // Save store settings
            localStorage.setItem('posStoreName', storeName);
            localStorage.setItem('posStoreAddress', storeAddress);
            localStorage.setItem('posStorePhone', storePhone);
            localStorage.setItem('posSalesTaxPercentage', salesTaxPercentage);
            localStorage.setItem('posNonMemberFee', nonMemberFee);
            localStorage.setItem('posReceiptWidth', receiptWidth);
        }

        function loadData() {
            const storedItems = localStorage.getItem('posItems');
            const storedCart = localStorage.getItem('posCart');
            const storedSalesHistory = localStorage.getItem('posSalesHistory');
            const storedMembers = localStorage.getItem('posMembers');
            const storedDiscounts = localStorage.getItem('posDiscounts'); // Load discounts
            const storedTransactionIdCounter = localStorage.getItem('posTransactionIdCounter');
            const storedDiscountIdCounter = localStorage.getItem('posDiscountIdCounter'); // Load discount ID counter
            const storedReceiptLogo = localStorage.getItem('posReceiptLogo');

            if (storedItems) {
                items = JSON.parse(storedItems);
            } else {
                addDummyData();
            }

            if (storedCart) {
                cart = JSON.parse(storedCart);
            }

            if (storedSalesHistory) {
                salesHistory = JSON.parse(storedSalesHistory);
            }

            if (storedMembers) {
                members = JSON.parse(storedMembers);
            } else {
                addDummyMembers();
            }

            if (storedDiscounts) { // Load discounts
                discounts = JSON.parse(storedDiscounts);
                cleanupExpiredDiscounts(); // Clean up expired discounts on load
            } else {
                addDummyDiscounts();
            }

            if (storedTransactionIdCounter && !isNaN(parseInt(storedTransactionIdCounter))) {
                transactionIdCounter = parseInt(storedTransactionIdCounter);
            }
            if (storedDiscountIdCounter && !isNaN(parseInt(storedDiscountIdCounter))) { // Load discount ID counter
                discountIdCounter = parseInt(storedDiscountIdCounter);
            }


            if (storedReceiptLogo) {
                receiptLogo = storedReceiptLogo;
            }

            // Load store settings
            const storedStoreName = localStorage.getItem('posStoreName');
            const storedStoreAddress = localStorage.getItem('posStoreAddress');
            const storedStorePhone = localStorage.getItem('posStorePhone');
            const storedSalesTaxPercentage = localStorage.getItem('posSalesTaxPercentage');
            const storedNonMemberFee = localStorage.getItem('posNonMemberFee');
            const storedReceiptWidth = localStorage.getItem('posReceiptWidth');

            if (storedStoreName) {
                storeName = storedStoreName;
            }
            if (storedStoreAddress) {
                storeAddress = storedStoreAddress;
            }
            if (storedStorePhone) {
                storePhone = storedStorePhone;
            }
            if (storedSalesTaxPercentage && !isNaN(parseFloat(storedSalesTaxPercentage))) {
                salesTaxPercentage = parseFloat(storedSalesTaxPercentage);
            }
            if (storedNonMemberFee && !isNaN(parseFloat(storedNonMemberFee))) {
                nonMemberFee = parseFloat(storedNonMemberFee);
            }
            if (storedReceiptWidth && !isNaN(parseInt(storedReceiptWidth))) {
                receiptWidth = parseInt(storedReceiptWidth);
            }
        }
        // --- End Local Storage Functions ---

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderItems();
            updateCartDisplay();
            renderMembers();
            renderSalesHistory();
            renderDiscounts(); // Render discounts on load
            openTab(null, 'ItemManagement');
        });

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;

            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                document.querySelector(`.tab-button[onclick*="'${tabName}'"]`).className += " active";
            }

            // Auto-focus hidden input for relevant tabs
            if (tabName === 'Checkout') {
                currentTransactionMember = null;
                appliedDiscount = null; // Clear applied discount on tab change
                document.getElementById('memberStatus').textContent = 'Ready for member scan.';
                document.getElementById('memberBarcode').value = '';
                document.getElementById('appliedDiscountStatus').style.display = 'none'; // Hide discount status
                setTimeout(() => {
                    document.getElementById('memberBarcode').focus();
                }, 100);
                updateCartDisplay(); // Re-render cart in case discount was applied
            } else if (tabName === 'Settings') {
                renderSettings();
            } else if (tabName === 'Members') {
                renderMembers();
            } else if (tabName === 'Coupons') { // Render discounts when opening Coupons tab
                cleanupExpiredDiscounts(); // Clean up on tab open
                renderDiscounts();
            }

            // Clear form states when switching tabs
            if (tabName !== 'ItemManagement') {
                clearItemFormAndState();
            }
            if (tabName !== 'Members') {
                clearMemberFormAndState();
            }
            if (tabName !== 'Coupons') {
                // Clear discount form if modal is open, or just ensure it's reset
                if (document.getElementById('addDiscountModal').style.display === 'flex') {
                    closeAddDiscountModal();
                }
                clearDiscountFormAndState();
            }
        }

        function addDummyData() {
            if (Object.keys(items).length === 0) {
                items['123456789012'] = { name: 'Apple', price: 1.50, stock: 50, isProduce: false };
                items['987654321098'] = { name: 'Banana', price: 0.75, stock: 100, isProduce: false };
                items['112233445566'] = { name: 'Milk (1L)', price: 3.00, stock: 30, isProduce: false };
                items['223344556677'] = { name: 'Bread', price: 2.20, stock: 40, isProduce: false };
                items['PROD001'] = { name: 'Avocado', price: 0.50, stock: -1, isProduce: true };
                items['PROD002'] = { name: 'Organic Spinach', price: 0.25, stock: -1, isProduce: true };
                saveData();
            }
        }

        function addDummyMembers() {
            if (Object.keys(members).length === 0) {
                members['MEMBER001'] = { name: 'Alice Smith' };
                members['MEMBER002'] = { name: 'Bob Johnson' };
                saveData();
            }
        }

        function addDummyDiscounts() {
            if (Object.keys(discounts).length === 0) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                const farFuture = new Date();
                farFuture.setFullYear(farFuture.getFullYear() + 1);

                discounts['DISC-1'] = { id: 'DISC-1', title: 'Weekend Sale', description: '10% off entire purchase!', percentage: 10, type: 'fullTotal', validThru: tomorrow.toISOString().split('T')[0] };
                discounts['DISC-2'] = { id: 'DISC-2', title: 'Fruit Lovers', description: '50% off Apples!', percentage: 50, type: 'oneItem', itemBarcode: '123456789012', validThru: nextMonth.toISOString().split('T')[0] };
                discounts['DISC-3'] = { id: 'DISC-3', title: 'Big Spender', description: '20% off if you spend over $50!', percentage: 20, type: 'purchaseMinimum', minimumPrice: 50.00, validThru: farFuture.toISOString().split('T')[0] };
                discounts['DISC-4'] = { id: 'DISC-4', title: 'Milk Deal', description: '25% off Milk!', percentage: 25, type: 'oneItem', itemBarcode: '112233445566', validThru: nextMonth.toISOString().split('T')[0] };
                discounts['DISC-5'] = { id: 'DISC-5', title: 'Vegetable Special', description: '15% off Organic Spinach!', percentage: 15, type: 'oneItem', itemBarcode: 'PROD002', validThru: farFuture.toISOString().split('T')[0] };
                discountIdCounter = 6;
                saveData();
            }
        }

        function togglePriceLabel() {
            const itemPriceLabel = document.getElementById('itemPriceLabel');
            const itemPriceInput = document.getElementById('itemPrice');
            const itemStockLabel = document.querySelector('label[for="itemStock"]');
            const itemStockInput = document.getElementById('itemStock');
            const itemStockNote = itemStockInput.nextElementSibling;

            const isProduce = document.querySelector('input[name="itemType"]:checked').value === 'produce';

            if (isProduce) {
                itemPriceLabel.textContent = 'Price per Ounce:';
                if (parseFloat(itemPriceInput.value) <= 0.01) {
                    itemPriceInput.value = '0.01';
                }
                itemStockLabel.style.display = 'none';
                itemStockInput.style.display = 'none';
                itemStockNote.style.display = 'block';
                itemStockInput.value = '-1';
            } else {
                itemPriceLabel.textContent = 'Price:';
                if (parseFloat(itemPriceInput.value) === 0.01) {
                    itemPriceInput.value = '0.00';
                }
                itemStockLabel.style.display = 'block';
                itemStockInput.style.display = 'block';
                itemStockNote.style.display = 'none';
                if (parseInt(itemStockInput.value) === -1) {
                    itemStockInput.value = '1';
                }
            }
        }

        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const barcode = document.getElementById('itemBarcode').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value);
            const stock = parseInt(document.getElementById('itemStock').value);
            const isProduce = document.querySelector('input[name="itemType"]:checked').value === 'produce';

            if (!name || !barcode || isNaN(price) || price <= 0) {
                alert('Please fill in all item details correctly. Price must be greater than 0.');
                return;
            }

            if (!isProduce && (isNaN(stock) || stock < 0)) {
                 alert('For normal items, stock must be 0 or greater.');
                 return;
            }

            const itemStock = isProduce ? -1 : stock;

            if (editingBarcode) {
                if (editingBarcode !== barcode) {
                    alert("Error: Cannot change barcode while editing. Please cancel and re-edit if barcode needs to change.");
                    return;
                }
                items[barcode] = { name, price, stock: itemStock, isProduce };
                alert(`Item "${name}" (Barcode: ${barcode}) updated.`);
            } else {
                if (items[barcode]) {
                    alert(`Item with barcode ${barcode} already exists (${items[barcode].name}). Use the "Edit" button to modify.`);
                    return;
                }
                items[barcode] = { name, price, stock: itemStock, isProduce };
                alert(`Item "${name}" (Barcode: ${barcode}) added.`);
            }

            renderItems();
            clearItemFormAndState();
            saveData();
        }

        function editItem(barcode) {
            const item = items[barcode];
            if (!item) {
                alert('Item not found for editing.');
                return;
            }

            document.getElementById('itemName').value = item.name;
            document.getElementById('itemBarcode').value = barcode;
            document.getElementById('itemBarcode').readOnly = true;
            document.getElementById('itemPrice').value = item.price.toFixed(2);
            document.getElementById('itemStock').value = item.stock;

            document.querySelector(`input[name="itemType"][value="${item.isProduce ? 'produce' : 'normal'}"]`).checked = true;
            togglePriceLabel();

            editingBarcode = barcode;

            document.getElementById('addItemButton').textContent = 'Save Changes';
            document.getElementById('cancelEditButton').style.display = 'inline-block';
        }

        function clearItemFormAndState() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemBarcode').value = '';
            document.getElementById('itemBarcode').readOnly = false;
            document.getElementById('itemPrice').value = '0.00';
            document.getElementById('itemStock').value = '1';

            document.querySelector('input[name="itemType"][value="normal"]').checked = true;
            togglePriceLabel();

            editingBarcode = null;

            document.getElementById('addItemButton').textContent = 'Add Item';
            document.getElementById('cancelEditButton').style.display = 'none';
        }

        function renderItems() {
            const itemListBody = document.querySelector('#item-list tbody');
            itemListBody.innerHTML = '';
            for (const barcode in items) {
                const item = items[barcode];
                const row = itemListBody.insertRow();
                row.insertCell().textContent = barcode;
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.isProduce ? 'Produce' : 'Normal';
                row.insertCell().textContent = item.isProduce ? `$${item.price.toFixed(2)} / Oz` : `$${item.price.toFixed(2)}`;
                row.insertCell().textContent = item.isProduce ? 'N/A' : item.stock;
                const actionsCell = row.insertCell();

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => editItem(barcode);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'red';
                deleteButton.onclick = () => deleteItem(barcode);
                actionsCell.appendChild(deleteButton);
            }
        }

        function deleteItem(barcode) {
            if (confirm(`Are you sure you want to delete item with barcode: ${barcode}?`)) {
                delete items[barcode];
                renderItems();
                clearItemFormAndState();
                saveData();
            }
        }

        function checkMemberBarcode() {
            const memberBarcodeInput = document.getElementById('memberBarcode');
            const barcode = memberBarcodeInput.value.trim();
            memberBarcodeInput.value = '';

            if (barcode === '0' || barcode === '') {
                currentTransactionMember = null;
                document.getElementById('memberStatus').textContent = 'No member scanned (Non-membership fee applies).';
                document.getElementById('checkoutBarcode').focus();
                return;
            }

            const member = members[barcode];
            if (member) {
                currentTransactionMember = { barcode: barcode, name: member.name };
                document.getElementById('memberStatus').textContent = `Member: ${member.name}`;
                document.getElementById('checkoutBarcode').focus();
            } else {
                currentTransactionMember = null;
                document.getElementById('memberStatus').textContent = 'Invalid member barcode. No membership applied.';
                alert('Invalid member barcode. Please scan a valid member or enter 0 to proceed without membership.');
                memberBarcodeInput.focus();
            }
        }

        function processCheckoutBarcode() {
            const barcodeInput = document.getElementById('checkoutBarcode');
            const scannedCode = barcodeInput.value.trim();
            barcodeInput.value = ''; // Clear immediately after reading

            if (!scannedCode) {
                barcodeInput.focus();
                return;
            }

            // Check if it's a discount code (our convention)
            if (scannedCode.startsWith('DISCOUNT-')) {
                applyDiscount(scannedCode);
                barcodeInput.focus();
                return;
            }

            // If not a discount, proceed with item logic
            addToCart(scannedCode);
        }

        function addToCart(barcode) {
            const item = items[barcode];
            const barcodeInput = document.getElementById('checkoutBarcode');

            if (!item) {
                alert('Item not found.');
                barcodeInput.focus();
                return;
            }

            if (item.isProduce) {
                currentProduceBarcode = barcode;
                document.getElementById('produceItemName').textContent = item.name;
                document.getElementById('produceItemPricePerOz').textContent = item.price.toFixed(2);
                document.getElementById('produceWeight').value = '0.00';
                document.getElementById('produceWeightModal').style.display = 'flex';
                setTimeout(() => document.getElementById('produceWeight').focus(), 100);
            } else {
                if (item.stock <= 0) {
                    alert(`${item.name} is out of stock.`);
                    barcodeInput.focus();
                    return;
                }

                if (cart[barcode]) {
                    if (item.stock > 0) {
                        cart[barcode].qty++;
                    } else {
                         alert(`Cannot add more ${item.name}. Maximum stock reached.`);
                         barcodeInput.focus();
                         return;
                    }
                } else {
                    cart[barcode] = {
                        name: item.name,
                        price: item.price,
                        qty: 1,
                        isProduce: false
                    };
                }
                item.stock--;
                renderItems();
                updateCartDisplay();
                saveData();
                barcodeInput.focus();
            }
        }

        function addProduceToCart() {
            const barcode = currentProduceBarcode;
            const item = items[barcode];
            const weight = parseFloat(document.getElementById('produceWeight').value);

            if (isNaN(weight) || weight <= 0) {
                alert('Please enter a valid weight in ounces (must be greater than 0).');
                document.getElementById('produceWeight').focus();
                return;
            }

            const calculatedPrice = item.price * weight;

            const uniqueProduceId = barcode + '-' + Date.now();
            cart[uniqueProduceId] = {
                name: `${item.name} (${weight.toFixed(2)} oz)`,
                price: calculatedPrice,
                qty: 1,
                isProduce: true,
                originalBarcode: barcode,
                originalPricePerOz: item.price,
                weight: weight
            };

            updateCartDisplay();
            saveData();
            cancelProduceWeightEntry();
            document.getElementById('checkoutBarcode').focus();
        }

        function cancelProduceWeightEntry() {
            document.getElementById('produceWeightModal').style.display = 'none';
            currentProduceBarcode = null;
            document.getElementById('checkoutBarcode').focus();
        }

        function isDiscountValid(discount) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const validThruDate = new Date(discount.validThru);
            validThruDate.setHours(0, 0, 0, 0); // Normalize to start of day

            return validThruDate >= today;
        }

        function applyDiscount(discountId) {
            const discount = discounts[discountId];
            if (!discount) {
                alert('Invalid discount code.');
                return;
            }
            if (!isDiscountValid(discount)) {
                alert(`Discount "${discount.title}" has expired.`);
                return;
            }
            if (appliedDiscount) {
                alert(`A discount ("${appliedDiscount.title}") is already applied. Only one discount allowed per transaction.`);
                return;
            }

            // Calculate current cart subtotal before applying any discount
            let cartSubtotal = 0;
            for (const key in cart) {
                cartSubtotal += cart[key].price * cart[key].qty;
            }

            let canApply = false;
            let discountDetails = "";

            if (discount.type === 'fullTotal') {
                canApply = true;
                discountDetails = `${discount.percentage}% off entire purchase.`;
            } else if (discount.type === 'purchaseMinimum') {
                if (cartSubtotal >= discount.minimumPrice) {
                    canApply = true;
                    discountDetails = `${discount.percentage}% off for purchases over $${discount.minimumPrice.toFixed(2)}.`;
                } else {
                    alert(`Purchase minimum not met. You need to spend at least $${discount.minimumPrice.toFixed(2)} to use "${discount.title}".`);
                }
            } else if (discount.type === 'oneItem') {
                // Check if the target item is in the cart
                const targetItemInCart = Object.values(cart).find(item => item.originalBarcode === discount.itemBarcode || (item.isProduce === false && item.barcode === discount.itemBarcode));
                if (targetItemInCart) {
                    canApply = true;
                    discountDetails = `${discount.percentage}% off ${targetItemInCart.name}.`;
                } else {
                    const itemInStore = items[discount.itemBarcode];
                    const itemName = itemInStore ? itemInStore.name : 'the specified item';
                    alert(`"${itemName}" is not in your cart. This discount applies only to that item.`);
                }
            }

            if (canApply) {
                appliedDiscount = {
                    id: discount.id,
                    title: discount.title,
                    description: discount.description,
                    percentage: discount.percentage,
                    type: discount.type,
                    itemBarcode: discount.itemBarcode, // Only present for oneItem
                    minimumPrice: discount.minimumPrice, // Only present for purchaseMinimum
                    validThru: discount.validThru // Store valid thru date
                };
                document.getElementById('appliedDiscountTitle').textContent = appliedDiscount.title;
                document.getElementById('appliedDiscountValidThru').textContent = new Date(appliedDiscount.validThru).toLocaleDateString();
                document.getElementById('appliedDiscountStatus').style.display = 'block';
                updateCartDisplay(); // Recalculate and display new total
                alert(`Discount "${discount.title}" applied successfully! ${discountDetails}`);
            }
        }


        function updateCartDisplay() {
            const cartItemsBody = document.querySelector('#cart-items tbody');
            cartItemsBody.innerHTML = '';
            let subtotalBeforeDiscount = 0;

            for (const key in cart) {
                const item = cart[key];
                const itemSubtotal = item.price * item.qty;
                subtotalBeforeDiscount += itemSubtotal;

                const row = cartItemsBody.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = `$${item.price.toFixed(2)}`;
                row.insertCell().textContent = item.isProduce ? `1` : item.qty;
                row.insertCell().textContent = `$${itemSubtotal.toFixed(2)}`;

                const actionsCell = row.insertCell();
                if (!item.isProduce) {
                    const removeOneButton = document.createElement('button');
                    removeOneButton.textContent = '-';
                    removeOneButton.onclick = () => updateCartItemQuantity(key, -1);
                    actionsCell.appendChild(removeOneButton);

                    const addOneButton = document.createElement('button');
                    addOneButton.textContent = '+';
                    addOneButton.onclick = () => updateCartItemQuantity(key, 1);
                    actionsCell.appendChild(addOneButton);
                }

                const removeButton = document.createElement('button');
                removeButton.textContent = 'X';
                removeButton.className = 'red';
                removeButton.onclick = () => removeFromCart(key);
                actionsCell.appendChild(removeButton);
            }

            // Calculate actual discounted subtotal for display
            let displaySubtotal = subtotalBeforeDiscount;
            let actualDiscountAmount = 0;

            if (appliedDiscount) {
                const discountPercentage = appliedDiscount.percentage / 100;

                if (appliedDiscount.type === 'fullTotal' || appliedDiscount.type === 'purchaseMinimum') {
                    // Apply discount to the entire subtotal
                    actualDiscountAmount = subtotalBeforeDiscount * discountPercentage;
                    displaySubtotal -= actualDiscountAmount;
                } else if (appliedDiscount.type === 'oneItem') {
                    // Find the target item in the cart and apply discount only to it
                    const targetItemInCart = Object.values(cart).find(item => item.originalBarcode === appliedDiscount.itemBarcode || (item.isProduce === false && item.barcode === appliedDiscount.itemBarcode));
                    if (targetItemInCart) {
                        actualDiscountAmount = (targetItemInCart.price * targetItemInCart.qty) * discountPercentage;
                        displaySubtotal -= actualDiscountAmount;
                    }
                }
            }
            currentTransactionDiscountAmount = actualDiscountAmount; // Store for checkout process
            document.getElementById('cart-total').textContent = `Subtotal: $${displaySubtotal.toFixed(2)} (-$${actualDiscountAmount.toFixed(2)} discount)`;
        }

        function updateCartItemQuantity(barcode, change) {
            const barcodeInput = document.getElementById('checkoutBarcode');
            const itemInCart = cart[barcode];

            if (!itemInCart || itemInCart.isProduce) {
                barcodeInput.focus();
                return;
            }

            const itemInStore = items[barcode];
            if (!itemInStore) {
                barcodeInput.focus();
                return;
            }

            if (change === 1) {
                if (itemInStore.stock > 0) {
                    itemInCart.qty++;
                    itemInStore.stock--;
                } else {
                    alert(`Cannot add more ${itemInStore.name}. Maximum stock reached.`);
                }
            } else if (change === -1) {
                if (itemInCart.qty > 1) {
                    itemInCart.qty--;
                    itemInStore.stock++;
                } else {
                    removeFromCart(barcode);
                    barcodeInput.focus();
                    return;
                }
            }
            renderItems();
            updateCartDisplay();
            saveData();
            barcodeInput.focus();
        }

        function removeFromCart(key) {
            const barcodeInput = document.getElementById('checkoutBarcode');
            const itemInCart = cart[key];

            if (itemInCart) {
                if (!itemInCart.isProduce && items[key]) {
                    items[key].stock += itemInCart.qty;
                }
                delete cart[key];
                // If the removed item was the target of a 'oneItem' discount, remove the discount
                if (appliedDiscount && appliedDiscount.type === 'oneItem' && (itemInCart.originalBarcode === appliedDiscount.itemBarcode || (!itemInCart.isProduce && key === appliedDiscount.itemBarcode))) {
                    appliedDiscount = null;
                    document.getElementById('appliedDiscountStatus').style.display = 'none';
                    alert('Target item removed from cart. Discount has been unapplied.');
                }
                updateCartDisplay(); // Recalculate discount if items change
                renderItems();
                saveData();
            }
            barcodeInput.focus();
        }

        function clearCart() {
            if (confirm('Are you sure you want to clear the entire cart?')) {
                for (const key in cart) {
                    const itemInCart = cart[key];
                    if (!itemInCart.isProduce && items[key]) {
                        items[key].stock += itemInCart.qty;
                    }
                }
                cart = {};
                currentTransactionMember = null;
                appliedDiscount = null; // Clear applied discount
                document.getElementById('memberStatus').textContent = 'Ready for member scan.';
                document.getElementById('memberBarcode').value = '';
                document.getElementById('appliedDiscountStatus').style.display = 'none'; // Hide discount status
                renderItems();
                updateCartDisplay();
                saveData();
            }
            document.getElementById('memberBarcode').focus();
        }

        function checkout() {
            if (Object.keys(cart).length === 0) {
                alert('Cart is empty. Please add items before checking out.');
                return;
            }

            // Calculate base subtotal (before discount)
            let rawSubtotal = 0;
            for (const key in cart) {
                rawSubtotal += cart[key].price * cart[key].qty;
            }
            currentTransactionSubtotal = rawSubtotal;

            // Discount amount is already calculated in updateCartDisplay and stored in currentTransactionDiscountAmount
            // No need to recalculate here.

            // Determine membership fee
            currentTransactionMembershipFee = currentTransactionMember ? 0.00 : nonMemberFee;

            // Calculate subtotal after discount
            const subtotalAfterDiscount = currentTransactionSubtotal - currentTransactionDiscountAmount;

            const actualSalesTaxRate = salesTaxPercentage / 100;
            // Tax is applied to subtotal (after discount) + membership fee
            currentTransactionTaxAmount = (subtotalAfterDiscount + currentTransactionMembershipFee) * actualSalesTaxRate;
            currentTransactionFinalTotal = subtotalAfterDiscount + currentTransactionMembershipFee + currentTransactionTaxAmount;

            openPaymentModal();
        }

        function completeCheckoutProcess(paymentMethod) {
            const subtotal = currentTransactionSubtotal; // This is the original subtotal
            const discountApplied = appliedDiscount ? { ...appliedDiscount, amountSaved: currentTransactionDiscountAmount } : null; // Store discount details and amount saved
            const membershipFee = currentTransactionMembershipFee;
            const taxAmount = currentTransactionTaxAmount;
            const finalTotal = currentTransactionFinalTotal;

            const now = new Date();
            const transactionId = `TRN-${transactionIdCounter++}`;

            const sale = {
                id: transactionId,
                timestamp: now.toLocaleString(),
                items: JSON.parse(JSON.stringify(cart)),
                subtotal: subtotal, // Original subtotal
                discount: discountApplied, // Store applied discount details
                membershipFee: membershipFee,
                tax: taxAmount,
                total: finalTotal, // Final total after all calculations
                method: paymentMethod,
                member: currentTransactionMember ? JSON.parse(JSON.stringify(currentTransactionMember)) : null
            };
            salesHistory.push(sale);
            renderSalesHistory();
            generateReceipt(sale);
            cart = {};
            currentTransactionMember = null;
            appliedDiscount = null; // Clear applied discount after transaction
            document.getElementById('memberStatus').textContent = 'Ready for member scan.';
            document.getElementById('memberBarcode').value = '';
            document.getElementById('appliedDiscountStatus').style.display = 'none'; // Hide discount status
            updateCartDisplay();
            saveData();
            alert('Checkout successful!');
            document.getElementById('memberBarcode').focus();
            closePaymentModal();
            currentTransactionSubtotal = 0;
            currentTransactionDiscountAmount = 0;
            currentTransactionMembershipFee = 0;
            currentTransactionTaxAmount = 0;
            currentTransactionFinalTotal = 0;
        }

        function renderSalesHistory() {
            const salesHistoryBody = document.querySelector('#sales-history tbody');
            salesHistoryBody.innerHTML = '';
            salesHistory.forEach(sale => {
                const row = salesHistoryBody.insertRow();
                row.insertCell().textContent = sale.timestamp;
                row.insertCell().textContent = sale.id;
                row.insertCell().textContent = sale.member ? sale.member.name : 'N/A';
                row.insertCell().textContent = `$${sale.total.toFixed(2)}`;
                const itemsCell = row.insertCell();
                let itemDetails = [];
                for (const barcode in sale.items) {
                    const item = sale.items[barcode];
                    if (item.isProduce) {
                        itemDetails.push(`${item.name}`);
                    } else {
                        itemDetails.push(`${item.name} (x${item.qty})`);
                    }
                }
                itemsCell.textContent = itemDetails.join(', ');
            });
        }

        // --- Member Management Functions ---
        function addMember() {
            const name = document.getElementById('memberName').value.trim();
            const barcode = document.getElementById('memberAddBarcode').value.trim();

            if (!name || !barcode) {
                alert('Please fill in both member name and barcode.');
                return;
            }

            if (editingMemberBarcode) {
                if (editingMemberBarcode !== barcode) {
                    alert("Error: Cannot change member barcode while editing. Please cancel and re-edit if barcode needs to change.");
                    return;
                }
                members[barcode] = { name: name };
                alert(`Member "${name}" (Barcode: ${barcode}) updated.`);
            } else {
                if (members[barcode]) {
                    alert(`Member with barcode ${barcode} already exists (${members[barcode].name}). Use the "Edit" button to modify.`);
                    return;
                }
                members[barcode] = { name: name };
                alert(`Member "${name}" (Barcode: ${barcode}) added.`);
            }

            renderMembers();
            clearMemberFormAndState();
            saveData();
        }

        function editMember(barcode) {
            const member = members[barcode];
            if (!member) {
                alert('Member not found for editing.');
                return;
            }

            document.getElementById('memberName').value = member.name;
            document.getElementById('memberAddBarcode').value = barcode;
            document.getElementById('memberAddBarcode').readOnly = true;

            editingMemberBarcode = barcode;

            document.getElementById('addMemberButton').textContent = 'Save Changes';
            document.getElementById('cancelEditMemberButton').style.display = 'inline-block';
        }

        function deleteMember(barcode) {
            if (confirm(`Are you sure you want to delete member with barcode: ${barcode}?`)) {
                delete members[barcode];
                renderMembers();
                clearMemberFormAndState();
                saveData();
            }
        }

        function renderMembers() {
            const memberListBody = document.querySelector('#member-list tbody');
            memberListBody.innerHTML = '';
            for (const barcode in members) {
                const member = members[barcode];
                const row = memberListBody.insertRow();
                row.insertCell().textContent = barcode;
                row.insertCell().textContent = member.name;
                const actionsCell = row.insertCell();

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => editMember(barcode);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'red';
                deleteButton.onclick = () => deleteMember(barcode);
                actionsCell.appendChild(deleteButton);
            }
        }

        function clearMemberFormAndState() {
            document.getElementById('memberName').value = '';
            document.getElementById('memberAddBarcode').value = '';
            document.getElementById('memberAddBarcode').readOnly = false;

            editingMemberBarcode = null;

            document.getElementById('addMemberButton').textContent = 'Add Member';
            document.getElementById('cancelEditMemberButton').style.display = 'none';
        }

        // --- Discount Management Functions ---
        function openAddDiscountModal(discountId = null) {
            const modal = document.getElementById('addDiscountModal');
            document.getElementById('discountTitle').value = '';
            document.getElementById('discountDescription').value = '';
            document.getElementById('discountPercentage').value = '0.01';
            document.getElementById('discountValidThru').value = ''; // Clear valid thru date
            document.getElementById('discountItemBarcode').value = '';
            document.getElementById('discountMinimumPrice').value = '0.01';
            document.querySelector('input[name="discountType"][value="fullTotal"]').checked = true;
            toggleDiscountFields(); // Ensure correct fields are visible

            if (discountId) {
                editingDiscountId = discountId;
                const discount = discounts[discountId];
                if (discount) {
                    document.getElementById('discountModalTitle').textContent = 'Edit Discount';
                    document.getElementById('discountTitle').value = discount.title;
                    document.getElementById('discountDescription').value = discount.description;
                    document.getElementById('discountPercentage').value = discount.percentage;
                    document.getElementById('discountValidThru').value = discount.validThru || ''; // Set valid thru date
                    document.querySelector(`input[name="discountType"][value="${discount.type}"]`).checked = true;
                    toggleDiscountFields();
                    if (discount.type === 'oneItem') {
                        document.getElementById('discountItemBarcode').value = discount.itemBarcode;
                    } else if (discount.type === 'purchaseMinimum') {
                        document.getElementById('discountMinimumPrice').value = discount.minimumPrice;
                    }
                    document.getElementById('saveDiscountButton').textContent = 'Save Changes';
                    document.getElementById('cancelEditDiscountButton').style.display = 'inline-block';
                }
            } else {
                editingDiscountId = null;
                document.getElementById('discountModalTitle').textContent = 'Add New Discount';
                document.getElementById('saveDiscountButton').textContent = 'Add Discount';
                document.getElementById('cancelEditDiscountButton').style.display = 'none';
            }
            modal.style.display = 'flex';
        }

        function closeAddDiscountModal() {
            document.getElementById('addDiscountModal').style.display = 'none';
            clearDiscountFormAndState();
        }

        function toggleDiscountFields() {
            const type = document.querySelector('input[name="discountType"]:checked').value;
            document.getElementById('oneItemDiscountFields').style.display = 'none';
            document.getElementById('purchaseMinimumFields').style.display = 'none';

            if (type === 'oneItem') {
                document.getElementById('oneItemDiscountFields').style.display = 'block';
            } else if (type === 'purchaseMinimum') {
                document.getElementById('purchaseMinimumFields').style.display = 'block';
            }
        }

        function saveDiscount() {
            const title = document.getElementById('discountTitle').value.trim();
            const description = document.getElementById('discountDescription').value.trim();
            const percentage = parseFloat(document.getElementById('discountPercentage').value);
            const validThru = document.getElementById('discountValidThru').value; // Get valid thru date
            const type = document.querySelector('input[name="discountType"]:checked').value;
            let itemBarcode = null;
            let minimumPrice = null;

            if (!title || !description || isNaN(percentage) || percentage <= 0 || percentage > 100 || !validThru) {
                alert('Please fill in all discount details correctly, including a valid "Valid Thru Date". Percentage must be between 0.01 and 100.');
                return;
            }

            // Validate validThru date: must be today or in the future
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            const selectedDate = new Date(validThru);
            selectedDate.setHours(0, 0, 0, 0); // Normalize to start of day

            if (selectedDate < today) {
                alert('The "Valid Thru Date" cannot be in the past.');
                return;
            }


            if (type === 'oneItem') {
                itemBarcode = document.getElementById('discountItemBarcode').value.trim();
                if (!itemBarcode) {
                    alert('Please enter the target item barcode for "One Item Discount".');
                    return;
                }
                if (!items[itemBarcode]) {
                    alert(`Item with barcode "${itemBarcode}" does not exist in your inventory. Please ensure it's correct.`);
                    return;
                }
            } else if (type === 'purchaseMinimum') {
                minimumPrice = parseFloat(document.getElementById('discountMinimumPrice').value);
                if (isNaN(minimumPrice) || minimumPrice <= 0) {
                    alert('Please enter a valid minimum purchase price for "Purchase Minimum".');
                    return;
                }
            }

            const discountData = {
                title,
                description,
                percentage,
                validThru, // Save valid thru date
                type,
                itemBarcode,
                minimumPrice
            };

            let discountId;
            if (editingDiscountId) {
                discountId = editingDiscountId;
                discounts[discountId] = discountData;
                alert(`Discount "${title}" updated.`);
            } else {
                discountId = `DISCOUNT-${discountIdCounter++}`;
                discounts[discountId] = { id: discountId, ...discountData };
                alert(`Discount "${title}" added.`);
            }

            renderDiscounts();
            closeAddDiscountModal();
            saveData();
        }

        function clearDiscountFormAndState() {
            document.getElementById('discountTitle').value = '';
            document.getElementById('discountDescription').value = '';
            document.getElementById('discountPercentage').value = '0.01';
            document.getElementById('discountValidThru').value = '';
            document.getElementById('discountItemBarcode').value = '';
            document.getElementById('discountMinimumPrice').value = '0.01';
            document.querySelector('input[name="discountType"][value="fullTotal"]').checked = true;
            toggleDiscountFields();
            editingDiscountId = null;
            document.getElementById('discountModalTitle').textContent = 'Add New Discount';
            document.getElementById('saveDiscountButton').textContent = 'Add Discount';
            document.getElementById('cancelEditDiscountButton').style.display = 'none';
        }

        function cleanupExpiredDiscounts() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            let cleaned = false;
            for (const id in discounts) {
                const discount = discounts[id];
                const validThruDate = new Date(discount.validThru);
                validThruDate.setHours(0, 0, 0, 0);

                if (validThruDate < today) {
                    console.log(`Deleting expired discount: ${discount.title} (ID: ${id})`);
                    delete discounts[id];
                    cleaned = true;
                }
            }
            if (cleaned) {
                saveData();
                renderDiscounts(); // Re-render the table to reflect deletions
            }
        }

        function renderDiscounts() {
            cleanupExpiredDiscounts(); // Ensure expired discounts are removed before rendering
            const discountListBody = document.querySelector('#discount-list tbody');
            discountListBody.innerHTML = '';
            for (const id in discounts) {
                const discount = discounts[id];
                const row = discountListBody.insertRow();

                const barcodeCell = row.insertCell();
                const barcodeContainer = document.createElement('div');
                barcodeContainer.className = 'discount-barcode-container';
                barcodeCell.appendChild(barcodeContainer);
                const barcodeSvgId = `discount-barcode-${id}`;
                barcodeContainer.innerHTML = `<svg id="${barcodeSvgId}"></svg>`;
                try {
                    JsBarcode(`#${barcodeSvgId}`, id, {
                        format: "CODE128",
                        displayValue: true,
                        width: 2,
                        height: 40,
                        margin: 0,
                        fontSize: 12
                    });
                } catch (e) {
                    console.error(`Error generating barcode for ${id}:`, e);
                    barcodeContainer.textContent = `Error: ${id}`;
                }


                row.insertCell().textContent = discount.title;
                row.insertCell().textContent = discount.description;
                row.insertCell().textContent = discount.type.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); // Format type nicely

                let details = '';
                if (discount.type === 'oneItem') {
                    const itemName = items[discount.itemBarcode] ? items[discount.itemBarcode].name : 'Unknown Item';
                    details = `Applies to: ${itemName} (Barcode: ${discount.itemBarcode})`;
                } else if (discount.type === 'purchaseMinimum') {
                    details = `Min. Purchase: $${discount.minimumPrice.toFixed(2)}`;
                } else if (discount.type === 'fullTotal') {
                    details = 'Applies to total purchase';
                }
                row.insertCell().textContent = details;
                row.insertCell().textContent = `${discount.percentage}%`;
                row.insertCell().textContent = new Date(discount.validThru).toLocaleDateString();

                const actionsCell = row.insertCell();
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => openAddDiscountModal(id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'red';
                deleteButton.onclick = () => deleteDiscount(id);
                actionsCell.appendChild(deleteButton);
            }
        }

        function deleteDiscount(id) {
            if (confirm(`Are you sure you want to delete the discount "${discounts[id].title}"?`)) {
                delete discounts[id];
                renderDiscounts();
                saveData();
                // If the deleted discount was the applied one in cart, clear it
                if (appliedDiscount && appliedDiscount.id === id) {
                    appliedDiscount = null;
                    document.getElementById('appliedDiscountStatus').style.display = 'none';
                    updateCartDisplay();
                }
            }
        }


        // --- Settings Tab Functions ---
        function saveStoreSettings() {
            const newStoreName = document.getElementById('settingStoreName').value.trim();
            const newStoreAddress = document.getElementById('settingStoreAddress').value.trim();
            const newStorePhone = document.getElementById('settingStorePhone').value.trim();
            const newTaxPercentage = parseFloat(document.getElementById('settingTaxPercentage').value);
            const newNonMemberFee = parseFloat(document.getElementById('settingMembershipFee').value);
            const newReceiptWidth = parseInt(document.getElementById('settingReceiptWidth').value);

            if (!newStoreName || !newStoreAddress || !newStorePhone) {
                alert('Please fill in all store information fields.');
                return;
            }
            if (isNaN(newTaxPercentage) || newTaxPercentage < 0 || newTaxPercentage > 100) {
                alert('Please enter a valid sales tax percentage between 0 and 100.');
                return;
            }
            if (isNaN(newNonMemberFee) || newNonMemberFee < 0) {
                alert('Please enter a valid non-member fee (0 or greater).');
                return;
            }
            if (isNaN(newReceiptWidth) || newReceiptWidth < 50 || newReceiptWidth > 120) {
                alert('Please enter a valid receipt width between 50mm and 120mm.');
                return;
            }

            storeName = newStoreName;
            storeAddress = newStoreAddress;
            storePhone = newStorePhone;
            salesTaxPercentage = newTaxPercentage;
            nonMemberFee = newNonMemberFee;
            receiptWidth = newReceiptWidth;

            saveData();
            alert('Store settings saved successfully!');
            generateDataStringForDisplay();
        }

        function renderSettings() {
            document.getElementById('settingStoreName').value = storeName;
            document.getElementById('settingStoreAddress').value = storeAddress;
            document.getElementById('settingStorePhone').value = storePhone;
            document.getElementById('settingTaxPercentage').value = salesTaxPercentage.toFixed(2);
            document.getElementById('settingMembershipFee').value = nonMemberFee.toFixed(2);
            document.getElementById('settingReceiptWidth').value = receiptWidth;

            if (receiptLogo) {
                document.getElementById('logo-preview').src = receiptLogo;
                document.getElementById('logo-preview').style.display = 'block';
            } else {
                document.getElementById('logo-preview').style.display = 'none';
                document.getElementById('logo-preview').src = '#';
            }
            document.getElementById('receiveDataCode').value = '';

            generateDataStringForDisplay();
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    alert('Please upload an image file (PNG, JPG, JPEG, GIF).');
                    event.target.value = '';
                    document.getElementById('logo-preview').style.display = 'none';
                    document.getElementById('logo-preview').src = '#';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('logo-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('logo-preview').style.display = 'none';
                document.getElementById('logo-preview').src = '#';
            }
        }

        function saveLogo() {
            const preview = document.getElementById('logo-preview');
            if (preview.src && preview.src.startsWith('data:image/')) {
                receiptLogo = preview.src;
                saveData();
                alert('Logo saved successfully!');
                generateDataStringForDisplay();
            } else {
                alert('No valid logo image selected to save.');
            }
        }

        function clearLogo() {
            if (confirm('Are you sure you want to clear the receipt logo?')) {
                receiptLogo = null;
                document.getElementById('logoUpload').value = '';
                document.getElementById('logo-preview').style.display = 'none';
                document.getElementById('logo-preview').src = '#';
                saveData();
                alert('Logo cleared.');
                generateDataStringForDisplay();
            }
        }

        // --- Returns Modal Functions ---

        function openReturnsModal() {
            document.getElementById('returnsModal').style.display = 'flex';
            setTimeout(() => {
                const returnTransactionIdInput = document.getElementById('returnTransactionId');
                if (returnTransactionIdInput) {
                    returnTransactionIdInput.focus();
                }
            }, 100);
            document.getElementById('return-items-section').style.display = 'block';
            document.getElementById('return-trans-id-display').textContent = '';
            document.querySelector('#return-items-table tbody').innerHTML = '';
            document.getElementById('returnTransactionId').value = '';
            currentReturnTransaction = null;
        }

        function closeReturnsModal() {
            document.getElementById('returnsModal').style.display = 'none';
            document.getElementById('memberBarcode').focus();
        }

        function searchSaleByTransactionId(transactionId) {
            return salesHistory.find(sale => sale.id === transactionId);
        }

        function loadReturnItems() {
            const barcodeInput = document.getElementById('returnTransactionId');
            const transactionId = barcodeInput.value.trim();
            barcodeInput.value = '';

            if (!transactionId) {
                barcodeInput.focus();
                return;
            }

            const saleToReturn = searchSaleByTransactionId(transactionId);

            if (!saleToReturn) {
                alert(`No sale found for Transaction ID: ${transactionId}`);
                document.getElementById('return-trans-id-display').textContent = 'N/A';
                document.querySelector('#return-items-table tbody').innerHTML = '';
                currentReturnTransaction = null;
                barcodeInput.focus();
                return;
            }

            const purchaseDate = new Date(saleToReturn.timestamp);
            const currentDate = new Date();

            purchaseDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);

            const diffTime = Math.abs(currentDate.getTime() - purchaseDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            const currentYear = currentDate.getFullYear();
            const purchaseYear = purchaseDate.getFullYear();

            const june14_2025 = new Date('2025-06-14T00:00:00');

            if (currentDate >= june14_2025 && purchaseYear < currentYear) {
                alert(`This transaction (${transactionId}) is from a previous year. Returns are only allowed within the current calendar year after June 14, 2025.`);
                document.getElementById('return-trans-id-display').textContent = 'N/A';
                document.querySelector('#return-items-table tbody').innerHTML = '';
                currentReturnTransaction = null;
                barcodeInput.focus();
                return;
            }

            if (diffDays > 30) {
                alert(`This transaction (${transactionId}) is outside the 30-day return window.`);
                document.getElementById('return-trans-id-display').textContent = 'N/A';
                document.querySelector('#return-items-table tbody').innerHTML = '';
                currentReturnTransaction = null;
                barcodeInput.focus();
                return;
            }

            currentReturnTransaction = saleToReturn;
            document.getElementById('return-trans-id-display').textContent = transactionId;

            const returnItemsTableBody = document.querySelector('#return-items-table tbody');
            returnItemsTableBody.innerHTML = '';

            for (const key in saleToReturn.items) {
                const item = saleToReturn.items[key];
                const row = returnItemsTableBody.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.qty;

                const qtyReturnCell = row.insertCell();
                const qtyReturnInput = document.createElement('input');
                qtyReturnInput.type = 'number';
                qtyReturnInput.min = '0';
                qtyReturnInput.max = item.qty;
                qtyReturnInput.value = '0';
                qtyReturnInput.dataset.barcode = key;
                qtyReturnInput.dataset.isProduce = item.isProduce;
                qtyReturnCell.appendChild(qtyReturnInput);
            }
            barcodeInput.focus();
        }

        function processReturn() {
            if (!currentReturnTransaction) {
                alert('No transaction loaded for return.');
                document.getElementById('returnTransactionId').focus();
                return;
            }

            const returnItemsTableBody = document.querySelector('#return-items-table tbody');
            const returnInputs = returnItemsTableBody.querySelectorAll('input[type="number"]');
            let itemsToProcess = [];
            let totalReturnAmount = 0;
            let isValid = true;

            returnInputs.forEach(input => {
                const key = input.dataset.barcode;
                const isProduce = input.dataset.isProduce === 'true';
                const qtyToReturn = parseInt(input.value);

                if (qtyToReturn < 0) {
                    alert('Quantity to return cannot be negative.');
                    isValid = false;
                    return;
                }

                if (qtyToReturn > 0) {
                    const originalItem = currentReturnTransaction.items[key];
                    if (originalItem && qtyToReturn <= originalItem.qty) {
                        const unitPriceForReturn = isProduce ? originalItem.price / originalItem.qty : originalItem.price;

                        itemsToProcess.push({
                            barcode: originalItem.originalBarcode || key,
                            name: originalItem.name,
                            qty: qtyToReturn,
                            price: unitPriceForReturn,
                            isProduce: isProduce,
                            weight: isProduce ? originalItem.weight : null
                        });
                        totalReturnAmount += (unitPriceForReturn * qtyToReturn);
                    } else if (originalItem) {
                        alert(`Cannot return ${qtyToReturn} of ${originalItem.name}. Only ${originalItem.qty} were purchased in this transaction.`);
                        isValid = false;
                        return;
                    }
                }
            });

            if (!isValid) {
                document.getElementById('returnTransactionId').focus();
                return;
            }

            if (itemsToProcess.length === 0) {
                alert('No items selected for return or invalid quantities entered.');
                document.getElementById('returnTransactionId').focus();
                return;
            }

            if (confirm(`Confirm return of items totalling $${totalReturnAmount.toFixed(2)}?`)) {
                itemsToProcess.forEach(returnItem => {
                    if (!returnItem.isProduce && items[returnItem.barcode]) {
                        items[returnItem.barcode].stock += returnItem.qty;
                    } else if (returnItem.isProduce) {
                        console.log(`Returned produce item ${returnItem.name} (barcode: ${returnItem.barcode}). Stock is not tracked for produce.`);
                    } else {
                        console.warn(`Returned item ${returnItem.name} (barcode: ${returnItem.barcode}) not found in current inventory. Stock not updated.`);
                    }
                });

                renderItems();
                saveData();

                alert(`Return processed successfully for Transaction ID ${currentReturnTransaction.id}. Total refund/credit: $${totalReturnAmount.toFixed(2)}.`);
                clearReturnForm();
            }
            document.getElementById('returnTransactionId').focus();
        }

        function clearReturnForm() {
            document.getElementById('returnTransactionId').value = '';
            document.querySelector('#return-items-table tbody').innerHTML = '';
            document.getElementById('return-trans-id-display').textContent = '';
            currentReturnTransaction = null;
            document.getElementById('returnTransactionId').focus();
        }

        // Payment Modal Functions

        function openPaymentModal() {
            document.getElementById('paymentModal').style.display = 'flex';
            document.getElementById('paymentMethodSelection').style.display = 'block';
            document.getElementById('cashPaymentSection').style.display = 'none';
            document.getElementById('cardPaymentSection').style.display = 'none';
            document.getElementById('overallTotalDue').textContent = currentTransactionFinalTotal.toFixed(2);
            document.getElementById('cashTotalDue').textContent = currentTransactionFinalTotal.toFixed(2);
            document.getElementById('cardTotalDue').textContent = currentTransactionFinalTotal.toFixed(2);
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('amountGiven').value = '0.00';
            document.getElementById('changeDue').textContent = '0.00';
            document.getElementById('creditCardNumber').value = '';
        }

        function cancelPayment() {
            closePaymentModal();
            document.getElementById('memberBarcode').focus();
        }

        function backToPaymentSelection() {
            document.getElementById('paymentMethodSelection').style.display = 'block';
            document.getElementById('cashPaymentSection').style.display = 'none';
            document.getElementById('cardPaymentSection').style.display = 'none';
            document.getElementById('amountGiven').value = '0.00';
            document.getElementById('changeDue').textContent = '0.00';
            document.getElementById('creditCardNumber').value = '';
            document.getElementById('overallTotalDue').textContent = currentTransactionFinalTotal.toFixed(2);
        }

        function showCashPayment() {
            document.getElementById('paymentMethodSelection').style.display = 'none';
            document.getElementById('cashPaymentSection').style.display = 'block';
            document.getElementById('amountGiven').value = currentTransactionFinalTotal.toFixed(2);
            document.getElementById('changeDue').textContent = '0.00';
            setTimeout(() => document.getElementById('amountGiven').focus(), 100);
        }

        function calculateChange() {
            const amountGiven = parseFloat(document.getElementById('amountGiven').value);
            if (isNaN(amountGiven) || amountGiven < currentTransactionFinalTotal) {
                alert('Amount given must be a valid number and at least the total due.');
                document.getElementById('amountGiven').focus();
                return;
            }
            const change = amountGiven - currentTransactionFinalTotal;
            document.getElementById('changeDue').textContent = change.toFixed(2);
            alert(`Change Due: $${change.toFixed(2)}`);
            completeCheckoutProcess('Cash');
        }

        function showCardPayment() {
            document.getElementById('paymentMethodSelection').style.display = 'none';
            document.getElementById('cardPaymentSection').style.display = 'block';
            document.getElementById('creditCardNumber').value = '';
            setTimeout(() => document.getElementById('creditCardNumber').focus(), 100);
        }

        function processCardPayment() {
            const cardNumber = document.getElementById('creditCardNumber').value.trim();
            if (!cardNumber) {
                alert('Please enter a credit card number.');
                document.getElementById('creditCardNumber').focus();
                return;
            }
            alert('Processing card... Transaction complete!');
            completeCheckoutProcess('Card');
        }

        // --- Receipt Generation with 1D Barcode, Logo, and Discounts ---
        function generateReceipt(sale) {
            const receiptDiv = document.getElementById('receipt');
            receiptDiv.style.width = `${receiptWidth}mm`;

            const receiptLogoImg = document.getElementById('receipt-logo');
            const receiptDate = document.getElementById('receipt-date');
            const receiptTime = document.getElementById('receipt-time');
            const receiptTransactionId = document.getElementById('receipt-transaction-id');
            const receiptMemberInfo = document.getElementById('receipt-member-info');
            const receiptItemsDiv = document.querySelector('.receipt-items');
            const receiptDiscountSection = document.getElementById('receipt-discount-applied');
            const appliedDiscountTitleSpan = document.getElementById('applied-discount-title');
            const appliedDiscountDescSpan = document.getElementById('applied-discount-desc');
            const appliedDiscountValidThruSpan = document.getElementById('applied-discount-valid-thru');
            const appliedDiscountAmountSpan = document.getElementById('applied-discount-amount');
            const receiptSubtotalSpan = document.getElementById('receipt-subtotal');
            const receiptMembershipFeeSpan = document.getElementById('receipt-membership-fee');
            const receiptTaxSpan = document.getElementById('receipt-tax');
            const receiptFinalTotalSpan = document.getElementById('receipt-final-total');
            const receiptPaymentMethodSpan = document.getElementById('receipt-payment-method');
            const receiptBarcodeContainer = document.getElementById('receipt-barcode-container');
            const recommendedDiscountsSection = document.getElementById('receipt-recommendations');
            const recommendedDiscountsListDiv = document.getElementById('recommended-discounts-list');

            receiptItemsDiv.innerHTML = '';
            receiptBarcodeContainer.innerHTML = ''; // Clear previous barcode
            recommendedDiscountsListDiv.innerHTML = ''; // Clear previous recommendations

            if (receiptLogo) {
                receiptLogoImg.src = receiptLogo;
                receiptLogoImg.style.display = 'block';
            } else {
                receiptLogoImg.style.display = 'none';
                receiptLogoImg.src = '#';
            }

            document.getElementById('receipt-store-name').textContent = storeName;
            document.getElementById('receipt-address').textContent = storeAddress;
            document.getElementById('receipt-phone').textContent = `Tel: ${storePhone}`;

            const now = new Date();
            receiptDate.textContent = now.toLocaleDateString();
            receiptTime.textContent = now.toLocaleTimeString();
            receiptTransactionId.textContent = sale.id;

            if (sale.member) {
                receiptMemberInfo.innerHTML = `Thanks for being a ${storeName} member, ${sale.member.name}!`;
            } else {
                receiptMemberInfo.textContent = 'Non-Membership Fee';
            }

            for (const key in sale.items) {
                const item = sale.items[key];
                const itemTotal = item.price * item.qty;

                let itemNameDisplay = item.name;
                let itemPriceDisplay = `$${item.price.toFixed(2)}`;
                let itemQtyDisplay = item.qty;

                if (item.isProduce) {
                    itemNameDisplay = `${item.name.split(' (')[0]}`;
                    itemPriceDisplay = `$${item.originalPricePerOz.toFixed(2)}/oz`;
                    itemQtyDisplay = `${item.weight.toFixed(2)} oz`;
                }

                const itemLine = document.createElement('div');
                itemLine.innerHTML = `
                    <span style="width: 40%;"> ${itemNameDisplay}</span>
                    <span style="width: 25%; text-align: center;">${itemQtyDisplay}</span>
                    <span style="width: 15%; text-align: right;">${itemPriceDisplay}</span>
                    <span style="width: 20%; text-align: right;">$${itemTotal.toFixed(2)}</span>
                `;
                receiptItemsDiv.appendChild(itemLine);
            }

            // Display applied discount section
            if (sale.discount) {
                receiptDiscountSection.style.display = 'block';
                appliedDiscountTitleSpan.textContent = sale.discount.title;
                appliedDiscountDescSpan.textContent = sale.discount.description;
                appliedDiscountValidThruSpan.textContent = new Date(sale.discount.validThru).toLocaleDateString();
                appliedDiscountAmountSpan.textContent = sale.discount.amountSaved.toFixed(2);
            } else {
                receiptDiscountSection.style.display = 'none';
            }


            receiptSubtotalSpan.textContent = sale.subtotal.toFixed(2);
            receiptMembershipFeeSpan.textContent = sale.membershipFee.toFixed(2);
            receiptTaxSpan.textContent = sale.tax.toFixed(2);
            receiptFinalTotalSpan.textContent = sale.total.toFixed(2);
            receiptPaymentMethodSpan.textContent = sale.method;

            // Generate 1D barcode for transaction ID
            const transactionBarcodeSvg = document.createElement('svg');
            transactionBarcodeSvg.id = 'transaction-barcode-svg';
            receiptBarcodeContainer.appendChild(transactionBarcodeSvg);
            try {
                JsBarcode("#transaction-barcode-svg", sale.id, {
                    format: "CODE128",
                    displayValue: true,
                    width: 2,
                    height: 50,
                    margin: 0,
                    fontSize: 14
                });
            } catch (e) {
                console.error(`Error generating transaction barcode for ${sale.id}:`, e);
                receiptBarcodeContainer.textContent = `Trans ID: ${sale.id}`;
            }

            // Add recommended discounts
            const activeDiscountIds = Object.keys(discounts).filter(id => isDiscountValid(discounts[id])); // Only show valid discounts
            if (activeDiscountIds.length > 0) {
                recommendedDiscountsSection.style.display = 'block';
                let numberOfRecommendations = 0;
                if (sale.member) {
                    numberOfRecommendations = Math.floor(Math.random() * (20 - 6 + 1)) + 6; // 6-20 for members
                } else {
                    numberOfRecommendations = Math.floor(Math.random() * (5 - 2 + 1)) + 2; // 2-5 for non-members
                }

                // Shuffle discounts and pick unique ones
                const shuffledDiscounts = [...activeDiscountIds].sort(() => 0.5 - Math.random());
                const selectedDiscountIds = shuffledDiscounts.slice(0, Math.min(numberOfRecommendations, activeDiscountIds.length));

                selectedDiscountIds.forEach(discountId => {
                    const discount = discounts[discountId];
                    const recItemDiv = document.createElement('div');
                    recItemDiv.className = 'receipt-recommendation-item';
                    recItemDiv.innerHTML = `
                        <p style="font-weight: bold;">${discount.title}</p>
                        <p>${discount.description}</p>
                        <p style="font-size:0.8em; margin-top:2px;">Valid Thru: ${new Date(discount.validThru).toLocaleDateString()}</p>
                        <svg id="rec-barcode-${discountId}"></svg>
                    `;
                    recommendedDiscountsListDiv.appendChild(recItemDiv);

                    // Generate 1D barcode for each recommended discount
                    try {
                        JsBarcode(`#rec-barcode-${discountId}`, discount.id, {
                            format: "CODE128",
                            displayValue: true,
                            width: 1,
                            height: 30,
                            margin: 0,
                            fontSize: 10
                        });
                    } catch (e) {
                        console.error(`Error generating recommendation barcode for ${discount.id}:`, e);
                        document.getElementById(`rec-barcode-${discountId}`).textContent = `Code: ${discount.id}`;
                    }
                });
            } else {
                recommendedDiscountsSection.style.display = 'none';
            }


            receiptDiv.style.display = 'block';
            window.print();
            receiptDiv.style.display = 'none';
        }

        // Data Transfer Functions
        function generateDataStringForDisplay() {
            const allPosData = {
                items: items,
                salesHistory: salesHistory,
                members: members,
                discounts: discounts, // Include discounts in data transfer
                transactionIdCounter: transactionIdCounter,
                discountIdCounter: discountIdCounter, // Include discount ID counter
                receiptLogo: receiptLogo,
                storeName: storeName,
                storeAddress: storeAddress,
                storePhone: storePhone,
                salesTaxPercentage: salesTaxPercentage,
                nonMemberFee: nonMemberFee,
                receiptWidth: receiptWidth
            };
            try {
                const jsonData = JSON.stringify(allPosData);
                generatedDataString = btoa(jsonData);
                document.getElementById('dataStringDisplay').textContent = generatedDataString;
            } catch (error) {
                console.error("Error generating data string:", error);
                document.getElementById('dataStringDisplay').textContent = 'Error generating data string. Data might be too large or invalid.';
                generatedDataString = "";
            }
        }

        function copyDataCode() {
            if (generatedDataString) {
                try {
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = generatedDataString;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    tempTextArea.setSelectionRange(0, 99999);
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    alert('Data string copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy data string. Your browser might not support automatic copying. Please manually select the text from the display area and copy it.');
                }
            } else {
                alert('No data string generated yet. Please open the Settings tab to generate the data string.');
            }
        }

        function receiveData() {
            const receivedCode = document.getElementById('receiveDataCode').value.trim();
            if (!receivedCode) {
                alert('Please paste the data string into the input field.');
                return;
            }

            if (!confirm('WARNING: Loading data will OVERWRITE all existing POS data on this device. Are you sure you want to proceed?')) {
                return;
            }

            try {
                const decodedData = atob(receivedCode);
                const parsedData = JSON.parse(decodedData);

                if (typeof parsedData !== 'object' || parsedData === null ||
                    !parsedData.hasOwnProperty('items') ||
                    !parsedData.hasOwnProperty('salesHistory') ||
                    !parsedData.hasOwnProperty('members') ||
                    !parsedData.hasOwnProperty('discounts') || // Check for discounts
                    !parsedData.hasOwnProperty('transactionIdCounter') ||
                    !parsedData.hasOwnProperty('storeName'))
                {
                    throw new Error('Invalid data structure in the received code.');
                }

                items = parsedData.items || {};
                salesHistory = parsedData.salesHistory || [];
                members = parsedData.members || {};
                discounts = parsedData.discounts || {}; // Update discounts
                transactionIdCounter = parsedData.transactionIdCounter || 1000;
                discountIdCounter = parsedData.discountIdCounter || 1; // Update discount ID counter
                receiptLogo = parsedData.receiptLogo || null;
                storeName = parsedData.storeName || "Your Store Name";
                storeAddress = parsedData.storeAddress || "123 Main Street, Anytown, USA";
                storePhone = parsedData.storePhone || "(123) 456-7890";
                salesTaxPercentage = parsedData.salesTaxPercentage || 7.25;
                nonMemberFee = parsedData.nonMemberFee || 0.20;
                receiptWidth = parsedData.receiptWidth || 80;

                saveData();
                alert('Data loaded successfully! The system will now refresh to reflect the changes.');

                renderItems();
                updateCartDisplay();
                renderMembers();
                renderSalesHistory();
                renderDiscounts(); // Re-render discounts list
                renderSettings();

            } catch (error) {
                console.error("Error receiving data:", error);
                alert(`Failed to load data. Please ensure the code is correct and not corrupted. Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
