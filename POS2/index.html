<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple POS System</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <style>
        /* Dark Theme Styles */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #1a1a1a; /* Dark background */
            color: #e0e0e0; /* Light text */
            overflow-y: scroll; /* Allow scrolling for long content */
        }
        .tab-container {
            width: 90%;
            max-width: 1200px;
            background-color: #2c2c2c; /* Slightly lighter dark background */
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #444; /* Darker border */
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background-color: #3a3a3a; /* Dark button background */
            border: none;
            outline: none;
            font-size: 18px;
            color: #b0b0b0; /* Lighter button text */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-button:hover {
            background-color: #4a4a4a; /* Darker hover */
        }
        .tab-button.active {
            background-color: #007bff; /* Accent color */
            color: white;
            border-bottom: 3px solid #007bff;
        }
        .tab-content {
            padding: 20px;
            display: none; /* Hidden by default */
        }
        .tab-content.active {
            display: block; /* Shown when active */
        }
        h1, h2, h3 {
            color: #ffffff; /* White headings */
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #e0e0e0;
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #555; /* Darker border for inputs */
            border-radius: 4px;
            font-size: 16px;
            background-color: #3a3a3a; /* Dark input background */
            color: #e0e0e0; /* Light input text */
        }
        /* Hidden input for barcode scanning - Refined for focusability */
        .hidden-input-for-scan {
            position: absolute;
            left: -9999px; /* Move off-screen */
            width: 1px; /* Make it take minimal space */
            height: 1px; /* Make it take minimal space */
            border: none; /* Remove any visible border */
            padding: 0; /* Remove padding */
            margin: 0; /* Remove margin */
            font-size: 0; /* Hide text if any */
            line-height: 0; /* Hide line height */
            /* Do NOT use display: none or visibility: hidden as they prevent focus */
            /* Do NOT use opacity: 0; and pointer-events: none; as pointer-events can interfere with focus */
        }
        input[type="file"] {
            margin-bottom: 15px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-top: 5px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.red {
            background-color: #dc3545;
        }
        button.red:hover {
            background-color: #c82333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444; /* Darker table border */
        }
        th {
            background-color: #3a3a3a; /* Darker table header */
            border-bottom: 1px solid #555;
            color: #ffffff;
        }
        #cart-total {
            font-size: 20px;
            font-weight: bold;
            margin-top: 20px;
            text-align: right;
            color: #ffffff;
        }
        .receipt-container {
            display: none; /* Hidden by default */
            /* Width controlled by JS now via setting posReceiptWidth */
            padding: 10px;
            border: 1px solid #000;
            margin-top: 20px;
            background-color: #ffffff; /* White background for receipt to ensure printability */
            color: #000000; /* Black text for receipt */
            font-family: 'Consolas', 'Monospace';
            font-size: 12px;
            line-height: 1.4;
        }
        .receipt-header, .receipt-footer {
            text-align: center;
            margin-bottom: 10px;
        }
        .receipt-header img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        .receipt-items div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        .receipt-total {
            text-align: right;
            margin-top: 10px;
            font-weight: bold;
        }
        .receipt-separator {
            border-top: 1px dashed #000;
            margin: 10px 0;
        }
        #qrcode-container {
            text-align: center;
            margin-top: 15px;
        }
        #logo-preview {
            max-width: 150px;
            max-height: 150px;
            margin-top: 10px;
            border: 1px solid #555;
            display: block;
        }

        /* Modal specific styles */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark semi-transparent background */
            z-index: 1000; /* On top of everything */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2c2c2c; /* Same as tab container */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            width: 90%;
            max-width: 800px;
            position: relative;
            color: #e0e0e0;
            max-height: 90vh; /* Max height to allow scrolling if content is long */
            overflow-y: auto; /* Enable scrolling for modal content */
        }
        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close-button:hover {
            color: #fff;
        }
        .modal-content h2, .modal-content h3 {
            color: #ffffff;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-content table {
            margin-bottom: 20px;
        }

        /* Styling for the data string display area - now hidden */
        #dataStringDisplay {
            word-wrap: break-word; /* Allow long words to break and wrap to the next line */
            max-width: 100%;
            background-color: #3a3a3a;
            border: 1px solid #555;
            padding: 0px; /* No padding to make it truly hidden */
            height: 0px; /* Collapse its height */
            overflow: hidden; /* Hide any overflow */
            margin-top: 10px;
            margin-bottom: 15px;
            font-family: 'Consolas', 'Monospace';
            font-size: 14px;
            color: #e0e0e0;
        }

        /* Styles for radio buttons in Item Management */
        .item-type-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
        }
        .item-type-selection label {
            display: inline-flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
        }
        .item-type-selection input[type="radio"] {
            margin-right: 5px;
            appearance: none; /* Hide default radio button */
            width: 16px;
            height: 16px;
            border: 2px solid #007bff;
            border-radius: 50%;
            background-color: #3a3a3a;
            outline: none;
            cursor: pointer;
            position: relative;
            top: 1px;
        }
        .item-type-selection input[type="radio"]:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        .item-type-selection input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-container, .receipt-container * {
                visibility: visible;
            }
            .receipt-container {
                position: absolute;
                left: 0;
                top: 0;
                /* Width is set by JS from posReceiptWidth */
                border: none;
                box-shadow: none;
            }
            .modal-overlay {
                display: none !important; /* Hide modal during print */
            }
        }
    </style>
</head>
<body>
    <h1>Simple POS System</h1>

    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab(event, 'ItemManagement')">Item Management</button>
            <button class="tab-button" onclick="openTab(event, 'Checkout')">Checkout</button>
            <button class="tab-button" onclick="openTab(event, 'Members')">Members</button>
            <button class="tab-button" onclick="openTab(event, 'SalesHistory')">Sales History</button>
            <button class="tab-button" onclick="openTab(event, 'Settings')">Settings</button>
        </div>

        <div id="ItemManagement" class="tab-content active">
            <h2>Item Management</h2>
            <label for="itemName">Item Name:</label>
            <input type="text" id="itemName" placeholder="e.g., Apple">

            <label for="itemBarcode">Barcode:</label>
            <input type="text" id="itemBarcode" placeholder="e.g., 123456789012">

            <div class="item-type-selection">
                <p style="margin-bottom: 0;">Item Type:</p>
                <label>
                    <input type="radio" name="itemType" value="normal" checked onchange="togglePriceLabel()"> Normal
                </label>
                <label>
                    <input type="radio" name="itemType" value="produce" onchange="togglePriceLabel()"> Produce
                </label>
            </div>

            <label for="itemPrice" id="itemPriceLabel">Price:</label>
            <input type="number" id="itemPrice" step="0.01" min="0" value="0.00">

            <label for="itemStock">Stock:</label>
            <input type="number" id="itemStock" min="0" value="1">
            <p style="font-size: 0.9em; color: #b0b0b0;">*Stock is not tracked for produce items.</p>


            <button id="addItemButton" onclick="addItem()">Add Item</button>
            <button id="cancelEditButton" class="red" style="display: none;" onclick="clearItemFormAndState()">Cancel Edit</button>

            <h2>Available Items</h2>
            <table id="item-list">
                <thead>
                    <tr>
                        <th>Barcode</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="Checkout" class="tab-content">
            <h2>Checkout</h2>
            <label for="memberBarcode">Scan Member Barcode (or enter 0 to skip):</label>
            <input type="text" id="memberBarcode" class="hidden-input-for-scan" placeholder="Scan member barcode" onkeyup="if(event.keyCode === 13) checkMemberBarcode()">
            <div style="padding: 10px; border: 1px dashed #555; text-align: center; margin-bottom: 15px;">
                Member status: <span id="memberStatus">Ready for member scan.</span>
            </div>

            <label for="checkoutBarcode">Scan/Enter Item Barcode Here:</label>
            <input type="text" id="checkoutBarcode" class="hidden-input-for-scan" placeholder="Enter item barcode" onkeyup="if(event.keyCode === 13) addToCart()">
            <div style="padding: 10px; border: 1px dashed #555; text-align: center; margin-bottom: 15px;">
                Ready to scan item barcode...
            </div>
            <button onclick="addToCart()">Add to Cart</button>

            <h3>Shopping Cart</h3>
            <table id="cart-items">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Price</th>
                        <th>Qty</th>
                        <th>Subtotal</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="cart-total">Subtotal: $0.00</div>
            <button onclick="checkout()">Checkout</button>
            <button class="red" onclick="clearCart()">Clear Cart</button>

            <hr style="border-top: 1px dashed #555; margin: 30px 0;">

            <h2>Returns</h2>
            <button onclick="openReturnsModal()">Process Returns</button>
        </div>

        <div id="Members" class="tab-content">
            <h2>Member Management</h2>
            <label for="memberName">Member Name:</label>
            <input type="text" id="memberName" placeholder="e.g., John Doe">

            <label for="memberAddBarcode">Member Barcode:</label>
            <input type="text" id="memberAddBarcode" placeholder="e.g., M123456789">

            <button id="addMemberButton" onclick="addMember()">Add Member</button>
            <button id="cancelEditMemberButton" class="red" style="display: none;" onclick="clearMemberFormAndState()">Cancel Edit</button>

            <h2>Current Members</h2>
            <table id="member-list">
                <thead>
                    <tr>
                        <th>Barcode</th>
                        <th>Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="SalesHistory" class="tab-content">
            <h2>Sales History</h2>
            <table id="sales-history">
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Transaction ID</th>
                        <th>Member</th>
                        <th>Total</th>
                        <th>Items</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="Settings" class="tab-content">
            <h2>Settings</h2>
            <h3>Store Information</h3>
            <label for="settingStoreName">Store Name:</label>
            <input type="text" id="settingStoreName" placeholder="e.g., My Awesome Store">

            <label for="settingStoreAddress">Street Address:</label>
            <input type="text" id="settingStoreAddress" placeholder="e.g., 123 Main Street, Anytown, USA">

            <label for="settingStorePhone">Telephone:</label>
            <input type="text" id="settingStorePhone" placeholder="e.g., (123) 456-7890">

            <h3>Tax Percentage</h3>
            <label for="settingTaxPercentage">Sales Tax Percentage (%):</label>
            <input type="number" id="settingTaxPercentage" step="0.01" min="0" max="100" value="7.25">
            <p style="font-size: 0.9em; color: #b0b0b0;">Enter as a percentage, e.g., 7.25 for 7.25%</p>

            <h3>Membership Fee</h3>
            <label for="settingMembershipFee">Non-Member Fee ($):</label>
            <input type="number" id="settingMembershipFee" step="0.01" min="0" value="0.20">
            <p style="font-size: 0.9em; color: #b0b0b0;">This fee is applied if no valid member barcode is scanned at checkout.</p>

            <h3>Receipt Settings</h3>
            <label for="settingReceiptWidth">Receipt Width (mm):</label>
            <input type="number" id="settingReceiptWidth" step="1" min="50" max="120" value="80">
            <p style="font-size: 0.9em; color: #b0b0b0;">Typical thermal printer widths are 58mm or 80mm.</p>

            <button onclick="saveStoreSettings()">Save Store Settings</button>

            <hr style="border-top: 1px dashed #555; margin: 30px 0;">

            <h3>Receipt Logo</h3>
            <label for="logoUpload">Upload Logo Image (PNG, JPG, JPEG, GIF):</label>
            <input type="file" id="logoUpload" accept="image/png, image/jpeg, image/gif" onchange="handleLogoUpload(event)">
            <img id="logo-preview" src="#" alt="Logo Preview" style="display: none;">
            <button onclick="saveLogo()">Save Logo</button>
            <button class="red" onclick="clearLogo()">Clear Logo</button>

            <hr style="border-top: 1px dashed #555; margin: 30px 0;">

            <h2>Data Transfer</h2>
            <h3>Give Data</h3>
            <p>The full POS data string is generated and can be copied using the button below. It is hidden for display purposes.</p>
            <div id="dataStringDisplay"></div>
            <button onclick="copyDataCode()">Copy Data String</button>


            <h3>Receive Data</h3>
            <p>Paste the data string from another device here to load its data. This will overwrite existing data.</p>
            <input type="text" id="receiveDataCode" placeholder="Paste data string here">
            <button onclick="receiveData()">Load Data</button>
        </div>
    </div>

    <div id="returnsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeReturnsModal()">&times;</button>
            <h2>Process Returns</h2>
            <label for="returnTransactionId">Scan QR or Enter Transaction ID Here:</label>
            <input type="text" id="returnTransactionId" class="hidden-input-for-scan" placeholder="Enter Transaction ID" onkeyup="if(event.keyCode === 13) loadReturnItems()">
            <div style="padding: 10px; border: 1px dashed #555; text-align: center; margin-bottom: 15px;">
                Ready to scan receipt QR code or enter Transaction ID...
            </div>
            <button onclick="loadReturnItems()">Load Items for Return</button>

            <div id="return-items-section">
                <h3>Items from Transaction: <span id="return-trans-id-display"></span></h3>
                <table id="return-items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Original Qty</th>
                            <th>Qty to Return</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                <button onclick="processReturn()">Process Selected Returns</button>
                <button class="red" onclick="clearReturnForm()">Clear Return Form</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="cancelPayment()">&times;</button>
            <h2>Select Payment Method</h2>

            <div id="paymentMethodSelection">
                <p>Total Due: $<span id="overallTotalDue">0.00</span></p>
                <button onclick="showCashPayment()">Cash</button>
                <button onclick="showCardPayment()">Card</button>
                <button class="red" onclick="cancelPayment()">Cancel</button>
            </div>

            <div id="cashPaymentSection" style="display: none;">
                <h3>Cash Payment</h3>
                <p>Total Due: $<span id="cashTotalDue">0.00</span></p>
                <label for="amountGiven">Amount Given:</label>
                <input type="number" id="amountGiven" step="0.01" min="0" value="0.00">
                <p>Change Due: $<span id="changeDue">0.00</span></p>
                <button onclick="calculateChange()">Tender</button>
                <button class="red" onclick="backToPaymentSelection()">Back</button>
            </div>

            <div id="cardPaymentSection" style="display: none;">
                <h3>Card Payment</h3>
                <p>Total Due: $<span id="cardTotalDue">0.00</span></p>
                <label for="creditCardNumber">Enter Credit Card Number:</label>
                <input type="text" id="creditCardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
                <button onclick="processCardPayment()">Process</button>
                <button class="red" onclick="backToPaymentSelection()">Back</button>
            </div>
        </div>
    </div>

    <div id="produceWeightModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="cancelProduceWeightEntry()">&times;</button>
            <h2>Enter Produce Weight</h2>
            <p>Item: <strong id="produceItemName"></strong></p>
            <p>Price per Ounce: $<span id="produceItemPricePerOz"></span></p>
            <label for="produceWeight">Weight (ounces):</label>
            <input type="number" id="produceWeight" step="0.01" min="0.01" value="0.00">
            <button onclick="addProduceToCart()">Add to Cart</button>
            <button class="red" onclick="cancelProduceWeightEntry()">Cancel</button>
        </div>
    </div>

    <div id="receipt" class="receipt-container">
        <div class="receipt-header">
            <img id="receipt-logo" src="#" alt="Store Logo" style="display: none;">
            <h3 id="receipt-store-name">Your Store Name</h3>
            <p id="receipt-address">123 Main Street, Anytown, USA</p>
            <p id="receipt-phone">Tel: (123) 456-7890</p>
            <p>Date: <span id="receipt-date"></span></p>
            <p>Time: <span id="receipt-time"></span></p>
            <p>Trans ID: <span id="receipt-transaction-id"></span></p>
            <p id="receipt-member-info"></p> <div class="receipt-separator"></div>
        </div>
        <div class="receipt-body">
            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px;">
                <span style="width: 40%;">ITEM</span><span style="width: 25%; text-align: center;">QTY</span><span style="width: 15%; text-align: right;">PRICE</span><span style="width: 20%; text-align: right;">TOTAL</span>
            </div>
            <div class="receipt-items">
            </div>
            <div class="receipt-separator"></div>
            <div class="receipt-total">
                <p>SUBTOTAL: $<span id="receipt-subtotal"></span></p>
                <p>NON-MEMBERSHIP FEE: $<span id="receipt-membership-fee"></span></p>
                <p>TAX: $<span id="receipt-tax"></span></p>
                <p>TOTAL: $<span id="receipt-final-total"></span></p>
                <div class="receipt-separator"></div>
                <p>PAYMENT METHOD: <span id="receipt-payment-method"></span></p>
            </div>
        </div>
        <div class="receipt-footer">
            <div class="receipt-separator"></div>
            <p>THANK YOU FOR YOUR PURCHASE!</p>
            <p>Please come again!</p>
            <div id="qrcode-container"></div> </div>
    </div>

    <script>
        let items = {}; // Stores items by barcode: {barcode: {name, price, stock, isProduce}}
        let cart = {}; // Stores items in cart: {barcode: {name, price, qty, isProduce, originalPricePerOz (for produce)}}
        let salesHistory = [];
        let members = {}; // Stores members by barcode: {barcode: {name}}
        let transactionIdCounter = 1000; // Simple counter for transaction IDs
        let currentReturnTransaction = null; // Store the sale object for the current return process
        let receiptLogo = null; // Stores the Base64 string of the logo
        let generatedDataString = ""; // Store the generated data string for copying/QR

        // Global variables for store settings
        let storeName = "Your Store Name";
        let storeAddress = "123 Main Street, Anytown, USA";
        let storePhone = "(123) 456-7890";
        let salesTaxPercentage = 7.25; // Stored as percentage (e.g., 7.25 for 7.25%)
        let nonMemberFee = 0.20; // Default non-member fee
        let receiptWidth = 80; // Default receipt width in mm

        // Global variable for editing item
        let editingBarcode = null;
        // Global variable for editing member
        let editingMemberBarcode = null;

        // Global variables for the current transaction totals
        let currentTransactionSubtotal = 0;
        let currentTransactionMembershipFee = 0; // NEW: Membership Fee
        let currentTransactionTaxAmount = 0;
        let currentTransactionFinalTotal = 0;
        let currentTransactionMember = null; // Store the member object for the current transaction

        // Global variable for produce checkout
        let currentProduceBarcode = null;

        // --- Local Storage Functions ---
        function saveData() {
            localStorage.setItem('posItems', JSON.stringify(items));
            localStorage.setItem('posCart', JSON.stringify(cart));
            localStorage.setItem('posSalesHistory', JSON.stringify(salesHistory));
            localStorage.setItem('posMembers', JSON.stringify(members)); // Save members
            localStorage.setItem('posTransactionIdCounter', transactionIdCounter);
            if (receiptLogo) {
                localStorage.setItem('posReceiptLogo', receiptLogo);
            } else {
                localStorage.removeItem('posReceiptLogo');
            }
            // Save store settings
            localStorage.setItem('posStoreName', storeName);
            localStorage.setItem('posStoreAddress', storeAddress);
            localStorage.setItem('posStorePhone', storePhone);
            localStorage.setItem('posSalesTaxPercentage', salesTaxPercentage);
            localStorage.setItem('posNonMemberFee', nonMemberFee); // Save non-member fee
            localStorage.setItem('posReceiptWidth', receiptWidth); // Save receipt width
        }

        function loadData() {
            const storedItems = localStorage.getItem('posItems');
            const storedCart = localStorage.getItem('posCart');
            const storedSalesHistory = localStorage.getItem('posSalesHistory');
            const storedMembers = localStorage.getItem('posMembers'); // Load members
            const storedTransactionIdCounter = localStorage.getItem('posTransactionIdCounter');
            const storedReceiptLogo = localStorage.getItem('posReceiptLogo');

            if (storedItems) {
                items = JSON.parse(storedItems);
            } else {
                addDummyData(); // Add dummy data only if no existing items are found
            }

            if (storedCart) {
                cart = JSON.parse(storedCart);
            }

            if (storedSalesHistory) {
                salesHistory = JSON.parse(storedSalesHistory);
            }

            if (storedMembers) { // Load members
                members = JSON.parse(storedMembers);
            } else {
                addDummyMembers(); // Add dummy members if none exist
            }

            if (storedTransactionIdCounter && !isNaN(parseInt(storedTransactionIdCounter))) {
                transactionIdCounter = parseInt(storedTransactionIdCounter);
            }

            if (storedReceiptLogo) {
                receiptLogo = storedReceiptLogo;
                // Logo preview is rendered in renderSettings or generateReceipt
            }

            // Load store settings
            const storedStoreName = localStorage.getItem('posStoreName');
            const storedStoreAddress = localStorage.getItem('posStoreAddress');
            const storedStorePhone = localStorage.getItem('posStorePhone');
            const storedSalesTaxPercentage = localStorage.getItem('posSalesTaxPercentage');
            const storedNonMemberFee = localStorage.getItem('posNonMemberFee'); // Load non-member fee
            const storedReceiptWidth = localStorage.getItem('posReceiptWidth'); // Load receipt width

            if (storedStoreName) {
                storeName = storedStoreName;
            }
            if (storedStoreAddress) {
                storeAddress = storedStoreAddress;
            }
            if (storedStorePhone) {
                storePhone = storedStorePhone;
            }
            if (storedSalesTaxPercentage && !isNaN(parseFloat(storedSalesTaxPercentage))) {
                salesTaxPercentage = parseFloat(storedSalesTaxPercentage);
            }
            if (storedNonMemberFee && !isNaN(parseFloat(storedNonMemberFee))) { // Load non-member fee
                nonMemberFee = parseFloat(storedNonMemberFee);
            }
            if (storedReceiptWidth && !isNaN(parseInt(storedReceiptWidth))) { // Load receipt width
                receiptWidth = parseInt(storedReceiptWidth);
            }
        }
        // --- End Local Storage Functions ---

        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // Load data from local storage first
            renderItems();
            updateCartDisplay();
            renderMembers(); // Render members on load
            renderSalesHistory();
            // Open the default tab on load
            openTab(null, 'ItemManagement'); // Simulate click on default tab
        });

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;

            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            if (evt) { // Only add active class if it's an actual click event
                evt.currentTarget.className += " active";
            } else { // For initial load
                document.querySelector(`.tab-button[onclick*="'${tabName}'"]`).className += " active";
            }

            // Auto-focus hidden input for relevant tabs
            if (tabName === 'Checkout') {
                // Clear any previous member status
                currentTransactionMember = null;
                document.getElementById('memberStatus').textContent = 'Ready for member scan.';
                document.getElementById('memberBarcode').value = ''; // Clear member barcode input
                setTimeout(() => {
                    document.getElementById('memberBarcode').focus(); // Focus member barcode first
                }, 100);
            } else if (tabName === 'Settings') { // Call renderSettings when opening Settings tab
                renderSettings();
            } else if (tabName === 'Members') { // Call renderMembers when opening Members tab
                renderMembers();
            }

            // Clear item form state when switching tabs away from ItemManagement
            if (tabName !== 'ItemManagement') {
                clearItemFormAndState();
            }
            // Clear member form state when switching tabs away from Members
            if (tabName !== 'Members') {
                clearMemberFormAndState();
            }
        }

        function addDummyData() {
            // Only add dummy data if 'items' is empty (i.e., no data loaded from local storage)
            if (Object.keys(items).length === 0) {
                items['123456789012'] = { name: 'Apple', price: 1.50, stock: 50, isProduce: false };
                items['987654321098'] = { name: 'Banana', price: 0.75, stock: 100, isProduce: false };
                items['112233445566'] = { name: 'Milk (1L)', price: 3.00, stock: 30, isProduce: false };
                items['223344556677'] = { name: 'Bread', price: 2.20, stock: 40, isProduce: false };
                items['PROD001'] = { name: 'Avocado', price: 0.50, stock: -1, isProduce: true }; // -1 for unlimited stock
                items['PROD002'] = { name: 'Organic Spinach', price: 0.25, stock: -1, isProduce: true };
                saveData(); // Save dummy data to local storage
            }
        }

        function addDummyMembers() {
            // Only add dummy members if 'members' is empty
            if (Object.keys(members).length === 0) {
                members['MEMBER001'] = { name: 'Alice Smith' };
                members['MEMBER002'] = { name: 'Bob Johnson' };
                saveData(); // Save dummy data
            }
        }

        function togglePriceLabel() {
            const itemPriceLabel = document.getElementById('itemPriceLabel');
            const itemPriceInput = document.getElementById('itemPrice');
            const itemStockLabel = document.querySelector('label[for="itemStock"]');
            const itemStockInput = document.getElementById('itemStock');
            const itemStockNote = itemStockInput.nextElementSibling; // The <p> tag after stock input

            const isProduce = document.querySelector('input[name="itemType"]:checked').value === 'produce';

            if (isProduce) {
                itemPriceLabel.textContent = 'Price per Ounce:';
                if (parseFloat(itemPriceInput.value) <= 0.01) { // Set a reasonable default for produce
                    itemPriceInput.value = '0.01';
                }
                itemStockLabel.style.display = 'none';
                itemStockInput.style.display = 'none';
                itemStockNote.style.display = 'block';
                itemStockInput.value = '-1'; // Convention for unlimited stock
            } else {
                itemPriceLabel.textContent = 'Price:';
                if (parseFloat(itemPriceInput.value) === 0.01) { // Reset if it was produce default
                    itemPriceInput.value = '0.00';
                }
                itemStockLabel.style.display = 'block';
                itemStockInput.style.display = 'block';
                itemStockNote.style.display = 'none';
                if (parseInt(itemStockInput.value) === -1) { // Reset if it was produce default
                    itemStockInput.value = '1';
                }
            }
        }


        function addItem() { // This function now handles both add and update
            const name = document.getElementById('itemName').value.trim();
            const barcode = document.getElementById('itemBarcode').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value);
            const stock = parseInt(document.getElementById('itemStock').value);
            const isProduce = document.querySelector('input[name="itemType"]:checked').value === 'produce';

            if (!name || !barcode || isNaN(price) || price <= 0) {
                alert('Please fill in all item details correctly. Price must be greater than 0.');
                return;
            }

            if (!isProduce && (isNaN(stock) || stock < 0)) {
                 alert('For normal items, stock must be 0 or greater.');
                 return;
            }

            const itemStock = isProduce ? -1 : stock; // Produce stock is always -1 (unlimited)

            if (editingBarcode) {
                // Update existing item
                if (editingBarcode !== barcode) { // Barcode should be readOnly, so this is a safeguard
                    alert("Error: Cannot change barcode while editing. Please cancel and re-edit if barcode needs to change.");
                    return;
                }
                items[barcode] = { name, price, stock: itemStock, isProduce };
                alert(`Item "${name}" (Barcode: ${barcode}) updated.`);
            } else {
                // Add new item
                if (items[barcode]) {
                    alert(`Item with barcode ${barcode} already exists (${items[barcode].name}). Use the "Edit" button to modify.`);
                    return;
                }
                items[barcode] = { name, price, stock: itemStock, isProduce };
                alert(`Item "${name}" (Barcode: ${barcode}) added.`);
            }

            renderItems();
            clearItemFormAndState(); // Reset form and state after add/update
            saveData(); // Save changes
        }

        function editItem(barcode) {
            const item = items[barcode];
            if (!item) {
                alert('Item not found for editing.');
                return;
            }

            document.getElementById('itemName').value = item.name;
            document.getElementById('itemBarcode').value = barcode;
            document.getElementById('itemBarcode').readOnly = true; // Make barcode read-only during edit
            document.getElementById('itemPrice').value = item.price.toFixed(2);
            document.getElementById('itemStock').value = item.stock;

            // Set radio button and update price label/stock display
            document.querySelector(`input[name="itemType"][value="${item.isProduce ? 'produce' : 'normal'}"]`).checked = true;
            togglePriceLabel();


            editingBarcode = barcode; // Set the editing flag

            // Change button text and visibility
            document.getElementById('addItemButton').textContent = 'Save Changes';
            document.getElementById('cancelEditButton').style.display = 'inline-block';
        }

        function clearItemFormAndState() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemBarcode').value = '';
            document.getElementById('itemBarcode').readOnly = false; // Make barcode editable again
            document.getElementById('itemPrice').value = '0.00';
            document.getElementById('itemStock').value = '1';

            // Reset radio button to normal and update labels/stock display
            document.querySelector('input[name="itemType"][value="normal"]').checked = true;
            togglePriceLabel();

            editingBarcode = null; // Clear the editing flag

            // Reset button text and visibility
            document.getElementById('addItemButton').textContent = 'Add Item';
            document.getElementById('cancelEditButton').style.display = 'none';
        }

        function renderItems() {
            const itemListBody = document.querySelector('#item-list tbody');
            itemListBody.innerHTML = '';
            for (const barcode in items) {
                const item = items[barcode];
                const row = itemListBody.insertRow();
                row.insertCell().textContent = barcode;
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.isProduce ? 'Produce' : 'Normal'; // New column for type
                row.insertCell().textContent = item.isProduce ? `$${item.price.toFixed(2)} / Oz` : `$${item.price.toFixed(2)}`; // Price display
                row.insertCell().textContent = item.isProduce ? 'N/A' : item.stock; // Stock display
                const actionsCell = row.insertCell();

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => editItem(barcode);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'red';
                deleteButton.onclick = () => deleteItem(barcode);
                actionsCell.appendChild(deleteButton);
            }
        }

        function deleteItem(barcode) {
            if (confirm(`Are you sure you want to delete item with barcode: ${barcode}?`)) {
                delete items[barcode];
                renderItems();
                clearItemFormAndState(); // Ensure form is reset if deleted item was being edited
                saveData(); // Save changes
            }
        }

        function checkMemberBarcode() {
            const memberBarcodeInput = document.getElementById('memberBarcode');
            const barcode = memberBarcodeInput.value.trim();
            memberBarcodeInput.value = ''; // Clear immediately after reading

            if (barcode === '0' || barcode === '') {
                // If 0 or empty, skip member lookup and proceed with non-member logic
                currentTransactionMember = null;
                document.getElementById('memberStatus').textContent = 'No member scanned (Non-membership fee applies).';
                document.getElementById('checkoutBarcode').focus(); // Move focus to item barcode
                return;
            }

            const member = members[barcode];
            if (member) {
                currentTransactionMember = { barcode: barcode, name: member.name };
                document.getElementById('memberStatus').textContent = `Member: ${member.name}`;
                document.getElementById('checkoutBarcode').focus(); // Move focus to item barcode
            } else {
                currentTransactionMember = null;
                document.getElementById('memberStatus').textContent = 'Invalid member barcode. No membership applied.';
                alert('Invalid member barcode. Please scan a valid member or enter 0 to proceed without membership.');
                memberBarcodeInput.focus(); // Re-focus member barcode
            }
        }


        function addToCart() {
            const barcodeInput = document.getElementById('checkoutBarcode');
            const barcode = barcodeInput.value.trim();
            barcodeInput.value = ''; // Clear immediately after reading

            if (!barcode) {
                // If the input is empty but focus is active, wait for scan
                barcodeInput.focus(); // Ensure it remains focused
                return;
            }

            const item = items[barcode];
            if (!item) {
                alert('Item not found.');
                barcodeInput.focus(); // Re-focus
                return;
            }

            if (item.isProduce) {
                // If it's a produce item, open the weight modal
                currentProduceBarcode = barcode; // Store for modal
                document.getElementById('produceItemName').textContent = item.name;
                document.getElementById('produceItemPricePerOz').textContent = item.price.toFixed(2);
                document.getElementById('produceWeight').value = '0.00'; // Reset weight input
                document.getElementById('produceWeightModal').style.display = 'flex';
                setTimeout(() => document.getElementById('produceWeight').focus(), 100);
            } else {
                // Normal item logic
                if (item.stock <= 0) {
                    alert(`${item.name} is out of stock.`);
                    barcodeInput.focus(); // Re-focus
                    return;
                }

                if (cart[barcode]) {
                    if (item.stock > 0) { // Can still add if there's stock
                        cart[barcode].qty++;
                    } else {
                         alert(`Cannot add more ${item.name}. Maximum stock reached.`);
                         barcodeInput.focus(); // Re-focus
                         return;
                    }
                } else {
                    cart[barcode] = {
                        name: item.name,
                        price: item.price,
                        qty: 1,
                        isProduce: false // Explicitly mark as not produce
                    };
                }
                item.stock--; // Decrement stock when added to cart
                renderItems(); // Update stock display
                updateCartDisplay();
                saveData(); // Save changes
                barcodeInput.focus(); // Re-focus for next scan
            }
        }

        function addProduceToCart() {
            const barcode = currentProduceBarcode;
            const item = items[barcode];
            const weight = parseFloat(document.getElementById('produceWeight').value);

            if (isNaN(weight) || weight <= 0) {
                alert('Please enter a valid weight in ounces (must be greater than 0).');
                document.getElementById('produceWeight').focus();
                return;
            }

            const calculatedPrice = item.price * weight; // Price per ounce * weight

            // For produce, we add it as a new line item in the cart each time it's weighed
            // This is because each 'addition' might have a different weight/price.
            // We'll use a unique identifier for each produce entry in the cart, e.g., barcode + timestamp
            const uniqueProduceId = barcode + '-' + Date.now();
            cart[uniqueProduceId] = {
                name: `${item.name} (${weight.toFixed(2)} oz)`, // Display name with weight
                price: calculatedPrice, // Store the calculated total price for this instance
                qty: 1, // Quantity is always 1 for a weighed item
                isProduce: true, // Mark as produce
                originalBarcode: barcode, // Keep original barcode for reference
                originalPricePerOz: item.price, // Store original price per ounce for potential returns
                weight: weight // Store weight for receipt detail
            };

            updateCartDisplay();
            saveData();
            cancelProduceWeightEntry(); // Close modal
            document.getElementById('checkoutBarcode').focus(); // Re-focus for next scan
        }

        function cancelProduceWeightEntry() {
            document.getElementById('produceWeightModal').style.display = 'none';
            currentProduceBarcode = null;
            document.getElementById('checkoutBarcode').focus(); // Re-focus for next scan
        }

        function updateCartDisplay() {
            const cartItemsBody = document.querySelector('#cart-items tbody');
            cartItemsBody.innerHTML = '';
            let total = 0; // This will be the subtotal for display

            for (const key in cart) { // key can be barcode or uniqueProduceId
                const item = cart[key];
                const subtotal = item.price * item.qty; // For produce, price is already calculated total
                total += subtotal;

                const row = cartItemsBody.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = `$${item.price.toFixed(2)}`; // Display actual price per unit or calculated produce price
                row.insertCell().textContent = item.isProduce ? `1` : item.qty; // Qty is 1 for produce
                row.insertCell().textContent = `$${subtotal.toFixed(2)}`;

                const actionsCell = row.insertCell();
                if (!item.isProduce) { // Only allow quantity adjustments for normal items
                    const removeOneButton = document.createElement('button');
                    removeOneButton.textContent = '-';
                    removeOneButton.onclick = () => updateCartItemQuantity(key, -1);
                    actionsCell.appendChild(removeOneButton);

                    const addOneButton = document.createElement('button');
                    addOneButton.textContent = '+';
                    addOneButton.onclick = () => updateCartItemQuantity(key, 1);
                    actionsCell.appendChild(addOneButton);
                }

                const removeButton = document.createElement('button');
                removeButton.textContent = 'X';
                removeButton.className = 'red';
                removeButton.onclick = () => removeFromCart(key);
                actionsCell.appendChild(removeButton);
            }
            // Display only subtotal in the cart, tax will be calculated at checkout
            document.getElementById('cart-total').textContent = `Subtotal: $${total.toFixed(2)}`;
        }

        function updateCartItemQuantity(barcode, change) {
            const barcodeInput = document.getElementById('checkoutBarcode');
            const itemInCart = cart[barcode]; // This barcode will be the actual item barcode for normal items

            if (!itemInCart || itemInCart.isProduce) { // Prevent quantity adjustment for produce items
                barcodeInput.focus();
                return;
            }

            const itemInStore = items[barcode]; // This is the actual item from the inventory
            if (!itemInStore) {
                barcodeInput.focus(); // Re-focus
                return;
            }

            if (change === 1) { // Adding quantity
                if (itemInStore.stock > 0) {
                    itemInCart.qty++;
                    itemInStore.stock--;
                } else {
                    alert(`Cannot add more ${itemInStore.name}. Maximum stock reached.`);
                }
            } else if (change === -1) { // Removing quantity
                if (itemInCart.qty > 1) {
                    itemInCart.qty--;
                    itemInStore.stock++;
                } else {
                    // If quantity becomes 0, remove from cart
                    removeFromCart(barcode);
                    barcodeInput.focus(); // Re-focus
                    return; // Exit to prevent further processing
                }
            }
            renderItems(); // Update stock display
            updateCartDisplay();
            saveData(); // Save changes
            barcodeInput.focus(); // Re-focus for next scan
        }

        function removeFromCart(key) { // Key can be actual barcode or uniqueProduceId
            const barcodeInput = document.getElementById('checkoutBarcode');
            const itemInCart = cart[key];

            if (itemInCart) {
                // Only return stock for normal items
                if (!itemInCart.isProduce && items[key]) { // For normal items, key is barcode
                    items[key].stock += itemInCart.qty; // Return stock to inventory
                }
                delete cart[key];
                renderItems(); // Update stock display
                updateCartDisplay();
                saveData(); // Save changes
            }
            barcodeInput.focus(); // Re-focus for next scan
        }

        function clearCart() {
            if (confirm('Are you sure you want to clear the entire cart?')) {
                for (const key in cart) {
                    const itemInCart = cart[key];
                    // Only return stock for normal items
                    if (!itemInCart.isProduce && items[key]) { // For normal items, key is barcode
                        items[key].stock += itemInCart.qty; // Return stock
                    }
                }
                cart = {};
                currentTransactionMember = null; // Clear member too
                document.getElementById('memberStatus').textContent = 'Ready for member scan.'; // Reset status
                document.getElementById('memberBarcode').value = ''; // Clear member barcode input
                renderItems(); // Update stock display
                updateCartDisplay();
                saveData(); // Save changes
            }
            document.getElementById('memberBarcode').focus(); // Re-focus for next scan (member)
        }

        // Initial checkout function to prompt for payment method
        function checkout() {
            if (Object.keys(cart).length === 0) {
                alert('Cart is empty. Please add items before checking out.');
                return;
            }

            // Calculate current transaction totals upfront
            let subtotal = 0;
            for (const key in cart) {
                subtotal += cart[key].price * cart[key].qty;
            }
            currentTransactionSubtotal = subtotal;

            // Determine membership fee
            currentTransactionMembershipFee = currentTransactionMember ? 0.00 : nonMemberFee;

            const actualSalesTaxRate = salesTaxPercentage / 100;
            // Tax is applied to subtotal + membership fee
            currentTransactionTaxAmount = (currentTransactionSubtotal + currentTransactionMembershipFee) * actualSalesTaxRate;
            currentTransactionFinalTotal = currentTransactionSubtotal + currentTransactionMembershipFee + currentTransactionTaxAmount;

            openPaymentModal();
        }

        // Function to finalize checkout, called by payment handlers
        function completeCheckoutProcess(paymentMethod) { // paymentMethod could be 'Cash' or 'Card'
            const subtotal = currentTransactionSubtotal;
            const membershipFee = currentTransactionMembershipFee;
            const taxAmount = currentTransactionTaxAmount;
            const finalTotal = currentTransactionFinalTotal;

            const now = new Date();
            const transactionId = `TRN-${transactionIdCounter++}`;

            const sale = {
                id: transactionId,
                timestamp: now.toLocaleString(),
                items: JSON.parse(JSON.stringify(cart)), // Deep copy cart items
                subtotal: subtotal,
                membershipFee: membershipFee, // Store membership fee
                tax: taxAmount,
                total: finalTotal,
                method: paymentMethod, // Store payment method
                member: currentTransactionMember ? JSON.parse(JSON.stringify(currentTransactionMember)) : null // Store member data
            };
            salesHistory.push(sale);
            renderSalesHistory();
            generateReceipt(sale);
            cart = {}; // Clear cart after checkout
            currentTransactionMember = null; // Clear member after checkout
            document.getElementById('memberStatus').textContent = 'Ready for member scan.'; // Reset status
            document.getElementById('memberBarcode').value = ''; // Clear member barcode input
            updateCartDisplay();
            saveData();
            alert('Checkout successful!');
            document.getElementById('memberBarcode').focus(); // Focus member barcode for next transaction
            closePaymentModal(); // Close the payment modal
            // Reset current transaction totals
            currentTransactionSubtotal = 0;
            currentTransactionMembershipFee = 0;
            currentTransactionTaxAmount = 0;
            currentTransactionFinalTotal = 0;
        }

        function renderSalesHistory() {
            const salesHistoryBody = document.querySelector('#sales-history tbody');
            salesHistoryBody.innerHTML = '';
            salesHistory.forEach(sale => {
                const row = salesHistoryBody.insertRow();
                row.insertCell().textContent = sale.timestamp;
                row.insertCell().textContent = sale.id;
                // Display member name, or 'N/A'
                row.insertCell().textContent = sale.member ? sale.member.name : 'N/A';
                // Display final total from sale history
                row.insertCell().textContent = `$${sale.total.toFixed(2)}`;
                const itemsCell = row.insertCell();
                let itemDetails = [];
                for (const barcode in sale.items) {
                    const item = sale.items[barcode];
                    // Display produce items with their weight
                    if (item.isProduce) {
                        itemDetails.push(`${item.name}`); // Name already contains weight
                    } else {
                        itemDetails.push(`${item.name} (x${item.qty})`);
                    }
                }
                itemsCell.textContent = itemDetails.join(', ');
            });
        }

        // --- Member Management Functions ---
        function addMember() {
            const name = document.getElementById('memberName').value.trim();
            const barcode = document.getElementById('memberAddBarcode').value.trim();

            if (!name || !barcode) {
                alert('Please fill in both member name and barcode.');
                return;
            }

            if (editingMemberBarcode) {
                // Update existing member
                if (editingMemberBarcode !== barcode) {
                    alert("Error: Cannot change member barcode while editing. Please cancel and re-edit if barcode needs to change.");
                    return;
                }
                members[barcode] = { name: name };
                alert(`Member "${name}" (Barcode: ${barcode}) updated.`);
            } else {
                // Add new member
                if (members[barcode]) {
                    alert(`Member with barcode ${barcode} already exists (${members[barcode].name}). Use the "Edit" button to modify.`);
                    return;
                }
                members[barcode] = { name: name };
                alert(`Member "${name}" (Barcode: ${barcode}) added.`);
            }

            renderMembers();
            clearMemberFormAndState();
            saveData();
        }

        function editMember(barcode) {
            const member = members[barcode];
            if (!member) {
                alert('Member not found for editing.');
                return;
            }

            document.getElementById('memberName').value = member.name;
            document.getElementById('memberAddBarcode').value = barcode;
            document.getElementById('memberAddBarcode').readOnly = true;

            editingMemberBarcode = barcode;

            document.getElementById('addMemberButton').textContent = 'Save Changes';
            document.getElementById('cancelEditMemberButton').style.display = 'inline-block';
        }

        function deleteMember(barcode) {
            if (confirm(`Are you sure you want to delete member with barcode: ${barcode}?`)) {
                delete members[barcode];
                renderMembers();
                clearMemberFormAndState();
                saveData();
            }
        }

        function renderMembers() {
            const memberListBody = document.querySelector('#member-list tbody');
            memberListBody.innerHTML = '';
            for (const barcode in members) {
                const member = members[barcode];
                const row = memberListBody.insertRow();
                row.insertCell().textContent = barcode;
                row.insertCell().textContent = member.name;
                const actionsCell = row.insertCell();

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => editMember(barcode);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'red';
                deleteButton.onclick = () => deleteMember(barcode);
                actionsCell.appendChild(deleteButton);
            }
        }

        function clearMemberFormAndState() {
            document.getElementById('memberName').value = '';
            document.getElementById('memberAddBarcode').value = '';
            document.getElementById('memberAddBarcode').readOnly = false;

            editingMemberBarcode = null;

            document.getElementById('addMemberButton').textContent = 'Add Member';
            document.getElementById('cancelEditMemberButton').style.display = 'none';
        }

        // --- Settings Tab Functions ---
        function saveStoreSettings() {
            const newStoreName = document.getElementById('settingStoreName').value.trim();
            const newStoreAddress = document.getElementById('settingStoreAddress').value.trim();
            const newStorePhone = document.getElementById('settingStorePhone').value.trim();
            const newTaxPercentage = parseFloat(document.getElementById('settingTaxPercentage').value);
            const newNonMemberFee = parseFloat(document.getElementById('settingMembershipFee').value); // New fee setting
            const newReceiptWidth = parseInt(document.getElementById('settingReceiptWidth').value); // New receipt width setting

            if (!newStoreName || !newStoreAddress || !newStorePhone) {
                alert('Please fill in all store information fields.');
                return;
            }
            if (isNaN(newTaxPercentage) || newTaxPercentage < 0 || newTaxPercentage > 100) {
                alert('Please enter a valid sales tax percentage between 0 and 100.');
                return;
            }
            if (isNaN(newNonMemberFee) || newNonMemberFee < 0) { // Validate non-member fee
                alert('Please enter a valid non-member fee (0 or greater).');
                return;
            }
            if (isNaN(newReceiptWidth) || newReceiptWidth < 50 || newReceiptWidth > 120) { // Validate receipt width
                alert('Please enter a valid receipt width between 50mm and 120mm.');
                return;
            }

            storeName = newStoreName;
            storeAddress = newStoreAddress;
            storePhone = newStorePhone;
            salesTaxPercentage = newTaxPercentage;
            nonMemberFee = newNonMemberFee; // Save new non-member fee
            receiptWidth = newReceiptWidth; // Save new receipt width

            saveData();
            alert('Store settings saved successfully!');
            // Update the data string display after settings change
            generateDataStringForDisplay();
        }

        function renderSettings() {
            document.getElementById('settingStoreName').value = storeName;
            document.getElementById('settingStoreAddress').value = storeAddress;
            document.getElementById('settingStorePhone').value = storePhone;
            document.getElementById('settingTaxPercentage').value = salesTaxPercentage.toFixed(2);
            document.getElementById('settingMembershipFee').value = nonMemberFee.toFixed(2); // Render non-member fee
            document.getElementById('settingReceiptWidth').value = receiptWidth; // Render receipt width

            // Re-render the logo preview in case it was just loaded
            if (receiptLogo) {
                document.getElementById('logo-preview').src = receiptLogo;
                document.getElementById('logo-preview').style.display = 'block';
            } else {
                document.getElementById('logo-preview').style.display = 'none';
                document.getElementById('logo-preview').src = '#';
            }
            // Clear receive data field when settings tab is opened/rendered
            document.getElementById('receiveDataCode').value = '';

            // Generate and display the data string immediately when settings are rendered
            generateDataStringForDisplay();
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    alert('Please upload an image file (PNG, JPG, JPEG, GIF).');
                    event.target.value = ''; // Clear the file input
                    document.getElementById('logo-preview').style.display = 'none';
                    document.getElementById('logo-preview').src = '#';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('logo-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('logo-preview').style.display = 'none';
                document.getElementById('logo-preview').src = '#';
            }
        }

        function saveLogo() {
            const preview = document.getElementById('logo-preview');
            // Check if preview.src is a data URL (starts with data:image)
            if (preview.src && preview.src.startsWith('data:image/')) {
                receiptLogo = preview.src;
                saveData();
                alert('Logo saved successfully!');
                // Update the data string display after logo changes
                generateDataStringForDisplay();
            } else {
                alert('No valid logo image selected to save.');
            }
        }

        function clearLogo() {
            if (confirm('Are you sure you want to clear the receipt logo?')) {
                receiptLogo = null;
                document.getElementById('logoUpload').value = ''; // Clear file input
                document.getElementById('logo-preview').style.display = 'none';
                document.getElementById('logo-preview').src = '#';
                saveData();
                alert('Logo cleared.');
                // Update the data string display after logo changes
                generateDataStringForDisplay();
            }
        }

        // --- Returns Modal Functions ---

        function openReturnsModal() {
            document.getElementById('returnsModal').style.display = 'flex'; // Show modal
            setTimeout(() => { // Timeout to ensure the element is visible/focusable
                const returnTransactionIdInput = document.getElementById('returnTransactionId');
                if (returnTransactionIdInput) {
                    returnTransactionIdInput.focus();
                }
            }, 100);
            document.getElementById('return-items-section').style.display = 'block'; // Ensure section is visible inside modal
            document.getElementById('return-trans-id-display').textContent = '';
            document.querySelector('#return-items-table tbody').innerHTML = '';
            document.getElementById('returnTransactionId').value = ''; // Clear previous input
            currentReturnTransaction = null;
        }

        function closeReturnsModal() {
            document.getElementById('returnsModal').style.display = 'none'; // Hide modal
            document.getElementById('memberBarcode').focus(); // Re-focus member barcode input
        }

        function searchSaleByTransactionId(transactionId) {
            return salesHistory.find(sale => sale.id === transactionId);
        }

        function loadReturnItems() {
            const barcodeInput = document.getElementById('returnTransactionId');
            const transactionId = barcodeInput.value.trim();
            barcodeInput.value = ''; // Clear immediately after reading

            if (!transactionId) {
                // If the input is empty but focus is active, wait for scan
                barcodeInput.focus(); // Ensure it remains focused
                return;
            }

            const saleToReturn = searchSaleByTransactionId(transactionId);

            if (!saleToReturn) {
                alert(`No sale found for Transaction ID: ${transactionId}`);
                document.getElementById('return-trans-id-display').textContent = 'N/A';
                document.querySelector('#return-items-table tbody').innerHTML = '';
                currentReturnTransaction = null;
                barcodeInput.focus(); // Re-focus
                return;
            }

            // 30-day return policy check (or current year after June 14, 2025)
            const purchaseDate = new Date(saleToReturn.timestamp); // Convert timestamp string to Date object
            const currentDate = new Date();

            // Normalize dates to start of day for accurate day difference (important for boundary cases)
            purchaseDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);

            const diffTime = Math.abs(currentDate.getTime() - purchaseDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Calculate difference in days

            // Get current year
            const currentYear = currentDate.getFullYear();
            // Get purchase year
            const purchaseYear = purchaseDate.getFullYear();

            // Condition for "current calendar year after June 14, 2025"
            // This date refers to 2025-06-14 as the cutoff.
            // If current date is *after* this cutoff, then if the purchase year is not the current year, it's invalid.
            const june14_2025 = new Date('2025-06-14T00:00:00'); // Specific date for policy change

            if (currentDate >= june14_2025 && purchaseYear < currentYear) {
                alert(`This transaction (${transactionId}) is from a previous year. Returns are only allowed within the current calendar year after June 14, 2025.`);
                document.getElementById('return-trans-id-display').textContent = 'N/A';
                document.querySelector('#return-items-table tbody').innerHTML = '';
                currentReturnTransaction = null;
                barcodeInput.focus(); // Re-focus
                return;
            }

            // Original 30-day policy (still applies if not in the new year-based restriction)
            if (diffDays > 30) {
                alert(`This transaction (${transactionId}) is outside the 30-day return window.`);
                document.getElementById('return-trans-id-display').textContent = 'N/A';
                document.querySelector('#return-items-table tbody').innerHTML = '';
                currentReturnTransaction = null;
                barcodeInput.focus(); // Re-focus
                return;
            }

            currentReturnTransaction = saleToReturn;
            document.getElementById('return-trans-id-display').textContent = transactionId;

            const returnItemsTableBody = document.querySelector('#return-items-table tbody');
            returnItemsTableBody.innerHTML = '';

            for (const key in saleToReturn.items) { // Key can be barcode or uniqueProduceId
                const item = saleToReturn.items[key];
                const row = returnItemsTableBody.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.qty; // Original quantity (1 for produce)

                const qtyReturnCell = row.insertCell();
                const qtyReturnInput = document.createElement('input');
                qtyReturnInput.type = 'number';
                qtyReturnInput.min = '0';
                qtyReturnInput.max = item.qty; // Cannot return more than purchased
                qtyReturnInput.value = '0'; // Default to 0 for selection
                qtyReturnInput.dataset.barcode = key; // Store key for later retrieval (can be original barcode or unique produce ID)
                qtyReturnInput.dataset.isProduce = item.isProduce; // Store item type
                qtyReturnCell.appendChild(qtyReturnInput);
            }
            barcodeInput.focus(); // Re-focus for next scan
        }

        function processReturn() {
            if (!currentReturnTransaction) {
                alert('No transaction loaded for return.');
                document.getElementById('returnTransactionId').focus(); // Re-focus
                return;
            }

            const returnItemsTableBody = document.querySelector('#return-items-table tbody');
            const returnInputs = returnItemsTableBody.querySelectorAll('input[type="number"]');
            let itemsToProcess = [];
            let totalReturnAmount = 0;
            let isValid = true;

            returnInputs.forEach(input => {
                const key = input.dataset.barcode; // This is the key from the sale.items
                const isProduce = input.dataset.isProduce === 'true';
                const qtyToReturn = parseInt(input.value);

                if (qtyToReturn < 0) {
                    alert('Quantity to return cannot be negative.');
                    isValid = false;
                    return; // Exit forEach
                }

                if (qtyToReturn > 0) {
                    const originalItem = currentReturnTransaction.items[key]; // This gets the item data AT TIME OF PURCHASE
                    if (originalItem && qtyToReturn <= originalItem.qty) {
                        // For produce items, originalItem.price is already the total calculated price for that specific instance.
                        // So, the 'price' to use for return calculation is originalItem.price / originalItem.qty (which is 1 for produce)
                        // For normal items, originalItem.price is the unit price.
                        const unitPriceForReturn = isProduce ? originalItem.price / originalItem.qty : originalItem.price;

                        itemsToProcess.push({
                            barcode: originalItem.originalBarcode || key, // Use originalBarcode for produce, key for normal
                            name: originalItem.name,
                            qty: qtyToReturn,
                            price: unitPriceForReturn, // Use unit price for return
                            isProduce: isProduce,
                            weight: isProduce ? originalItem.weight : null // Include weight for produce returns
                        });
                        totalReturnAmount += (unitPriceForReturn * qtyToReturn);
                    } else if (originalItem) {
                        alert(`Cannot return ${qtyToReturn} of ${originalItem.name}. Only ${originalItem.qty} were purchased in this transaction.`);
                        isValid = false;
                        return; // Exit forEach
                    }
                }
            });

            if (!isValid) {
                document.getElementById('returnTransactionId').focus(); // Re-focus
                return;
            }

            if (itemsToProcess.length === 0) {
                alert('No items selected for return or invalid quantities entered.');
                document.getElementById('returnTransactionId').focus(); // Re-focus
                return;
            }

            if (confirm(`Confirm return of items totalling $${totalReturnAmount.toFixed(2)}?`)) {
                itemsToProcess.forEach(returnItem => {
                    // Update main inventory stock ONLY for normal items
                    if (!returnItem.isProduce && items[returnItem.barcode]) {
                        items[returnItem.barcode].stock += returnItem.qty;
                    } else if (returnItem.isProduce) {
                        console.log(`Returned produce item ${returnItem.name} (barcode: ${returnItem.barcode}). Stock is not tracked for produce.`);
                    } else {
                        console.warn(`Returned item ${returnItem.name} (barcode: ${returnItem.barcode}) not found in current inventory. Stock not updated.`);
                    }
                });

                renderItems(); // Update stock display
                saveData(); // Save changes to inventory

                alert(`Return processed successfully for Transaction ID ${currentReturnTransaction.id}. Total refund/credit: $${totalReturnAmount.toFixed(2)}.`);
                clearReturnForm();
            }
            document.getElementById('returnTransactionId').focus(); // Re-focus
        }

        function clearReturnForm() {
            document.getElementById('returnTransactionId').value = '';
            document.querySelector('#return-items-table tbody').innerHTML = '';
            document.getElementById('return-trans-id-display').textContent = '';
            currentReturnTransaction = null;
            document.getElementById('returnTransactionId').focus(); // Re-focus
        }

        // Payment Modal Functions

        function openPaymentModal() {
            document.getElementById('paymentModal').style.display = 'flex';
            document.getElementById('paymentMethodSelection').style.display = 'block';
            document.getElementById('cashPaymentSection').style.display = 'none';
            document.getElementById('cardPaymentSection').style.display = 'none';
            // Set total due for all sections
            document.getElementById('overallTotalDue').textContent = currentTransactionFinalTotal.toFixed(2);
            document.getElementById('cashTotalDue').textContent = currentTransactionFinalTotal.toFixed(2);
            document.getElementById('cardTotalDue').textContent = currentTransactionFinalTotal.toFixed(2);
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('amountGiven').value = '0.00'; // Reset cash input
            document.getElementById('changeDue').textContent = '0.00'; // Reset change display
            document.getElementById('creditCardNumber').value = ''; // Reset card input
        }

        function cancelPayment() {
            closePaymentModal();
            document.getElementById('memberBarcode').focus(); // Re-focus member barcode input
        }

        function backToPaymentSelection() {
            document.getElementById('paymentMethodSelection').style.display = 'block';
            document.getElementById('cashPaymentSection').style.display = 'none';
            document.getElementById('cardPaymentSection').style.display = 'none';
            // Reset inputs when going back
            document.getElementById('amountGiven').value = '0.00';
            document.getElementById('changeDue').textContent = '0.00';
            document.getElementById('creditCardNumber').value = '';
            document.getElementById('overallTotalDue').textContent = currentTransactionFinalTotal.toFixed(2); // Re-set the overall total display
        }

        function showCashPayment() {
            document.getElementById('paymentMethodSelection').style.display = 'none';
            document.getElementById('cashPaymentSection').style.display = 'block';
            document.getElementById('amountGiven').value = currentTransactionFinalTotal.toFixed(2); // Pre-fill with exact amount
            document.getElementById('changeDue').textContent = '0.00';
            setTimeout(() => document.getElementById('amountGiven').focus(), 100);
        }

        function calculateChange() {
            const amountGiven = parseFloat(document.getElementById('amountGiven').value);
            if (isNaN(amountGiven) || amountGiven < currentTransactionFinalTotal) {
                alert('Amount given must be a valid number and at least the total due.');
                document.getElementById('amountGiven').focus();
                return;
            }
            const change = amountGiven - currentTransactionFinalTotal;
            document.getElementById('changeDue').textContent = change.toFixed(2);
            alert(`Change Due: $${change.toFixed(2)}`);
            completeCheckoutProcess('Cash');
        }

        function showCardPayment() {
            document.getElementById('paymentMethodSelection').style.display = 'none';
            document.getElementById('cardPaymentSection').style.display = 'block';
            document.getElementById('creditCardNumber').value = ''; // Clear previous input
            setTimeout(() => document.getElementById('creditCardNumber').focus(), 100);
        }

        function processCardPayment() {
            const cardNumber = document.getElementById('creditCardNumber').value.trim();
            // Basic validation - just check if something is entered, no actual processing
            if (!cardNumber) {
                alert('Please enter a credit card number.');
                document.getElementById('creditCardNumber').focus();
                return;
            }
            alert('Processing card... Transaction complete!');
            completeCheckoutProcess('Card');
        }

        // --- Receipt Generation with QR Code and Logo ---
        function generateReceipt(sale) {
            const receiptDiv = document.getElementById('receipt');
            // Set the receipt width based on the setting
            receiptDiv.style.width = `${receiptWidth}mm`;

            const receiptLogoImg = document.getElementById('receipt-logo');
            const receiptDate = document.getElementById('receipt-date');
            const receiptTime = document.getElementById('receipt-time');
            const receiptTransactionId = document.getElementById('receipt-transaction-id');
            const receiptMemberInfo = document.getElementById('receipt-member-info'); // Use the new unified element
            const receiptItemsDiv = document.querySelector('.receipt-items');
            const receiptSubtotalSpan = document.getElementById('receipt-subtotal');
            const receiptMembershipFeeSpan = document.getElementById('receipt-membership-fee');
            const receiptTaxSpan = document.getElementById('receipt-tax');
            const receiptFinalTotalSpan = document.getElementById('receipt-final-total');
            const receiptPaymentMethodSpan = document.getElementById('receipt-payment-method');
            const qrcodeContainer = document.getElementById('qrcode-container');

            receiptItemsDiv.innerHTML = ''; // Clear previous items
            qrcodeContainer.innerHTML = ''; // Clear previous QR code

            // Display Logo if available
            if (receiptLogo) {
                receiptLogoImg.src = receiptLogo;
                receiptLogoImg.style.display = 'block';
            } else {
                receiptLogoImg.style.display = 'none';
                receiptLogoImg.src = '#';
            }

            // Use dynamic store info
            document.getElementById('receipt-store-name').textContent = storeName;
            document.getElementById('receipt-address').textContent = storeAddress;
            document.getElementById('receipt-phone').textContent = `Tel: ${storePhone}`;

            const now = new Date();
            receiptDate.textContent = now.toLocaleDateString();
            receiptTime.textContent = now.toLocaleTimeString();
            receiptTransactionId.textContent = sale.id;

            // Set member info based on whether a member was scanned
            if (sale.member) {
                receiptMemberInfo.innerHTML = `Thanks for being a ${storeName} member, ${sale.member.name}!`;
            } else {
                receiptMemberInfo.textContent = 'Non-Membership Fee'; // Changed to "Non-Membership Fee"
            }


            for (const key in sale.items) { // Key can be barcode or uniqueProduceId
                const item = sale.items[key];
                const itemTotal = item.price * item.qty; // For produce, item.price is already the total calculated price

                let itemNameDisplay = item.name;
                let itemPriceDisplay = `$${item.price.toFixed(2)}`;
                let itemQtyDisplay = item.qty;

                // Adjust display for produce items on receipt
                if (item.isProduce) {
                    // For produce, price in sale.items is the final calculated price
                    // We need originalPricePerOz and weight to reconstruct the line
                    itemNameDisplay = `${item.name.split(' (')[0]}`; // Remove "(X oz)" from name
                    itemPriceDisplay = `$${item.originalPricePerOz.toFixed(2)}/oz`;
                    itemQtyDisplay = `${item.weight.toFixed(2)} oz`;
                    // The total is still itemTotal as calculated
                }

                const itemLine = document.createElement('div');
                itemLine.innerHTML = `
                    <span style="width: 40%;"> ${itemNameDisplay}</span>
                    <span style="width: 25%; text-align: center;">${itemQtyDisplay}</span>
                    <span style="width: 15%; text-align: right;">${itemPriceDisplay}</span>
                    <span style="width: 20%; text-align: right;">$${itemTotal.toFixed(2)}</span>
                `;
                receiptItemsDiv.appendChild(itemLine);
            }

            // Use the actual subtotal, tax, and total from the sale object for consistency
            receiptSubtotalSpan.textContent = sale.subtotal.toFixed(2);
            receiptMembershipFeeSpan.textContent = sale.membershipFee.toFixed(2);
            receiptTaxSpan.textContent = sale.tax.toFixed(2);
            receiptFinalTotalSpan.textContent = sale.total.toFixed(2);
            receiptPaymentMethodSpan.textContent = sale.method;

            // Generate QR code with the transaction ID for the *receipt*
            // This QR code is small and only contains the transaction ID, which is fine.
            new QRCode(qrcodeContainer, {
                text: sale.id, // Embed only the transaction ID
                width: 80,
                height: 80,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            receiptDiv.style.display = 'block'; // Make receipt visible
            window.print(); // Open print dialog
            receiptDiv.style.display = 'none'; // Hide receipt after printing attempt
        }

        // Data Transfer Functions
        function generateDataStringForDisplay() {
            const allPosData = {
                items: items,
                salesHistory: salesHistory,
                members: members, // Include members in data transfer
                transactionIdCounter: transactionIdCounter,
                receiptLogo: receiptLogo,
                storeName: storeName,
                storeAddress: storeAddress,
                storePhone: storePhone,
                salesTaxPercentage: salesTaxPercentage,
                nonMemberFee: nonMemberFee, // Include non-member fee
                receiptWidth: receiptWidth // Include receipt width
            };
            try {
                const jsonData = JSON.stringify(allPosData);
                generatedDataString = btoa(jsonData); // Base64 encode
                // The display div is intentionally hidden using CSS
                document.getElementById('dataStringDisplay').textContent = generatedDataString;
            } catch (error) {
                console.error("Error generating data string:", error);
                document.getElementById('dataStringDisplay').textContent = 'Error generating data string. Data might be too large or invalid.';
                generatedDataString = ""; // Clear string on error
            }
        }

        function copyDataCode() {
            if (generatedDataString) {
                try {
                    // Create a temporary textarea to hold the text and copy it
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = generatedDataString;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    tempTextArea.setSelectionRange(0, 99999); // For mobile devices
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    alert('Data string copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy data string. Your browser might not support automatic copying. Please manually select the text from the display area and copy it.');
                }
            } else {
                alert('No data string generated yet. Please open the Settings tab to generate the data string.');
            }
        }

        function receiveData() {
            const receivedCode = document.getElementById('receiveDataCode').value.trim();
            if (!receivedCode) {
                alert('Please paste the data string into the input field.');
                return;
            }

            if (!confirm('WARNING: Loading data will OVERWRITE all existing POS data on this device. Are you sure you want to proceed?')) {
                return;
            }

            try {
                const decodedData = atob(receivedCode); // Base64 decode
                const parsedData = JSON.parse(decodedData);

                // Basic validation: Check if the parsed data has the expected structure
                if (typeof parsedData !== 'object' || parsedData === null ||
                    !parsedData.hasOwnProperty('items') ||
                    !parsedData.hasOwnProperty('salesHistory') ||
                    !parsedData.hasOwnProperty('members') || // Check for members
                    !parsedData.hasOwnProperty('transactionIdCounter') ||
                    !parsedData.hasOwnProperty('storeName'))
                {
                    throw new Error('Invalid data structure in the received code.');
                }

                // Update all global variables with the received data
                items = parsedData.items || {};
                salesHistory = parsedData.salesHistory || [];
                members = parsedData.members || {}; // Update members
                transactionIdCounter = parsedData.transactionIdCounter || 1000;
                receiptLogo = parsedData.receiptLogo || null;
                storeName = parsedData.storeName || "Your Store Name";
                storeAddress = parsedData.storeAddress || "123 Main Street, Anytown, USA";
                storePhone = parsedData.storePhone || "(123) 456-7890";
                salesTaxPercentage = parsedData.salesTaxPercentage || 7.25;
                nonMemberFee = parsedData.nonMemberFee || 0.20; // Update non-member fee
                receiptWidth = parsedData.receiptWidth || 80; // Update receipt width

                saveData(); // Persist the new data to local storage
                alert('Data loaded successfully! The system will now refresh to reflect the changes.');

                // Re-render UI elements to show the new data
                renderItems();
                updateCartDisplay(); // In case cart data was overwritten
                renderMembers(); // Re-render members list
                renderSalesHistory();
                renderSettings(); // Update settings display with new store info/logo

            } catch (error) {
                console.error("Error receiving data:", error);
                alert(`Failed to load data. Please ensure the code is correct and not corrupted. Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
