<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail POS System</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f4f4f4;
            padding: 20px;
            box-sizing: border-box;
        }

        #pos-container {
            display: flex;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            max-width: 1200px;
        }

        #item-input-section {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #eee;
            min-width: 300px;
        }

        #checkout-section {
            flex: 2;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        h2, h3 {
            color: #333;
            margin-top: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        #item-list {
            border: 1px solid #eee;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }

        #item-list div {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px dashed #eee;
        }

        #item-list div:last-child {
            border-bottom: none;
        }

        .item-row span {
            flex: 1;
            padding: 0 5px;
        }
        .item-row .item-name { flex: 3; }
        .item-row .item-qty, .item-row .item-price { flex: 1.5; text-align: right; }
        .item-row .item-total { flex: 2; text-align: right; }
        .item-row button {
            background-color: #dc3545;
            padding: 3px 8px;
            font-size: 0.8em;
        }
        .item-row button:hover { background-color: #c82333; }

        .summary-line {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-top: 1px dashed #eee;
        }
        .summary-line.total {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
            border-top: 2px solid #333;
            padding-top: 10px;
        }
        .summary-line.discount {
            color: #28a745;
            font-weight: bold;
        }

        #payment-options button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        #payment-options button.selected {
            background-color: #28a745;
        }

        #member-info-section, #discount-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Receipt Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #receipt, #receipt * {
                visibility: visible;
            }
            #receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm; /* Standard receipt width */
                font-family: 'Consolas', 'Courier New', monospace;
                font-size: 0.9em;
                color: #000;
                padding: 10mm;
                box-sizing: border-box;
            }
            #receipt h2, #receipt p {
                margin: 0;
                padding: 0;
            }
            #receipt .receipt-header,
            #receipt .receipt-footer {
                text-align: center;
                margin-bottom: 10px;
            }
            #receipt-logo {
                max-width: 100%;
                height: auto;
                margin-bottom: 10px;
            }
            #receipt .receipt-items div,
            #receipt .summary-line {
                display: flex;
                justify-content: space-between;
                width: 100%;
            }
            #receipt .receipt-items div span {
                word-break: break-all;
            }
            #receipt .receipt-items {
                border-top: 1px dashed #000;
                border-bottom: 1px dashed #000;
                padding: 5px 0;
                margin-bottom: 10px;
            }
            #receipt .summary-line.total {
                border-top: 2px solid #000;
                font-weight: bold;
                margin-top: 5px;
                padding-top: 5px;
            }
            #receipt-barcode-container, #recommended-discounts-list {
                text-align: center;
                margin-top: 15px;
            }
            #receipt-barcode-container svg, #recommended-discounts-list svg {
                max-width: 100%;
                height: auto;
            }
            #receipt-barcode-container p {
                font-size: 0.8em;
                margin-top: 5px;
            }
            #receipt-recommendations {
                margin-top: 20px;
                border-top: 1px dashed #000;
                padding-top: 10px;
            }
            .receipt-recommendation-item {
                border: 1px solid #ddd;
                padding: 5px;
                margin-bottom: 8px;
                text-align: center;
            }
            .receipt-recommendation-item p {
                margin: 2px 0;
            }
            #receipt-barcode-svg, .receipt-recommendation-item svg {
                display: block; /* Ensure SVG takes full width if needed */
                margin: 0 auto; /* Center barcodes */
            }
        }
    </style>
</head>
<body>
    <div id="pos-container">
        <div id="item-input-section">
            <h2>Add Item</h2>
            <label for="itemId">Item ID:</label>
            <input type="text" id="itemId" placeholder="Enter item ID (e.g., I001)">

            <label for="itemQty">Quantity:</label>
            <input type="number" id="itemQty" value="1" min="1">

            <label for="itemWeight" style="display: none;">Weight (oz):</label>
            <input type="number" id="itemWeight" step="0.01" min="0.01" placeholder="Enter weight in oz" style="display: none;">

            <button onclick="addItem()">Add Item</button>

            <div id="member-info-section">
                <h3>Member Lookup</h3>
                <label for="memberId">Member ID:</label>
                <input type="text" id="memberId" placeholder="Enter member ID (e.g., M001)">
                <button onclick="applyMember()">Apply Member</button>
                <p id="currentMember">No member applied.</p>
            </div>

            <div id="discount-section">
                <h3>Apply Discount</h3>
                <label for="discountCode">Discount Code:</label>
                <input type="text" id="discountCode" placeholder="Enter discount code (e.g., D001)">
                <button onclick="applyDiscount()">Apply Discount</button>
                <p id="currentDiscount">No discount applied.</p>
            </div>
        </div>

        <div id="checkout-section">
            <h2>Current Sale</h2>
            <div id="item-list">
                <div class="item-row" style="font-weight: bold; border-bottom: 2px solid #ccc;">
                    <span class="item-name">Item</span>
                    <span class="item-qty" style="text-align: center;">Qty/Weight</span>
                    <span class="item-price">Unit Price</span>
                    <span class="item-total">Total</span>
                    <span></span> </div>
                </div>

            <div class="summary-line">
                <span>Subtotal:</span>
                <span id="subtotal">$0.00</span>
            </div>
            <div class="summary-line" id="membershipFeeLine" style="display:none;">
                <span>Membership Fee:</span>
                <span id="membershipFee">$0.00</span>
            </div>
            <div class="summary-line discount" id="discountAppliedLine" style="display:none;">
                <span>Discount Applied:</span>
                <span id="discountAmountSaved">-$0.00</span>
            </div>
            <div class="summary-line">
                <span>Tax (<span id="taxRate">0</span>%):</span>
                <span id="tax">$0.00</span>
            </div>
            <div class="summary-line total">
                <span>Total:</span>
                <span id="finalTotal">$0.00</span>
            </div>

            <div style="margin-top: 20px;">
                <h3>Payment Method</h3>
                <div id="payment-options">
                    <button id="cashBtn" onclick="selectPaymentMethod('Cash')">Cash</button>
                    <button id="cardBtn" onclick="selectPaymentMethod('Card')">Card</button>
                    <button id="mobileBtn" onclick="selectPaymentMethod('Mobile Payment')">Mobile Payment</button>
                </div>
                <p id="selectedPaymentMethod">Selected: None</p>
                <button onclick="completeSale()" style="width: 100%; margin-top: 15px;">Complete Sale</button>
            </div>
        </div>
    </div>

    <div id="receipt" style="display:none;">
        <div class="receipt-header">
            <img id="receipt-logo" src="" alt="Store Logo" style="display: none;">
            <p id="receipt-store-name"></p>
            <p id="receipt-address"></p>
            <p id="receipt-phone"></p>
            <p>----------------------------------</p>
            <p>Date: <span id="receipt-date"></span> Time: <span id="receipt-time"></span></p>
            <p>Transaction ID: <span id="receipt-transaction-id"></span></p>
            <p id="receipt-member-info"></p>
            <p>----------------------------------</p>
        </div>

        <div class="receipt-items">
            <div style="font-weight: bold;">
                <span style="width: 40%;">Item</span>
                <span style="width: 25%; text-align: center;">Qty/Weight</span>
                <span style="width: 15%; text-align: right;">Unit Price</span>
                <span style="width: 20%; text-align: right;">Total</span>
            </div>
            </div>

        <div class="summary-line">
            <span>Subtotal:</span>
            <span>$<span id="receipt-subtotal"></span></span>
        </div>
        <div class="summary-line" id="receipt-membership-fee-line">
            <span>Membership Fee:</span>
            <span>$<span id="receipt-membership-fee"></span></span>
        </div>
        <div class="summary-line discount" id="receipt-discount-applied" style="display: none;">
            <span>Discount: <span id="applied-discount-title"></span></span>
            <span>-$<span id="applied-discount-amount"></span></span>
            <p style="font-size:0.8em; width: 100%; text-align: left; margin-top: 2px;">
                <span id="applied-discount-desc"></span> (Valid Thru: <span id="applied-discount-valid-thru"></span>)
            </p>
        </div>
        <div class="summary-line">
            <span>Tax:</span>
            <span>$<span id="receipt-tax"></span></span>
        </div>
        <div class="summary-line total">
            <span>Total:</span>
            <span>$<span id="receipt-final-total"></span></span>
        </div>
        <div class="summary-line" style="margin-top: 10px;">
            <span>Payment Method:</span>
            <span><span id="receipt-payment-method"></span></span>
        </div>

        <div class="receipt-footer">
            <p style="margin-top: 20px;">Thank you for your business!</p>
            <div id="receipt-barcode-container">
                </div>

            <div id="receipt-recommendations" style="display: none;">
                <p style="margin-top: 20px; font-weight: bold;">--- RECOMMENDED DISCOUNTS ---</p>
                <div id="recommended-discounts-list">
                    </div>
                <p style="font-size: 0.8em; margin-top: 10px;">Present these codes for future savings.</p>
            </div>
        </div>
    </div>


    <script>
        // --- Configuration ---
        const salesTaxRate = 0.075; // 7.5%
        const membershipFee = 10.00; // Flat fee for non-members
        const receiptWidth = 80; // in mm
        const receiptLogo = 'https://via.placeholder.com/150x50?text=YOUR+LOGO'; // Optional: URL to your store logo
        const storeName = "My Awesome Store";
        const storeAddress = "123 Main St, Anytown, USA";
        const storePhone = "(555) 123-4567";

        // --- Data Mock-ups ---
        const products = {
            'I001': { name: 'Apples (Granny Smith)', price: 1.50, isProduce: false },
            'I002': { name: 'Milk (1 Gallon)', price: 3.00, isProduce: false },
            'I003': { name: 'Bread (Whole Wheat)', price: 2.25, isProduce: false },
            'I004': { name: 'Chicken Breast (per lb)', price: 5.99, isProduce: false },
            'I005': { name: 'Bananas (Produce - per oz)', price: 0.20, isProduce: true, originalPricePerOz: 0.20 },
            'I006': { name: 'Organic Spinach (Produce - per oz)', price: 0.35, isProduce: true, originalPricePerOz: 0.35 },
            'I007': { name: 'Ground Beef (per lb)', price: 4.50, isProduce: false },
            'I008': { name: 'Cheddar Cheese (8 oz)', price: 3.99, isProduce: false },
            'I009': { name: 'Oranges (Produce - per oz)', price: 0.15, isProduce: true, originalPricePerOz: 0.15 },
            'I010': { name: 'Coffee Beans (12 oz)', price: 8.75, isProduce: false },
        };

        const members = {
            'M001': { id: 'M001', name: 'Alice Smith' },
            'M002': { id: 'M002', name: 'Bob Johnson' },
            'M003': { id: 'M003', name: 'Charlie Brown' },
        };

        const discounts = {
            'D001': { id: 'D001', title: '10% Off Entire Purchase', type: 'percentage', value: 0.10, minPurchase: 50, validThru: '2025-12-31', description: 'Save 10% on purchases over $50!' },
            'D002': { id: 'D002', title: '$5 Off Next Purchase', type: 'amount', value: 5.00, minPurchase: 20, validThru: '2025-11-15', description: 'Get $5 off when you spend $20.' },
            'D003': { id: 'D003', title: 'Buy One Get One Free Milk', type: 'bogo', targetItemId: 'I002', validThru: '2025-10-01', description: 'Buy one Milk, get one free!' },
            'D004': { id: 'D004', title: 'Expired Discount', type: 'percentage', value: 0.05, minPurchase: 10, validThru: '2024-01-01', description: 'This discount has expired.' },
            'D005': { id: 'D005', title: '$2 Off Produce', type: 'item_category_amount', value: 2.00, category: 'isProduce', minPurchase: 10, validThru: '2026-03-20', description: 'Get $2 off your fresh produce purchase over $10.' },
            'D006': { id: 'D006', title: 'Free Coffee with $30+', type: 'free_item', targetItemId: 'I010', minPurchase: 30, validThru: '2025-09-30', description: 'Receive a free Coffee Beans when your total exceeds $30.' },
            'D007': { id: 'D007', title: 'New Member Special', type: 'percentage', value: 0.15, minPurchase: 0, validThru: '2026-06-30', description: '15% off for new members! (can be applied to any first purchase)' },
        };

        // --- Current Sale State ---
        let currentSale = {
            id: generateTransactionId(),
            items: {},
            member: null,
            discount: null,
            subtotal: 0,
            membershipFee: 0,
            tax: 0,
            total: 0,
            method: null,
        };

        // --- DOM Elements ---
        const itemIdInput = document.getElementById('itemId');
        const itemQtyInput = document.getElementById('itemQty');
        const itemWeightInput = document.getElementById('itemWeight');
        const itemWeightLabel = document.querySelector('label[for="itemWeight"]');
        const itemListDiv = document.getElementById('item-list');
        const subtotalSpan = document.getElementById('subtotal');
        const membershipFeeSpan = document.getElementById('membershipFee');
        const membershipFeeLine = document.getElementById('membershipFeeLine');
        const taxSpan = document.getElementById('tax');
        const taxRateSpan = document.getElementById('taxRate');
        const finalTotalSpan = document.getElementById('finalTotal');
        const currentMemberP = document.getElementById('currentMember');
        const currentDiscountP = document.getElementById('currentDiscount');
        const discountAppliedLine = document.getElementById('discountAppliedLine');
        const discountAmountSavedSpan = document.getElementById('discountAmountSaved');
        const selectedPaymentMethodP = document.getElementById('selectedPaymentMethod');
        const paymentButtons = document.querySelectorAll('#payment-options button');

        // --- Utility Functions ---

        function generateTransactionId() {
            return 'TRN' + Date.now().toString().slice(-8) + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        }

        function formatCurrency(amount) {
            return `$${amount.toFixed(2)}`;
        }

        function isDiscountValid(discount) {
            const now = new Date();
            const validThruDate = new Date(discount.validThru);
            return now <= validThruDate;
        }

        function calculateSubtotal() {
            let tempSubtotal = 0;
            for (const key in currentSale.items) {
                tempSubtotal += currentSale.items[key].price * currentSale.items[key].qty;
            }
            return tempSubtotal;
        }

        function calculateTotals() {
            currentSale.subtotal = calculateSubtotal();

            // Reset membership fee if member is applied, otherwise apply it
            currentSale.membershipFee = currentSale.member ? 0 : membershipFee;
            membershipFeeLine.style.display = currentSale.member ? 'none' : 'flex';

            let discountReduction = 0;
            if (currentSale.discount && isDiscountValid(currentSale.discount)) {
                discountAppliedLine.style.display = 'flex';
                let potentialDiscountAmount = 0;

                switch (currentSale.discount.type) {
                    case 'percentage':
                        if (currentSale.subtotal >= currentSale.discount.minPurchase) {
                            potentialDiscountAmount = currentSale.subtotal * currentSale.discount.value;
                        }
                        break;
                    case 'amount':
                        if (currentSale.subtotal >= currentSale.discount.minPurchase) {
                            potentialDiscountAmount = currentSale.discount.value;
                        }
                        break;
                    case 'bogo':
                        const targetItem = Object.values(currentSale.items).find(item => item.id === currentSale.discount.targetItemId);
                        if (targetItem && targetItem.qty >= 2) {
                            potentialDiscountAmount = Math.floor(targetItem.qty / 2) * targetItem.price;
                        }
                        break;
                    case 'item_category_amount':
                        let categorySubtotal = 0;
                        for (const key in currentSale.items) {
                            const item = currentSale.items[key];
                            if (item[currentSale.discount.category]) { // Check if item belongs to the category
                                categorySubtotal += item.price * item.qty;
                            }
                        }
                        if (categorySubtotal >= currentSale.discount.minPurchase) {
                            potentialDiscountAmount = currentSale.discount.value;
                        }
                        break;
                    case 'free_item':
                         const freeItemCheck = Object.values(currentSale.items).find(item => item.id === currentSale.discount.targetItemId);
                         if (freeItemCheck && currentSale.subtotal >= currentSale.discount.minPurchase) {
                             potentialDiscountAmount = freeItemCheck.price * freeItemCheck.qty; // Discount the price of the item
                             // For simplicity, we are reducing the total. In a real system, you might mark the item as 'free'
                         }
                         break;
                }
                discountReduction = Math.min(potentialDiscountAmount, currentSale.subtotal); // Ensure discount doesn't exceed subtotal
                currentSale.discount.amountSaved = discountReduction;
                discountAmountSavedSpan.textContent = discountReduction.toFixed(2);
            } else {
                discountAppliedLine.style.display = 'none';
                if (currentSale.discount) { // If a discount was applied but is no longer valid or applicable
                    currentDiscountP.textContent = `No discount applied. (Previously: ${currentSale.discount.title} - Invalid/Inapplicable)`;
                    currentSale.discount = null; // Clear the invalid discount
                } else {
                    currentDiscountP.textContent = 'No discount applied.';
                }
            }


            let taxableSubtotal = currentSale.subtotal - discountReduction;
            if (taxableSubtotal < 0) taxableSubtotal = 0; // Prevent negative taxable amount
            currentSale.tax = taxableSubtotal * salesTaxRate;
            currentSale.total = taxableSubtotal + currentSale.membershipFee + currentSale.tax;

            updateDisplay();
        }

        function updateDisplay() {
            itemListDiv.innerHTML = `
                <div class="item-row" style="font-weight: bold; border-bottom: 2px solid #ccc;">
                    <span class="item-name">Item</span>
                    <span class="item-qty" style="text-align: center;">Qty/Weight</span>
                    <span class="item-price">Unit Price</span>
                    <span class="item-total">Total</span>
                    <span></span>
                </div>
            `;
            for (const key in currentSale.items) {
                const item = currentSale.items[key];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-row';

                let itemNameDisplay = item.name;
                let itemPriceDisplay = formatCurrency(item.price);
                let itemQtyDisplay = item.qty;

                if (item.isProduce) {
                    itemNameDisplay = `${item.name.split(' (')[0]} (${item.weight.toFixed(2)} oz)`;
                    itemPriceDisplay = formatCurrency(item.originalPricePerOz) + '/oz';
                    itemQtyDisplay = ''; // Don't show qty for produce, weight is primary
                }

                itemDiv.innerHTML = `
                    <span class="item-name">${itemNameDisplay}</span>
                    <span class="item-qty">${itemQtyDisplay}</span>
                    <span class="item-price">${itemPriceDisplay}</span>
                    <span class="item-total">${formatCurrency(item.price * item.qty)}</span>
                    <button onclick="removeItem('${item.id}')">X</button>
                `;
                itemListDiv.appendChild(itemDiv);
            }

            subtotalSpan.textContent = formatCurrency(currentSale.subtotal);
            membershipFeeSpan.textContent = formatCurrency(currentSale.membershipFee);
            taxRateSpan.textContent = (salesTaxRate * 100).toFixed(1);
            taxSpan.textContent = formatCurrency(currentSale.tax);
            finalTotalSpan.textContent = formatCurrency(currentSale.total);

            // Hide/Show weight input based on selected item
            const selectedProduct = products[itemIdInput.value.toUpperCase()];
            if (selectedProduct && selectedProduct.isProduce) {
                itemWeightLabel.style.display = 'block';
                itemWeightInput.style.display = 'block';
                itemQtyInput.style.display = 'none'; // Hide quantity for produce
                itemQtyInput.value = 1; // Reset quantity to default
            } else {
                itemWeightLabel.style.display = 'none';
                itemWeightInput.style.display = 'none';
                itemQtyInput.style.display = 'block';
            }
        }

        // --- Item Management ---
        function addItem() {
            const id = itemIdInput.value.toUpperCase();
            let qty = parseInt(itemQtyInput.value);
            let weight = parseFloat(itemWeightInput.value);

            if (!id || !products[id]) {
                alert('Please enter a valid Item ID.');
                return;
            }

            const product = products[id];
            let itemToAdd = { ...product, id: id };

            if (product.isProduce) {
                if (isNaN(weight) || weight <= 0) {
                    alert('Please enter a valid weight for produce items.');
                    return;
                }
                itemToAdd.weight = weight;
                itemToAdd.qty = 1; // Quantity is 1 for produce, total price based on weight
                itemToAdd.price = product.originalPricePerOz * weight; // Calculate price based on weight
            } else {
                if (isNaN(qty) || qty <= 0) {
                    alert('Please enter a valid quantity.');
                    return;
                }
                itemToAdd.qty = qty;
            }

            if (currentSale.items[id]) {
                if (product.isProduce) {
                    // For produce, add weight to existing item
                    currentSale.items[id].weight += itemToAdd.weight;
                    currentSale.items[id].price = product.originalPricePerOz * currentSale.items[id].weight;
                } else {
                    currentSale.items[id].qty += itemToAdd.qty;
                }
            } else {
                currentSale.items[id] = itemToAdd;
            }

            itemIdInput.value = '';
            itemQtyInput.value = '1';
            itemWeightInput.value = '';
            calculateTotals();
        }

        function removeItem(id) {
            if (currentSale.items[id]) {
                delete currentSale.items[id];
                calculateTotals();
            }
        }

        // --- Member Management ---
        function applyMember() {
            const memberId = document.getElementById('memberId').value.toUpperCase();
            if (memberId && members[memberId]) {
                currentSale.member = members[memberId];
                currentMemberP.textContent = `Member: ${currentSale.member.name}`;
            } else if (memberId) {
                alert('Member not found.');
                currentSale.member = null;
                currentMemberP.textContent = 'No member applied.';
            } else {
                currentSale.member = null;
                currentMemberP.textContent = 'No member applied.';
            }
            calculateTotals(); // Recalculate to apply/remove membership fee
        }

        // --- Discount Management ---
        function applyDiscount() {
            const discountCode = document.getElementById('discountCode').value.toUpperCase();
            if (!discountCode || !discounts[discountCode]) {
                alert('Invalid discount code.');
                currentSale.discount = null;
                currentDiscountP.textContent = 'No discount applied.';
            } else {
                const discount = discounts[discountCode];
                if (isDiscountValid(discount)) {
                    currentSale.discount = { ...discount, amountSaved: 0 }; // Initialize amountSaved
                    currentDiscountP.textContent = `Discount: ${discount.title} (Code: ${discount.id})`;
                } else {
                    alert('Discount code has expired or is not yet valid.');
                    currentSale.discount = null;
                    currentDiscountP.textContent = 'No discount applied.';
                }
            }
            calculateTotals(); // Recalculate to apply discount effects
        }

        // --- Payment & Checkout ---
        function selectPaymentMethod(method) {
            currentSale.method = method;
            selectedPaymentMethodP.textContent = `Selected: ${method}`;
            paymentButtons.forEach(button => {
                button.classList.remove('selected');
            });
            document.getElementById(method.toLowerCase().replace(' ', '') + 'Btn').classList.add('selected');
        }

        function completeSale() {
            if (Object.keys(currentSale.items).length === 0) {
                alert('Please add items to the sale before completing.');
                return;
            }
            if (!currentSale.method) {
                alert('Please select a payment method.');
                return;
            }

            calculateTotals(); // Final calculation before generating receipt

            // Generate receipt
            generateReceipt(currentSale);

            // Reset sale for next customer
            currentSale = {
                id: generateTransactionId(),
                items: {},
                member: null,
                discount: null,
                subtotal: 0,
                membershipFee: 0,
                tax: 0,
                total: 0,
                method: null,
            };
            itemIdInput.value = '';
            itemQtyInput.value = '1';
            itemWeightInput.value = '';
            document.getElementById('memberId').value = '';
            document.getElementById('discountCode').value = '';
            currentMemberP.textContent = 'No member applied.';
            currentDiscountP.textContent = 'No discount applied.';
            selectedPaymentMethodP.textContent = 'Selected: None';
            paymentButtons.forEach(button => button.classList.remove('selected'));
            updateDisplay(); // Clear item list and update totals display
        }

        // --- Receipt Generation ---
        function generateReceipt(sale) {
            const receiptDiv = document.getElementById('receipt');
            receiptDiv.style.width = `${receiptWidth}mm`;

            const receiptLogoImg = document.getElementById('receipt-logo');
            const receiptDate = document.getElementById('receipt-date');
            const receiptTime = document.getElementById('receipt-time');
            const receiptTransactionId = document.getElementById('receipt-transaction-id');
            const receiptMemberInfo = document.getElementById('receipt-member-info');
            const receiptItemsDiv = document.querySelector('.receipt-items');
            const receiptDiscountSection = document.getElementById('receipt-discount-applied');
            const appliedDiscountTitleSpan = document.getElementById('applied-discount-title');
            const appliedDiscountDescSpan = document.getElementById('applied-discount-desc');
            const appliedDiscountValidThruSpan = document.getElementById('applied-discount-valid-thru');
            const appliedDiscountAmountSpan = document.getElementById('applied-discount-amount');
            const receiptSubtotalSpan = document.getElementById('receipt-subtotal');
            const receiptMembershipFeeSpan = document.getElementById('receipt-membership-fee');
            const receiptTaxSpan = document.getElementById('receipt-tax');
            const receiptFinalTotalSpan = document.getElementById('receipt-final-total');
            const receiptPaymentMethodSpan = document.getElementById('receipt-payment-method');
            const receiptBarcodeContainer = document.getElementById('receipt-barcode-container');
            const recommendedDiscountsSection = document.getElementById('receipt-recommendations');
            const recommendedDiscountsListDiv = document.getElementById('recommended-discounts-list');

            receiptItemsDiv.innerHTML = '';
            receiptBarcodeContainer.innerHTML = ''; // Clear previous transaction barcode
            recommendedDiscountsListDiv.innerHTML = ''; // Clear previous recommendations list

            if (receiptLogo) {
                receiptLogoImg.src = receiptLogo;
                receiptLogoImg.style.display = 'block';
            } else {
                receiptLogoImg.style.display = 'none';
                receiptLogoImg.src = '#';
            }

            document.getElementById('receipt-store-name').textContent = storeName;
            document.getElementById('receipt-address').textContent = storeAddress;
            document.getElementById('receipt-phone').textContent = `Tel: ${storePhone}`;

            const now = new Date();
            receiptDate.textContent = now.toLocaleDateString();
            receiptTime.textContent = now.toLocaleTimeString();
            receiptTransactionId.textContent = sale.id;

            if (sale.member) {
                receiptMemberInfo.innerHTML = `Thanks for being a ${storeName} member, ${sale.member.name}!`;
            } else {
                receiptMemberInfo.textContent = 'Non-Membership Fee';
            }

            for (const key in sale.items) {
                const item = sale.items[key];
                const itemTotal = item.price * item.qty;

                let itemNameDisplay = item.name;
                let itemPriceDisplay = `$${item.price.toFixed(2)}`;
                let itemQtyDisplay = item.qty;

                if (item.isProduce) {
                    itemNameDisplay = `${item.name.split(' (')[0]}`;
                    itemPriceDisplay = `$${item.originalPricePerOz.toFixed(2)}/oz`;
                    itemQtyDisplay = `${item.weight.toFixed(2)} oz`;
                }

                const itemLine = document.createElement('div');
                itemLine.innerHTML = `
                    <span style="width: 40%;"> ${itemNameDisplay}</span>
                    <span style="width: 25%; text-align: center;">${itemQtyDisplay}</span>
                    <span style="width: 15%; text-align: right;">${itemPriceDisplay}</span>
                    <span style="width: 20%; text-align: right;">$${itemTotal.toFixed(2)}</span>
                `;
                receiptItemsDiv.appendChild(itemLine);
            }

            // Display applied discount section
            if (sale.discount) {
                receiptDiscountSection.style.display = 'block';
                appliedDiscountTitleSpan.textContent = sale.discount.title;
                appliedDiscountDescSpan.textContent = sale.discount.description;
                appliedDiscountValidThruSpan.textContent = new Date(sale.discount.validThru).toLocaleDateString();
                appliedDiscountAmountSpan.textContent = sale.discount.amountSaved.toFixed(2);
            } else {
                receiptDiscountSection.style.display = 'none';
            }


            receiptSubtotalSpan.textContent = sale.subtotal.toFixed(2);
            receiptMembershipFeeSpan.textContent = sale.membershipFee.toFixed(2);
            receiptTaxSpan.textContent = sale.tax.toFixed(2);
            receiptFinalTotalSpan.textContent = sale.total.toFixed(2);
            receiptPaymentMethodSpan.textContent = sale.method;

            // Generate 1D barcode for transaction ID
            const transactionBarcodeSvg = document.createElement('svg');
            transactionBarcodeSvg.id = 'transaction-barcode-svg';
            receiptBarcodeContainer.appendChild(transactionBarcodeSvg);
            try {
                JsBarcode("#transaction-barcode-svg", sale.id, {
                    format: "CODE128",
                    displayValue: true,
                    width: 2,
                    height: 50,
                    margin: 0,
                    fontSize: 14
                });
            } catch (e) {
                console.error(`Error generating transaction barcode for ${sale.id}:`, e);
                receiptBarcodeContainer.textContent = `Trans ID: ${sale.id}`;
            }

            // Add recommended discounts
            // Filter only active (non-expired) and non-applied discounts for recommendations
            const activeDiscountIds = Object.keys(discounts).filter(id => {
                const discount = discounts[id];
                return isDiscountValid(discount) && (!sale.discount || sale.discount.id !== id);
            });

            if (activeDiscountIds.length > 0) {
                recommendedDiscountsSection.style.display = 'block';
                let numberOfRecommendations = 0;
                if (sale.member) {
                    numberOfRecommendations = Math.floor(Math.random() * (20 - 6 + 1)) + 6; // 6-20 for members
                } else {
                    numberOfRecommendations = Math.floor(Math.random() * (5 - 2 + 1)) + 2; // 2-5 for non-members
                }

                // Shuffle discounts and pick unique ones
                const shuffledDiscounts = [...activeDiscountIds].sort(() => 0.5 - Math.random());
                const selectedDiscountIds = shuffledDiscounts.slice(0, Math.min(numberOfRecommendations, activeDiscountIds.length));

                selectedDiscountIds.forEach(discountId => {
                    const discount = discounts[discountId];
                    const recItemDiv = document.createElement('div');
                    recItemDiv.className = 'receipt-recommendation-item';
                    recItemDiv.innerHTML = `
                        <p style="font-weight: bold;">${discount.title}</p>
                        <p>${discount.description}</p>
                        <p style="font-size:0.8em; margin-top:2px;">Valid Thru: ${new Date(discount.validThru).toLocaleDateString()}</p>
                        <svg id="rec-barcode-${discountId}"></svg>
                    `;
                    recommendedDiscountsListDiv.appendChild(recItemDiv);

                    // Generate 1D barcode for each recommended discount
                    try {
                        JsBarcode(`#rec-barcode-${discountId}`, discount.id, {
                            format: "CODE128",
                            displayValue: true,
                            width: 1,
                            height: 30,
                            margin: 0,
                            fontSize: 10
                        });
                    } catch (e) {
                        console.error(`Error generating recommendation barcode for ${discount.id}:`, e);
                        // Fallback text if barcode generation fails
                        const fallbackText = document.createElement('p');
                        fallbackText.textContent = `Code: ${discount.id}`;
                        recItemDiv.appendChild(fallbackText);
                        // Remove the empty SVG element if it caused issues
                        const svgElement = document.getElementById(`rec-barcode-${discountId}`);
                        if (svgElement) svgElement.remove();
                    }
                });
            } else {
                recommendedDiscountsSection.style.display = 'none';
            }


            receiptDiv.style.display = 'block';
            window.print();
            receiptDiv.style.display = 'none';
        }

        // Initialize display on load
        document.addEventListener('DOMContentLoaded', updateDisplay);

        // Auto-select Item ID input for quick entry
        itemIdInput.focus();

        // Add event listener for Enter key on Item ID input
        itemIdInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                addItem();
                itemIdInput.focus(); // Keep focus on item ID for continuous scanning
            }
        });

        // Event listener for Item ID input to toggle weight/qty
        itemIdInput.addEventListener('input', function() {
            const id = itemIdInput.value.toUpperCase();
            const product = products[id];
            if (product && product.isProduce) {
                itemWeightLabel.style.display = 'block';
                itemWeightInput.style.display = 'block';
                itemQtyInput.style.display = 'none';
                itemQtyInput.value = 1; // Reset qty
            } else {
                itemWeightLabel.style.display = 'none';
                itemWeightInput.style.display = 'none';
                itemQtyInput.style.display = 'block';
                itemWeightInput.value = ''; // Clear weight
            }
        });

        // Add event listener for Enter key on Item Qty/Weight input
        itemQtyInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addItem();
                itemIdInput.focus();
            }
        });

        itemWeightInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addItem();
                itemIdInput.focus();
            }
        });

        // Add event listener for Enter key on Member ID input
        document.getElementById('memberId').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                applyMember();
            }
        });

        // Add event listener for Enter key on Discount Code input
        document.getElementById('discountCode').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                applyDiscount();
            }
        });

    </script>
</body>
</html>
