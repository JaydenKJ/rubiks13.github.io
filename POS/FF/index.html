<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .menu-item-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .menu-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .quantity-btn {
            background-color: #d1d5db; /* Gray-300 */
            color: #1f2937; /* Gray-800 */
            border-radius: 9999px; /* Full rounded */
            width: 24px; /* w-6 */
            height: 24px; /* h-6 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .quantity-btn:hover {
            background-color: #9ca3af; /* Gray-400 */
        }
        .action-button {
            transition: background-color 0.2s, transform 0.1s;
        }
        .action-button:hover {
            transform: translateY(-1px);
        }
        .action-button:active {
            transform: translateY(0);
        }
        /* Custom Message Box Styles */
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            white-space: nowrap; /* Prevent message from wrapping */
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

        /* Custom Confirmation Dialog Styles */
        .confirmation-dialog {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .confirmation-dialog.show {
            opacity: 1;
            visibility: visible;
        }
        .confirmation-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        /* Styles for the print window */
        @media print {
            body {
                margin: 0;
                padding: 0;
                font-size: 12px;
                font-family: 'monospace';
            }
            .receipt-container {
                width: 300px; /* Approximately 80mm at 96 DPI */
                padding: 10px;
                box-sizing: border-box;
                border: none !important;
                box-shadow: none !important;
            }
            /* Hide everything except the receipt when printing */
            body > *:not(.receipt-container) {
                display: none !important;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Main POS Container -->
    <div class="flex flex-1 flex-col lg:flex-row p-4 gap-4 max-w-7xl mx-auto w-full">

        <!-- Menu Section -->
        <div class="lg:w-2/3 bg-white rounded-lg shadow-md p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Menu</h2>
                <button id="manage-menu-btn" class="action-button bg-purple-500 text-white py-2 px-4 rounded-lg font-semibold text-base shadow-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                    Manage Menu
                </button>
            </div>

            <!-- Menu Categories -->
            <div id="menu-categories" class="flex flex-wrap justify-center gap-3 mb-6">
                <!-- Categories will be dynamically loaded here -->
            </div>

            <!-- Menu Items -->
            <div id="menu-items-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 flex-grow overflow-y-auto pr-2">
                <!-- Menu items will be dynamically loaded here -->
                <p id="empty-main-menu-message" class="text-gray-500 text-center col-span-full hidden">No menu items available. Add some from 'Manage Menu'!</p>
            </div>
        </div>

        <!-- Order & Payment Section -->
        <div class="lg:w-1/3 bg-white rounded-lg shadow-md p-6 flex flex-col">
            <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Current Order</h2>

            <!-- Order List -->
            <div id="order-list" class="flex-grow overflow-y-auto mb-4 pr-2 border-b border-gray-200">
                <!-- Order items will be dynamically loaded here -->
                <p id="empty-order-message" class="text-gray-500 text-center mt-4">No items in the order yet.</p>
            </div>

            <!-- Order Summary -->
            <div class="mb-6 border-t pt-4 border-gray-200">
                <div class="flex justify-between text-gray-700 text-lg mb-2">
                    <span>Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="flex justify-between text-gray-700 text-lg mb-2">
                    <span>Tax (10%):</span>
                    <span id="tax">$0.00</span>
                </div>
                <div class="flex justify-between text-gray-800 text-2xl font-bold mb-4">
                    <span>Total:</span>
                    <span id="total">$0.00</span>
                </div>
            </div>

            <!-- Payment Buttons -->
            <div class="grid grid-cols-2 gap-4">
                <button id="clear-order-btn" class="action-button bg-red-500 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                    Clear Order
                </button>
                <button id="checkout-btn" class="action-button bg-green-500 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                    Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-3xl font-bold mb-6 text-gray-800 text-center">Process Payment</h3>

            <div class="mb-4">
                <label for="order-name" class="block text-gray-700 text-lg font-semibold mb-2">Order Name/Number:</label>
                <input type="text" id="order-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-xl" placeholder="e.g., Table 5, To-Go, John Doe">
            </div>

            <div class="mb-4">
                <p class="text-gray-700 text-xl mb-2">Amount Due:</p>
                <p id="modal-amount-due" class="text-green-600 text-4xl font-extrabold text-center">$0.00</p>
            </div>

            <div class="mb-6">
                <label for="amount-received" class="block text-gray-700 text-lg font-semibold mb-2">Amount Received:</label>
                <input type="number" id="amount-received" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-xl" placeholder="Enter amount">
            </div>

            <div class="mb-6 text-gray-700 text-xl">
                <span>Change:</span>
                <span id="modal-change" class="font-bold ml-2">$0.00</span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button id="cancel-payment-btn" class="action-button bg-gray-400 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    Cancel
                </button>
                <button id="confirm-payment-btn" class="action-button bg-blue-500 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Confirm Payment
                </button>
            </div>
        </div>
    </div>


    <!-- Store Information Modal -->
    <div id="store-info-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-3xl font-bold mb-6 text-gray-800 text-center">Edit Store Information</h3>

            <div class="mb-4">
                <label for="store-name-input" class="block text-gray-700 text-lg font-semibold mb-2">Store Name:</label>
                <input type="text" id="store-name-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="e.g., My Awesome Restaurant">
            </div>
            <div class="mb-4">
                <label for="store-address-input" class="block text-gray-700 text-lg font-semibold mb-2">Address:</label>
                <input type="text" id="store-address-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="e.g., 123 Main St, Anytown, USA">
            </div>
            <div class="mb-4">
                <label for="store-phone-input" class="block text-gray-700 text-lg font-semibold mb-2">Phone:</label>
                <input type="text" id="store-phone-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="e.g., (555) 123-4567">
            </div>
            <div class="mb-6">
                <label for="store-slogan-input" class="block text-gray-700 text-lg font-semibold mb-2">Slogan/Website:</label>
                <input type="text" id="store-slogan-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="e.g., www.myrestaurant.com or 'Great Food, Great Times!'">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button id="cancel-store-info-btn" class="action-button bg-gray-400 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    Cancel
                </button>
                <button id="save-store-info-btn" class="action-button bg-blue-500 text-white py-3 px-6 rounded-lg font-semibold text-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Save Changes
                </button>
            </div>
        </div>
    </div>


    <!-- Menu Management Modal -->
    <div id="manage-menu-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <h3 class="text-3xl font-bold mb-6 text-gray-800 text-center">Manage Menu</h3>

            <!-- Add Category Section -->
            <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                <h4 class="text-xl font-semibold mb-4 text-gray-800">Add New Category</h4>
                <div class="flex items-end gap-3">
                    <div class="flex-grow">
                        <label for="new-category-name" class="block text-gray-700 text-sm font-semibold mb-1">Category Name:</label>
                        <input type="text" id="new-category-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Soups">
                    </div>
                    <button id="add-category-btn" class="action-button bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        Add Category
                    </button>
                </div>
            </div>

            <!-- Add/Edit Item Section -->
            <div class="p-4 border border-gray-200 rounded-lg mb-8">
                <h4 id="item-form-title" class="text-xl font-semibold mb-4 text-gray-800">Add New Menu Item</h4>
                <input type="hidden" id="editing-item-id"> <!-- Hidden input to store item ID being edited -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="new-item-name" class="block text-gray-700 text-sm font-semibold mb-1">Item Name:</label>
                        <input type="text" id="new-item-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Chicken Caesar Salad">
                    </div>
                    <div>
                        <label for="new-item-price" class="block text-gray-700 text-sm font-semibold mb-1">Price:</label>
                        <input type="number" id="new-item-price" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" step="0.01" placeholder="e.g., 12.99">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="new-item-category" class="block text-gray-700 text-sm font-semibold mb-1">Category:</label>
                    <select id="new-item-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <!-- Categories will be dynamically loaded here -->
                    </select>
                </div>
                <div class="flex justify-between items-center">
                    <button id="add-item-btn" class="action-button bg-green-500 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                        Add Item
                    </button>
                    <button id="cancel-edit-btn" class="action-button bg-gray-400 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 hidden">
                        Cancel Edit
                    </button>
                </div>
            </div>

            <!-- Existing Items List -->
            <div class="flex-grow overflow-y-auto pr-2">
                <h4 class="text-xl font-semibold mb-4 text-gray-800">Current Menu Items</h4>
                <div id="current-menu-items-list" class="space-y-2">
                    <!-- Existing menu items will be loaded here -->
                    <p id="empty-manage-items-message" class="text-gray-500 text-center mt-4 hidden">No items to manage yet.</p>
                </div>
            </div>

            <div class="mt-6 flex justify-between items-center">
                <button id="clear-all-data-btn" class="action-button bg-red-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50">
                    Clear All Data
                </button>
                <button id="close-manage-menu-btn" class="action-button bg-gray-400 text-white py-2 px-6 rounded-lg font-semibold shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="custom-message-box" class="message-box"></div>

    <!-- Custom Confirmation Dialog -->
    <div id="confirmation-dialog" class="confirmation-dialog hidden">
        <div class="confirmation-content">
            <p id="confirmation-message" class="text-lg font-semibold mb-6 text-gray-800"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-btn" class="action-button bg-gray-400 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-500">No</button>
                <button id="confirm-yes-btn" class="action-button bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600">Yes</button>
            </div>
        </div>
    </div>

    <script>
        // Global utility to show messages
        function showMessageBox(message, duration = 3000) {
            const msgBox = document.getElementById('custom-message-box');
            msgBox.textContent = message;
            msgBox.classList.add('show');
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, duration);
        }

        // Global utility for confirmation dialogs
        function showConfirmationDialog(message, onConfirm) {
            const dialog = document.getElementById('confirmation-dialog');
            const msgElement = document.getElementById('confirmation-message');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');

            msgElement.textContent = message;
            dialog.classList.add('show');

            const handleYes = () => {
                onConfirm(true);
                dialog.classList.remove('show');
                confirmYesBtn.removeEventListener('click', handleYes);
                confirmNoBtn.removeEventListener('click', handleNo);
            };

            const handleNo = () => {
                onConfirm(false);
                dialog.classList.remove('show');
                confirmYesBtn.removeEventListener('click', handleYes);
                confirmNoBtn.removeEventListener('click', handleNo);
            };

            confirmYesBtn.addEventListener('click', handleYes);
            confirmNoBtn.addEventListener('click', handleNo);
        }


        // --- Local Storage Keys ---
        const LOCAL_STORAGE_MENU_KEY = 'restaurantPOSMenu';
        const LOCAL_STORAGE_CATEGORIES_KEY = 'restaurantPOSCategories';
        const LOCAL_STORAGE_STORE_INFO_KEY = 'restaurantPOSStoreInfo';

        // --- Store Information Variables ---
        let storeInfo = {
            name: 'Your Restaurant',
            address: '123 Main St, Anytown, USA',
            phone: '(555) 123-4567',
            slogan: 'Great Food, Great Times!'
        };

        /**
         * Saves the current menu, categories, and store info to local storage.
         */
        function saveDataToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_MENU_KEY, JSON.stringify(menu));
            localStorage.setItem(LOCAL_STORAGE_CATEGORIES_KEY, JSON.stringify(Array.from(categories)));
            localStorage.setItem(LOCAL_STORAGE_STORE_INFO_KEY, JSON.stringify(storeInfo));
        }

        /**
         * Loads all data (menu, categories, store info) from local storage.
         * Initializes them if no data is found.
         */
        function loadDataFromLocalStorage() {
            const storedMenu = localStorage.getItem(LOCAL_STORAGE_MENU_KEY);
            const storedCategories = localStorage.getItem(LOCAL_STORAGE_CATEGORIES_KEY);
            const storedStoreInfo = localStorage.getItem(LOCAL_STORAGE_STORE_INFO_KEY);

            if (storedMenu) {
                try {
                    menu = JSON.parse(storedMenu);
                } catch (e) {
                    console.error("Error parsing stored menu data:", e);
                    menu = [];
                }
            } else {
                menu = [];
            }

            if (storedCategories) {
                try {
                    categories = new Set(JSON.parse(storedCategories));
                } catch (e) {
                    console.error("Error parsing stored categories data:", e);
                    categories = new Set();
                }
            } else {
                categories = new Set();
            }

            if (storedStoreInfo) {
                try {
                    storeInfo = { ...storeInfo, ...JSON.parse(storedStoreInfo) }; // Merge with defaults
                } catch (e) {
                    console.error("Error parsing stored store info data:", e);
                    // Keep default storeInfo if parsing fails
                }
            }
        }

        /**
         * Clears all menu and category data from local storage and resets in-memory data.
         */
        function clearAllData() {
            showConfirmationDialog('Are you sure you want to clear ALL menu and category data? This cannot be undone.', (confirmed) => {
                if (confirmed) {
                    localStorage.removeItem(LOCAL_STORAGE_MENU_KEY);
                    localStorage.removeItem(LOCAL_STORAGE_CATEGORIES_KEY);
                    menu = [];
                    categories = new Set();
                    currentOrder = [];

                    renderMenuCategories();
                    populateCategorySelect();
                    renderOrder();
                    renderManageItemsList();
                    resetItemForm();

                    showMessageBox('All data cleared successfully!');
                    closeManageMenuModal();
                } else {
                    showMessageBox('Clear all data cancelled.');
                }
            });
        }

        // Global state for the current order
        let menu = [];
        let currentOrder = [];
        const TAX_RATE = 0.10;

        // DOM Elements
        const menuCategoriesContainer = document.getElementById('menu-categories');
        const menuItemsContainer = document.getElementById('menu-items-container');
        const emptyMainMenuMessage = document.getElementById('empty-main-menu-message');
        const orderList = document.getElementById('order-list');
        const emptyOrderMessage = document.getElementById('empty-order-message');
        const subtotalSpan = document.getElementById('subtotal');
        const taxSpan = document.getElementById('tax');
        const totalSpan = document.getElementById('total');
        const clearOrderBtn = document.getElementById('clear-order-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        const paymentModal = document.getElementById('payment-modal');
        const modalAmountDue = document.getElementById('modal-amount-due');
        const amountReceivedInput = document.getElementById('amount-received');
        const modalChange = document.getElementById('modal-change');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
        const orderNameInput = document.getElementById('order-name');

        // Store Info Modal DOM Elements
        const storeInfoModal = document.getElementById('store-info-modal');
        const storeNameInput = document.getElementById('store-name-input');
        const storeAddressInput = document.getElementById('store-address-input');
        const storePhoneInput = document.getElementById('store-phone-input');
        const storeSloganInput = document.getElementById('store-slogan-input');
        const cancelStoreInfoBtn = document.getElementById('cancel-store-info-btn');
        const saveStoreInfoBtn = document.getElementById('save-store-info-btn');

        // Variables to pass data for kitchen receipt
        let lastOrderDetails = {};

        // Menu Management DOM Elements
        const manageMenuBtn = document.getElementById('manage-menu-btn');
        const manageMenuModal = document.getElementById('manage-menu-modal');
        const closeManageMenuBtn = document.getElementById('close-manage-menu-btn');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const newItemNameInput = document.getElementById('new-item-name');
        const newItemPriceInput = document.getElementById('new-item-price');
        const newItemCategorySelect = document.getElementById('new-item-category');
        const addItemBtn = document.getElementById('add-item-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const itemFormTitle = document.getElementById('item-form-title');
        const editingItemIdInput = document.getElementById('editing-item-id');
        const currentMenuItemsList = document.getElementById('current-menu-items-list');
        const emptyManageItemsMessage = document.getElementById('empty-manage-items-message');
        const clearAllDataBtn = document.getElementById('clear-all-data-btn');

        /**
         * Renders the menu categories based on the unique categories in the menu data.
         * Adds an "All" category by default.
         */
        function renderMenuCategories() {
            const sortedCategories = menu.length > 0 ? ['All', ...Array.from(categories).sort()] : [];
            menuCategoriesContainer.innerHTML = '';

            if (sortedCategories.length > 0) {
                sortedCategories.forEach(category => {
                    const button = document.createElement('button');
                    button.textContent = category;
                    button.classList.add(
                        'px-5', 'py-2', 'rounded-full', 'font-semibold', 'text-lg',
                        'bg-blue-100', 'text-blue-700', 'hover:bg-blue-200', 'focus:outline-none',
                        'focus:ring-2', 'focus:ring-blue-500', 'focus:ring-opacity-50', 'transition-colors'
                    );
                    button.dataset.category = category;
                    button.addEventListener('click', () => filterMenuItems(category));
                    menuCategoriesContainer.appendChild(button);
                });
                filterMenuItems('All');
            } else {
                menuItemsContainer.innerHTML = '';
                emptyMainMenuMessage.classList.remove('hidden');
                emptyMainMenuMessage.textContent = "No menu items available. Add some from 'Manage Menu'!";
            }
        }

        /**
         * Populates the category select dropdown in the Add/Edit Item form.
         */
        function populateCategorySelect() {
            newItemCategorySelect.innerHTML = '<option value="">Select Category</option>';
            Array.from(categories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                newItemCategorySelect.appendChild(option);
            });
        }

        /**
         * Filters and displays menu items based on the selected category.
         * @param {string} category The category to filter by (e.g., 'Appetizers', 'All').
         */
        function filterMenuItems(category) {
            menuItemsContainer.innerHTML = '';
            const filteredMenu = category === 'All' ? menu : menu.filter(item => item.category === category);

            if (filteredMenu.length === 0) {
                emptyMainMenuMessage.classList.remove('hidden');
                menuItemsContainer.appendChild(emptyMainMenuMessage);
                if (menu.length === 0) {
                    emptyMainMenuMessage.textContent = "No menu items available. Add some from 'Manage Menu'!";
                } else {
                    emptyMainMenuMessage.textContent = "No items found in this category.";
                }
                return;
            } else {
                emptyMainMenuMessage.classList.add('hidden');
            }

            filteredMenu.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.classList.add(
                    'bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'cursor-pointer',
                    'flex', 'flex-col', 'justify-between', 'menu-item-card'
                );
                itemCard.dataset.itemId = item.id;
                itemCard.innerHTML = `
                    <h4 class="text-xl font-semibold text-gray-800 mb-2">${item.name}</h4>
                    <p class="text-gray-600 text-sm mb-3">${item.category}</p>
                    <p class="text-green-600 text-2xl font-bold self-end">$${item.price.toFixed(2)}</p>
                `;
                itemCard.addEventListener('click', () => addItemToOrder(item));
                menuItemsContainer.appendChild(itemCard);
            });
        }

        /**
         * Adds a selected menu item to the current order or increments its quantity.
         * @param {Object} item The menu item to add.
         */
        function addItemToOrder(item) {
            const existingItem = currentOrder.find(orderItem => orderItem.id === item.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                currentOrder.push({ ...item, quantity: 1 });
            }
            renderOrder();
            showMessageBox(`${item.name} added to order.`);
        }

        /**
         * Updates the quantity of an item in the current order.
         * @param {string} itemId The ID of the item to update.
         * @param {number} change The amount to change the quantity by (+1 or -1).
         */
        function updateItemQuantity(itemId, change) {
            const itemIndex = currentOrder.findIndex(orderItem => orderItem.id === itemId);
            if (itemIndex > -1) {
                currentOrder[itemIndex].quantity += change;
                if (currentOrder[itemIndex].quantity <= 0) {
                    currentOrder.splice(itemIndex, 1);
                }
            }
            renderOrder();
        }

        /**
         * Renders the current order list and updates the summary totals.
         */
        function renderOrder() {
            orderList.innerHTML = '';
            if (currentOrder.length === 0) {
                emptyOrderMessage.classList.remove('hidden');
                orderList.appendChild(emptyOrderMessage);
            } else {
                emptyOrderMessage.classList.add('hidden');
                currentOrder.forEach(item => {
                    const orderItemDiv = document.createElement('div');
                    orderItemDiv.classList.add('order-item');
                    orderItemDiv.innerHTML = `
                        <div class="flex-grow">
                            <p class="text-gray-800 font-semibold">${item.name}</p>
                            <p class="text-gray-600 text-sm">$${item.price.toFixed(2)} each</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="quantity-btn decrease-quantity" data-item-id="${item.id}">-</button>
                            <span class="text-xl font-bold">${item.quantity}</span>
                            <button class="quantity-btn increase-quantity" data-item-id="${item.id}">+</button>
                            <span class="text-xl font-bold w-20 text-right">$${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `;
                    orderList.appendChild(orderItemDiv);
                });
            }
            updateOrderSummary();
            addQuantityButtonListeners();
        }

        /**
         * Adds event listeners to the quantity adjustment buttons.
         */
        function addQuantityButtonListeners() {
            document.querySelectorAll('.increase-quantity').forEach(button => {
                button.onclick = (e) => updateItemQuantity(e.target.dataset.itemId, 1);
            });
            document.querySelectorAll('.decrease-quantity').forEach(button => {
                button.onclick = (e) => updateItemQuantity(e.target.dataset.itemId, -1);
            });
        }

        /**
         * Calculates and updates the subtotal, tax, and total of the current order.
         */
        function updateOrderSummary() {
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax;

            subtotalSpan.textContent = `$${subtotal.toFixed(2)}`;
            taxSpan.textContent = `$${tax.toFixed(2)}`;
            totalSpan.textContent = `$${total.toFixed(2)}`;
        }

        /**
         * Clears the entire current order.
         */
        function clearOrder() {
            if (currentOrder.length === 0) {
                showMessageBox('Order is already empty!', 2000);
                return;
            }
            currentOrder = [];
            renderOrder();
            showMessageBox('Order cleared successfully!');
        }

        /**
         * Opens the payment modal and sets the amount due.
         */
        function openPaymentModal() {
            const totalAmount = parseFloat(totalSpan.textContent.replace('$', ''));
            if (totalAmount <= 0) {
                showMessageBox('Please add items to the order before checking out.', 3000);
                return;
            }
            modalAmountDue.textContent = totalSpan.textContent;
            amountReceivedInput.value = '';
            modalChange.textContent = '$0.00';
            orderNameInput.value = '';
            paymentModal.classList.remove('hidden');
            orderNameInput.focus();
        }

        /**
         * Closes the payment modal.
         */
        function closePaymentModal() {
            paymentModal.classList.add('hidden');
        }

        /**
         * Calculates and displays change when amount received input changes.
         */
        function calculateChange() {
            const amountDue = parseFloat(totalSpan.textContent.replace('$', ''));
            const amountReceived = parseFloat(amountReceivedInput.value) || 0;
            const change = amountReceived - amountDue;
            modalChange.textContent = `$${Math.max(0, change).toFixed(2)}`;
        }

        /**
         * Confirms payment and triggers automatic kitchen receipt printing.
         */
        function confirmPayment() {
            const amountDue = parseFloat(totalSpan.textContent.replace('$', ''));
            const amountReceived = parseFloat(amountReceivedInput.value) || 0;
            const orderName = orderNameInput.value.trim() || `Order #${Date.now().toString().slice(-4)}`;

            if (amountReceived < amountDue) {
                showMessageBox('Amount received is less than the total amount due!', 3000);
                return;
            }

            // Store order details for kitchen receipt
            lastOrderDetails = {
                orderName: orderName,
                items: JSON.parse(JSON.stringify(currentOrder)) // Deep copy current order items
            };

            // Generate and print Kitchen Receipt immediately
            generateKitchenReceipt(lastOrderDetails.orderName, lastOrderDetails.items);

            // Finalize the order
            finalizeOrder();
            showMessageBox('Payment successful! Kitchen receipt printed. Order finalized.');
        }


        /**
         * Prints the provided HTML content in a new window.
         * @param {string} htmlContent The full HTML document string to print.
         * @param {string} title The title for the print window.
         */
        function printReceiptContent(htmlContent, title) {
            const printWindow = window.open('', '_blank', 'width=320,height=auto,scrollbars=yes');
            printWindow.document.write(htmlContent);
            printWindow.document.title = title;
            printWindow.document.close();

            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        }

        /**
         * Generates and prints an 80mm kitchen receipt.
         * @param {string} orderName The name/number of the order.
         * @param {Array<Object>} items The list of items in the order.
         */
        function generateKitchenReceipt(orderName, items) {
            const now = new Date().toLocaleString();
            let itemsHtml = items.map(item => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                    <span style="flex-grow: 1; padding-right: 5px;">${item.quantity}x ${item.name}</span>
                    <span style="text-align: right;">$${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');

            // Calculate total items
            const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);

            const kitchenReceiptContentHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Kitchen Receipt</title>
                    <style>
                        body {
                            font-family: 'monospace', 'Courier New', monospace;
                            font-size: 12px;
                            margin: 0;
                            padding: 10px;
                            width: 300px;
                            box-sizing: border-box;
                            white-space: pre-wrap;
                        }
                        .header, .footer {
                            text-align: center;
                            margin-bottom: 10px;
                        }
                        .item-line {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 2px;
                        }
                        .item-name {
                            flex-grow: 1;
                            padding-right: 5px;
                        }
                        .item-qty, .item-price {
                            text-align: right;
                        }
                        .divider {
                            border-top: 1px dashed black;
                            margin: 10px 0;
                        }
                        .total-line {
                            display: flex;
                            justify-content: space-between;
                            font-weight: bold;
                            margin-top: 5px;
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        <div class="header">
                            <h3>--- KITCHEN ORDER ---</h3>
                            <p>Order Name: ${orderName}</p>
                            <p>${now}</p>
                            <div class="divider"></div>
                        </div>
                        <h4>ITEMS:</h4>
                        ${itemsHtml}
                        <div class="divider"></div>
                        <div class="total-line">
                            <span>Total Items:</span>
                            <span>${totalItems}</span>
                        </div>
                        <div class="footer">
                            <div class="divider"></div>
                            <p>*** END OF ORDER ***</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            printReceiptContent(kitchenReceiptContentHtml, 'Kitchen Receipt');
        }

        /**
         * Finalizes the order after all receipt processes are complete.
         */
        function finalizeOrder() {
            closePaymentModal();
            clearOrder();
        }


        // --- Store Information Management Functions ---
        /**
         * Opens the modal for editing store information.
         */
        function openStoreInfoModal() {
            storeNameInput.value = storeInfo.name;
            storeAddressInput.value = storeInfo.address;
            storePhoneInput.value = storeInfo.phone;
            storeSloganInput.value = storeInfo.slogan;
            storeInfoModal.classList.remove('hidden');
        }

        /**
         * Closes the store information modal.
         */
        function closeStoreInfoModal() {
            storeInfoModal.classList.add('hidden');
        }

        /**
         * Saves the edited store information to local storage.
         */
        function saveStoreInfo() {
            storeInfo.name = storeNameInput.value.trim();
            storeInfo.address = storeAddressInput.value.trim();
            storeInfo.phone = storePhoneInput.value.trim();
            storeInfo.slogan = storeSloganInput.value.trim();
            saveDataToLocalStorage();
            showMessageBox('Store information updated!');
            closeStoreInfoModal();
        }


        // --- Menu Management Functions ---
        /**
         * Opens the menu management modal and populates the item list and category dropdown.
         */
        function openManageMenuModal() {
            populateCategorySelect();
            renderManageItemsList();
            resetItemForm();
            manageMenuModal.classList.remove('hidden');
        }

        /**
         * Closes the menu management modal.
         */
        function closeManageMenuModal() {
            manageMenuModal.classList.add('hidden');
            resetItemForm();
            renderMenuCategories();
        }

        /**
         * Resets the add/edit item form to its default 'Add New Item' state.
         */
        function resetItemForm() {
            editingItemIdInput.value = '';
            itemFormTitle.textContent = 'Add New Menu Item';
            addItemBtn.textContent = 'Add Item';
            addItemBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            addItemBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            cancelEditBtn.classList.add('hidden');
            newItemNameInput.value = '';
            newItemPriceInput.value = '';
            newItemCategorySelect.value = '';
        }

        /**
         * Adds a new category to the categories Set and re-renders menus.
         */
        function addCategory() {
            const newCategory = newCategoryNameInput.value.trim();
            if (newCategory) {
                if (categories.has(newCategory)) {
                    showMessageBox(`Category "${newCategory}" already exists!`, 3000);
                    return;
                }
                categories.add(newCategory);
                newCategoryNameInput.value = '';
                renderMenuCategories();
                populateCategorySelect();
                saveDataToLocalStorage();
                showMessageBox(`Category "${newCategory}" added!`);
            } else {
                showMessageBox('Please enter a category name.', 3000);
            }
        }

        /**
         * Handles adding a new item or saving changes to an existing item.
         */
        function handleSaveItem() {
            const itemId = editingItemIdInput.value;
            const itemName = newItemNameInput.value.trim();
            const itemPrice = parseFloat(newItemPriceInput.value);
            const itemCategory = newItemCategorySelect.value;

            if (!itemName || isNaN(itemPrice) || itemPrice <= 0 || !itemCategory) {
                showMessageBox('Please fill in all item details correctly (name, valid price, category).', 3000);
                return;
            }

            if (itemId) {
                const itemIndex = menu.findIndex(item => item.id === itemId);
                if (itemIndex > -1) {
                    if (menu.some(item => item.id !== itemId && item.name.toLowerCase() === itemName.toLowerCase())) {
                        showMessageBox(`Another item named "${itemName}" already exists!`, 3000);
                        return;
                    }
                    menu[itemIndex].name = itemName;
                    menu[itemIndex].price = itemPrice;
                    menu[itemIndex].category = itemCategory;

                    updateCategoriesSet();
                    showMessageBox(`Item "${itemName}" updated!`);
                }
            } else {
                if (menu.some(item => item.name.toLowerCase() === itemName.toLowerCase())) {
                    showMessageBox(`Item "${itemName}" already exists!`, 3000);
                    return;
                }

                const newItem = {
                    id: `item-${Date.now()}`,
                    category: itemCategory,
                    name: itemName,
                    price: itemPrice
                };
                menu.push(newItem);
                categories.add(itemCategory);
                showMessageBox(`Item "${itemName}" added!`);
            }

            saveDataToLocalStorage();
            renderMenuCategories();
            renderManageItemsList();
            populateCategorySelect();
            resetItemForm();
        }

        /**
         * Populates the form fields with data of the item to be edited.
         * @param {string} itemId The ID of the item to edit.
         */
        function editItem(itemId) {
            const itemToEdit = menu.find(item => item.id === itemId);
            if (itemToEdit) {
                editingItemIdInput.value = itemToEdit.id;
                newItemNameInput.value = itemToEdit.name;
                newItemPriceInput.value = itemToEdit.price;
                newItemCategorySelect.value = itemToEdit.category;

                itemFormTitle.textContent = `Edit Item: ${itemToEdit.name}`;
                addItemBtn.textContent = 'Save Changes';
                addItemBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                addItemBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                cancelEditBtn.classList.remove('hidden');
            }
        }

        /**
         * Deletes an item from the menu.
         * @param {string} itemId The ID of the item to delete.
         * @param {string} itemName The name of the item (for confirmation message).
         */
        function deleteItem(itemId, itemName) {
            showConfirmationDialog(`Are you sure you want to delete "${itemName}"? This cannot be undone.`, (confirmed) => {
                if (confirmed) {
                    const initialLength = menu.length;
                    menu = menu.filter(item => item.id !== itemId);
                    if (menu.length < initialLength) {
                        currentOrder = currentOrder.filter(orderItem => orderItem.id !== itemId);
                        renderOrder();

                        updateCategoriesSet();
                        saveDataToLocalStorage();

                        renderMenuCategories();
                        renderManageItemsList();
                        populateCategorySelect();
                        showMessageBox(`Item "${itemName}" deleted!`);
                    } else {
                        showMessageBox(`Failed to delete "${itemName}".`);
                    }
                } else {
                    showMessageBox(`Deletion of "${itemName}" cancelled.`);
                }
            });
        }

        /**
         * Re-evaluates the categories Set based on the current items in the menu array.
         * Useful after item deletion or category changes.
         */
        function updateCategoriesSet() {
            const currentCategories = new Set(menu.map(item => item.category));
            categories.clear();
            currentCategories.forEach(cat => categories.add(cat));
        }

        /**
         * Renders the list of current menu items in the management modal
         * with edit and delete buttons.
         */
        function renderManageItemsList() {
            currentMenuItemsList.innerHTML = '';
            if (menu.length === 0) {
                emptyManageItemsMessage.classList.remove('hidden');
                currentMenuItemsList.appendChild(emptyManageItemsMessage);
                return;
            } else {
                emptyManageItemsMessage.classList.add('hidden');
            }

            const sortedMenu = [...menu].sort((a, b) => a.name.localeCompare(b.name));

            sortedMenu.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add(
                    'flex', 'items-center', 'justify-between', 'p-3', 'bg-gray-50',
                    'rounded-lg', 'shadow-sm', 'border', 'border-gray-200'
                );
                itemDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${item.name} <span class="text-gray-500 text-sm">(${item.category})</span></p>
                        <p class="text-green-600 text-lg font-bold">$${item.price.toFixed(2)}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="action-button bg-yellow-500 text-white py-1 px-3 rounded-md text-sm hover:bg-yellow-600 edit-item-btn" data-item-id="${item.id}">Edit</button>
                        <button class="action-button bg-red-500 text-white py-1 px-3 rounded-md text-sm hover:bg-red-600 delete-item-btn" data-item-id="${item.id}" data-item-name="${item.name}">Delete</button>
                    </div>
                `;
                currentMenuItemsList.appendChild(itemDiv);
            });

            document.querySelectorAll('.edit-item-btn').forEach(button => {
                button.addEventListener('click', (e) => editItem(e.target.dataset.itemId));
            });
            document.querySelectorAll('.delete-item-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(e.target.dataset.itemId, e.target.dataset.itemName));
            });
        }


        // Event Listeners for main POS functions
        clearOrderBtn.addEventListener('click', clearOrder);
        checkoutBtn.addEventListener('click', openPaymentModal);
        cancelPaymentBtn.addEventListener('click', closePaymentModal);
        amountReceivedInput.addEventListener('input', calculateChange);
        confirmPaymentBtn.addEventListener('click', confirmPayment);

        // Store Info Modal Event Listeners
        cancelStoreInfoBtn.addEventListener('click', closeStoreInfoModal);
        saveStoreInfoBtn.addEventListener('click', saveStoreInfo);

        // Global Ctrl+S listener for store info (only if no other modals are open)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                // Check if any other major modals are open
                const isAnyModalOpen = !paymentModal.classList.contains('hidden') ||
                                       !manageMenuModal.classList.contains('hidden') ||
                                       !storeInfoModal.classList.contains('hidden');

                if (!isAnyModalOpen) {
                    e.preventDefault();
                    openStoreInfoModal();
                } else if (!storeInfoModal.classList.contains('hidden')) {
                    e.preventDefault();
                }
            }
        });


        // Menu Management Event Listeners
        manageMenuBtn.addEventListener('click', openManageMenuModal);
        closeManageMenuBtn.addEventListener('click', closeManageMenuModal);
        addCategoryBtn.addEventListener('click', addCategory);
        addItemBtn.addEventListener('click', handleSaveItem);
        cancelEditBtn.addEventListener('click', resetItemForm);
        clearAllDataBtn.addEventListener('click', clearAllData);


        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            renderMenuCategories();
            populateCategorySelect();
            renderOrder();
        });
    </script>
</body>
</html>
