<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced POS System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JsBarcode CDN -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        /* Using a monospace font for receipts to mimic thermal printer output */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        /* Override Tailwind for specific dark theme elements */
        .bg-gray-800 { background-color: #2d3748; } /* Slightly lighter dark for sections */
        .bg-gray-900 { background-color: #1a202c; } /* Body background */
        .text-gray-100 { color: #f7fafc; }
        .text-gray-200 { color: #edf2f7; }
        .text-gray-300 { color: #e2e8f0; }
        .text-gray-400 { color: #cbd5e0; }
        .text-gray-500 { color: #a0aec0; }
        .border-gray-200 { border-color: #4a5568; } /* Darker borders */
        .border-gray-300 { border-color: #4a5568; }
        .border-gray-600 { border-color: #4a5568; }
        .border-gray-700 { border-color: #4a5568; }
        .placeholder-gray-400::placeholder { color: #a0aec0; } /* Placeholder color */

        input, select, textarea {
            background-color: #2d3748; /* Darker input background */
            color: #e2e8f0; /* Light text in inputs */
            border-color: #4a5568;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #63b3ed; /* Focus border */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* Focus ring */
            outline: none; /* Remove default browser outline if ring is applied */
        }

        /* Ensure all interactive elements get a visible focus style */
        button:focus, a:focus, [tabindex]:focus:not(input, select, textarea) {
            outline: 2px solid #63b3ed; /* Blue ring for focus */
            outline-offset: 2px;
        }


        table {
            color: #e2e8f0;
        }
        thead {
            background-color: #2d3748; /* Table header background */
        }
        tbody tr:nth-child(even) {
            background-color: #2d3748; /* Alternate row background */
        }
        tbody tr:nth-child(odd) {
            background-color: #1a202c; /* Alternate row background */
        }
        tbody tr:hover {
            background-color: #4a5568; /* Hover background */
        }

        /* Tab styling */
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            background-color: #2d3748;
            color: #a0aec0;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            background-color: #4a5568; /* Active tab background */
            color: #f7fafc; /* Active tab text */
            border-bottom-color: #63b3ed; /* Active tab indicator */
            position: relative; /* For z-index */
            z-index: 10; /* Bring to front of border */
            box-shadow: 0 -4px 6px rgba(0,0,0,0.2); /* Subtle lift */
        }
        .tab-content {
            display: none; /* Default hidden state (Tailwind's hidden class provides this) */
            padding: 1.5rem;
            background-color: #2d3748; /* Tab content background */
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            min-height: 400px; /* Ensure visible height even if content is small */
        }
        .tab-content.active {
            display: flex; /* Show active tab (overrides hidden) */
        }

        /* Custom styles for print media (optimized for 80mm printer) */
        @media print {
            body * {
                visibility: hidden;
            }
            #receipt-print-area, #receipt-print-area * {
                visibility: visible;
                color: #000 !important; /* Force black text for print */
                font-family: 'Roboto Mono', monospace !important; /* Monospace font for receipt */
            }
            #receipt-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 78mm; /* Approx 3.15 inches for 80mm printer */
                padding: 5mm; /* Reduced padding for compact receipt */
                box-sizing: border-box;
                font-size: 11px; /* Smaller base font for receipts */
                line-height: 1.4; /* Slightly more space for readability */
                background-color: #fff !important; /* Force white background */
            }
            #receipt-print-area h2 {
                text-align: center;
                font-size: 1.5em; /* Larger store name */
                margin-bottom: 5px;
                color: #000 !important;
                font-weight: bold;
                text-transform: uppercase;
            }
            #receipt-print-area h3 {
                text-align: center;
                font-size: 1.1em;
                margin-bottom: 3px;
                color: #000 !important;
                font-weight: bold;
            }
            #receipt-print-area h4 {
                text-align: center;
                font-size: 1em;
                margin-bottom: 5px;
                color: #000 !important;
                font-weight: bold;
                text-decoration: underline;
            }
            #receipt-print-area p {
                font-size: 0.95em;
                line-height: 1.3;
                margin-bottom: 2px;
                color: #000 !important;
            }
            #receipt-logo {
                max-width: 60mm; /* Max width for logo to fit 80mm receipt */
                height: auto;
                margin: 0 auto 10px auto;
                display: block;
            }
            .receipt-header, .receipt-footer, .receipt-totals, .receipt-barcode, .receipt-recommended-discounts {
                margin-bottom: 5mm; /* Spacing between sections */
            }
            .dashed-line {
                border-bottom: 1px dashed #000;
                margin: 5px 0; /* Space around dashed lines */
            }
            table.receipt-items {
                width: 100%;
                border-collapse: collapse;
                margin: 5px 0;
            }
            table.receipt-items th, table.receipt-items td {
                padding: 2px 0;
                color: #000 !important;
                border-bottom: none; /* Remove default table borders */
            }
            table.receipt-items th {
                font-weight: bold;
                padding-bottom: 5px;
            }
            /* Explicit alignment for receipt item table */
            table.receipt-items th:nth-child(1),
            table.receipt-items td:nth-child(1) {
                text-align: left; /* Item Name */
            }
            table.receipt-items th:nth-child(2),
            table.receipt-items td:nth-child(2) {
                text-align: right; /* Price */
            }

            .receipt-totals div {
                display: flex;
                justify-content: space-between;
                margin-bottom: 3px;
                font-size: 1.1em;
            }
            .receipt-totals h3 {
                margin-top: 5px;
                padding-top: 5px;
                border-top: 2px solid #000; /* Strong line before grand total */
                font-size: 1.3em;
            }
            .receipt-totals span {
                font-weight: bold;
            }
            .receipt-barcode {
                text-align: center;
            }
            .receipt-barcode svg {
                max-width: 100%;
                height: 40px;
                margin-top: 5px;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            .receipt-recommended-discounts .discount-item {
                text-align: center;
                margin-bottom: 8px;
            }
            .receipt-recommended-discounts .discount-item p {
                margin-bottom: 2px;
                font-size: 0.9em;
                font-weight: bold;
            }
            .receipt-recommended-discounts .discount-item svg {
                max-width: 90%;
                height: 35px;
                margin-top: 2px;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            .receipt-footer {
                text-align: center;
                font-size: 1em;
                margin-top: 10mm;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="bg-blue-800 text-white p-4 shadow-md">
        <h1 class="text-3xl font-bold text-center">Advanced POS System</h1>
    </header>

    <main class="flex flex-1 flex-col p-4 gap-4 max-w-7xl mx-auto w-full">
        <!-- Tabs Navigation -->
        <div class="flex tab-buttons-container mb-4">
            <button class="tab-button active" data-tab="sales">Sales Terminal</button>
            <button class="tab-button" data-tab="products">Product & Coupon Management</button>
            <button class="tab-button" data-tab="receipts">Receipts History</button>
            <button class="tab-button" data-tab="reports">Reports</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </div>

        <!-- Tab Content Containers -->
        <!-- Sales Terminal Tab -->
        <section id="sales-tab-content" class="tab-content active flex-col flex-1 rounded-xl shadow-lg border border-blue-600">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">Sales Terminal</h2>

            <!-- Barcode Scanner Input -->
            <div class="mb-4">
                <label for="barcode-scanner-input" class="block text-sm font-medium text-gray-300 mb-1">Scan Barcode / Enter Product Barcode</label>
                <input type="text" id="barcode-scanner-input" placeholder="Scan barcode or type product barcode and press Enter"
                       class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400" autofocus>
            </div>

            <!-- Custom Price Input -->
            <div class="mb-4 pt-4 border-t border-gray-700">
                <h3 class="text-xl font-medium mb-3 text-gray-200">Add Custom Priced Item</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="custom-item-description" class="block text-sm font-medium text-gray-300">Description (Optional)</label>
                        <input type="text" id="custom-item-description" placeholder="e.g., Custom Service Fee"
                               class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
                    </div>
                    <div>
                        <label for="custom-item-price" class="block text-sm font-medium text-gray-300">Price ($)</label>
                        <input type="number" id="custom-item-price" step="0.01" placeholder="e.g., 9.99" required
                               class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
                    </div>
                </div>
                <button id="add-custom-item-button"
                        class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Add Custom Item
                </button>
            </div>

            <!-- Cart Display -->
            <div class="flex-1 overflow-auto mb-4 border border-gray-600 rounded-lg">
                <table class="min-w-full divide-y divide-gray-600">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Product</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Price</th>
                             <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cart-items" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Cart items will be dynamically added here -->
                    </tbody>
                </table>
            </div>

            <!-- Coupon Input -->
            <div class="mb-4 pt-4 border-t border-gray-700">
                <h3 class="text-xl font-medium mb-3 text-gray-200">Apply Coupon</h3>
                <div class="flex gap-2">
                    <input type="text" id="coupon-code-input" placeholder="Enter coupon code"
                           class="flex-1 p-3 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500 placeholder-gray-400">
                    <button id="apply-coupon-button"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Apply
                    </button>
                </div>
                <p id="coupon-status" class="mt-2 text-sm text-gray-400"></p>
            </div>

            <!-- Totals and Checkout -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                <div class="flex justify-between items-center text-lg font-bold text-gray-100 mb-2">
                    <span>Subtotal:</span>
                    <span id="subtotal-display">$0.00</span>
                </div>
                 <div id="discount-display-row" class="flex justify-between items-center text-lg font-bold text-red-400 mb-2 hidden">
                    <span>Discount:</span>
                    <span id="discount-display">-$0.00</span>
                </div>
                <div id="tax-display-row" class="flex justify-between items-center text-lg font-bold text-gray-100 mb-2">
                    <span>Tax (<span id="tax-rate-display">8.00</span>%):</span>
                    <span id="tax-display">$0.00</span>
                </div>
                <div class="flex justify-between items-center text-xl font-bold text-gray-100">
                    <span>Grand Total:</span>
                    <span id="grand-total-display" class="text-blue-400">$0.00</span>
                </div>
                <button id="checkout-button"
                        class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-300 ease-in-out">
                    Checkout & Print Receipt
                </button>
            </div>
        </section>

        <!-- Product & Coupon Management Tab -->
        <section id="products-tab-content" class="tab-content hidden flex-col flex-1 rounded-xl shadow-lg border border-purple-600">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">Product & Coupon Management</h2>

            <!-- Product Management Section -->
            <div class="mb-8 border-b pb-4 border-gray-700">
                <h3 class="text-xl font-medium mb-3 text-gray-200">Manage Products</h3>
                <!-- Add Product Form -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-2 text-gray-300">Add New Product</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-product-barcode" class="block text-sm font-medium text-gray-300">Product Barcode (Unique)</label>
                            <input type="text" id="new-product-barcode" required placeholder="e.g., 1234567890"
                                   class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400">
                        </div>
                        <div>
                            <label for="new-product-name" class="block text-sm font-medium text-gray-300">Product Name</label>
                            <input type="text" id="new-product-name" required placeholder="e.g., Laptop"
                                   class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400">
                        </div>
                        <div>
                            <label for="new-product-price" class="block text-sm font-medium text-gray-300">Price ($)</label>
                            <input type="number" id="new-product-price" step="0.01" required placeholder="e.g., 1200.00"
                                   class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400">
                        </div>
                    </div>
                    <button id="add-product-button"
                            class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Add Product
                    </button>
                </div>

                <!-- Existing Products List -->
                <div>
                    <h4 class="text-lg font-medium mb-3 text-gray-300">Existing Products</h4>
                    <div class="overflow-y-auto max-h-80 border border-gray-600 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Barcode</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Price</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="product-list" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Products will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Coupon Management Section -->
            <div>
                <h3 class="text-xl font-medium mb-3 text-gray-200">Manage Coupons</h3>
                <!-- Add Coupon Form -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-2 text-gray-300">Add New Coupon</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-coupon-code" class="block text-sm font-medium text-gray-300">Coupon Code (Auto-Generated)</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-coupon-code" readonly
                                    class="flex-1 p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500 placeholder-gray-400">
                                <button id="generate-coupon-code-button"
                                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 ease-in-out text-sm">
                                    Generate
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="new-coupon-title" class="block text-sm font-medium text-gray-300">Coupon Title (For Receipt)</label>
                            <input type="text" id="new-coupon-title" required placeholder="e.g., 10% Off Your Next Order"
                                   class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500 placeholder-gray-400">
                        </div>
                        <div>
                            <label for="new-coupon-application-type" class="block text-sm font-medium text-gray-300">Application Type</label>
                            <select id="new-coupon-application-type"
                                    class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="full-total">Full Total</option>
                                <option value="min-purchase">Minimum Purchase</option>
                                <option value="by-product">By Product</option>
                            </select>
                        </div>
                         <div id="min-purchase-amount-div" class="hidden">
                            <label for="new-coupon-min-purchase-amount" class="block text-sm font-medium text-gray-300">Minimum Purchase Amount ($)</label>
                            <input type="number" id="new-coupon-min-purchase-amount" step="0.01" placeholder="e.g., 50.00"
                                   class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500 placeholder-gray-400">
                        </div>
                        <div id="target-product-barcode-div" class="hidden">
                            <label for="new-coupon-target-product-barcode" class="block text-sm font-medium text-gray-300">Target Product Barcode</label>
                            <input type="text" id="new-coupon-target-product-barcode" placeholder="e.g., 1000000001"
                                   class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500 placeholder-gray-400">
                        </div>
                        <div>
                            <label for="new-coupon-type" class="block text-sm font-medium text-gray-300">Discount Type</label>
                            <select id="new-coupon-type"
                                    class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed">Fixed Amount ($)</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-coupon-value" class="block text-sm font-medium text-gray-300">Discount Value</label>
                            <input type="number" id="new-coupon-value" step="0.01" required placeholder="e.g., 10 (for 10% or $10)"
                                   class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500 placeholder-gray-400">
                        </div>
                    </div>
                    <button id="add-coupon-button"
                            class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Add Coupon
                    </button>
                </div>

                <!-- Existing Coupons List -->
                <div>
                    <h4 class="text-lg font-medium mb-3 text-gray-300">Existing Coupons</h4>
                    <div class="overflow-y-auto max-h-80 border border-gray-600 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">App Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Disc. Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Value</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="coupon-list" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Coupons will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Receipts History Tab -->
        <section id="receipts-tab-content" class="tab-content hidden flex-col flex-1 rounded-xl shadow-lg border border-green-600">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">Receipts History</h2>
            <div class="mb-4">
                <label for="receipt-search-input" class="block text-sm font-medium text-gray-300 mb-1">Search Receipts (Transaction ID, Date/Time)</label>
                <input type="text" id="receipt-search-input" placeholder="e.g., TXN-123, 2025-06-17"
                       class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
            </div>
            <div id="receipts-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto max-h-screen">
                <!-- Receipts will be dynamically loaded here -->
                <p id="no-receipts-message" class="col-span-full text-center text-gray-400">No receipts yet. Complete a sale to see receipts here.</p>
            </div>
             <!-- Modal for viewing historical receipt -->
            <div id="historical-receipt-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative border border-gray-700">
                    <button id="close-historical-receipt-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-100 text-3xl font-bold" aria-label="Close">&times;</button>
                    <div id="historical-receipt-content" class="text-gray-100">
                        <!-- Historical receipt details will be loaded here -->
                    </div>
                     <button id="print-historical-receipt"
                            class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-300 ease-in-out">
                        Print This Receipt
                    </button>
                    <button id="return-items-button"
                            class="w-full mt-2 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-300 ease-in-out">
                        Return Items
                    </button>
                </div>
            </div>
        </section>

        <!-- Reports Tab -->
        <section id="reports-tab-content" class="tab-content hidden flex-col flex-1 rounded-xl shadow-lg border border-teal-600">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">Sales Reports</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-700 p-6 rounded-lg shadow-md flex flex-col justify-between items-center text-center">
                    <h3 class="text-xl font-semibold text-gray-200 mb-2">Last Hour Sales</h3>
                    <p id="report-last-hour" class="text-4xl font-bold text-teal-400">$0.00</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-lg shadow-md flex flex-col justify-between items-center text-center">
                    <h3 class="text-xl font-semibold text-gray-200 mb-2">Last 24 Hours Sales</h3>
                    <p id="report-last-24-hours" class="text-4xl font-bold text-teal-400">$0.00</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-lg shadow-md flex flex-col justify-between items-center text-center">
                    <h3 class="text-xl font-semibold text-gray-200 mb-2">Last 30 Days Sales</h3>
                    <p id="report-last-month" class="text-4xl font-bold text-teal-400">$0.00</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-lg shadow-md flex flex-col justify-between items-center text-center">
                    <h3 class="text-xl font-semibold text-gray-200 mb-2">All Time Sales</h3>
                    <p id="report-total-sales" class="text-4xl font-bold text-teal-400">$0.00</p>
                </div>
            </div>
        </section>

        <!-- Settings Tab -->
        <section id="settings-tab-content" class="tab-content hidden flex-col flex-1 rounded-xl shadow-lg border border-yellow-600">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">Settings</h2>

            <!-- Store Information -->
            <div class="mb-6 border-b pb-4 border-gray-700">
                <h3 class="text-xl font-medium mb-3 text-gray-200">Store Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="store-name" class="block text-sm font-medium text-gray-300">Store Name</label>
                        <input type="text" id="store-name" placeholder="e.g., My Awesome Store"
                               class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
                    </div>
                    <div>
                        <label for="store-address" class="block text-sm font-medium text-gray-300">Store Address</label>
                        <input type="text" id="store-address" placeholder="e.g., 123 Main St, Anytown"
                               class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
                    </div>
                     <div>
                        <label for="store-phone" class="block text-sm font-medium text-gray-300">Phone Number</label>
                        <input type="tel" id="store-phone" placeholder="e.g., (123) 456-7890"
                               class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
                    </div>
                    <div>
                        <label for="store-website" class="block text-sm font-medium text-gray-300">Website/Email</label>
                        <input type="text" id="store-website" placeholder="e.g., www.mystore.com or info@mystore.com"
                               class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="receipt-footer-message" class="block text-sm font-medium text-gray-300">Receipt Footer Message</label>
                    <textarea id="receipt-footer-message" rows="3" placeholder="e.g., Thank you for your purchase! Please come again!"
                              class="mt-1 block w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400"></textarea>
                </div>
            </div>

            <!-- Store Logo Upload -->
            <div class="mb-6 pb-4">
                <h3 class="text-xl font-medium mb-3 text-gray-200">Store Logo</h3>
                <label for="logo-file-input" class="block text-sm font-medium text-gray-300 mb-1">Upload Logo Image:</label>
                <input type="file" id="logo-file-input" accept="image/*" class="hidden">
                <button id="upload-logo-button"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Upload Logo
                </button>
                <p class="text-sm text-gray-400 mt-2">Upload an image file. Max size 500KB recommended for receipts.</p>
                <div class="mt-4">
                    <p class="text-gray-300">Current Logo Preview:</p>
                    <img id="current-logo-preview" src="" alt="Current Logo" class="max-w-[150px] mt-2 rounded-lg shadow-md">
                </div>
                <button id="save-settings-button"
                        class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Save All Settings
                </button>
            </div>
        </section>

    </main>

    <!-- Receipt Print Area (hidden by default, used for both current and historical printing) -->
    <div id="receipt-print-area" class="hidden fixed top-0 left-0 w-full h-full bg-white z-50 p-4 overflow-auto">
        <!-- Receipt content will be dynamically generated here for printing -->
    </div>

    <!-- Message Box for user feedback -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-700">
            <p id="message-content" class="text-lg font-medium text-gray-100 mb-4"></p>
            <button id="message-ok-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out">OK</button>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="payment-method-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-700">
            <p class="text-lg font-medium text-gray-100 mb-6">Select Payment Method:</p>
            <div class="flex justify-around gap-4">
                <button id="pay-cash-button"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Cash
                </button>
                <button id="pay-card-button"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Card
                </button>
            </div>
        </div>
    </div>

    <!-- Keyboard Instructions Modal -->
    <div id="keyboard-instructions-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative border border-gray-700">
            <button id="close-keyboard-instructions-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-100 text-3xl font-bold" aria-label="Close">&times;</button>
            <h3 class="text-2xl font-bold text-gray-100 mb-4 text-center">Keyboard Navigation Guide</h3>
            <div class="text-gray-200 text-left space-y-3 text-base">
                <p><strong>General:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>Use '<kbd>Tab</kbd>' and '<kbd>Shift</kbd> + <kbd>Tab</kbd>' to move focus between interactive elements.</li>
                    <li>Press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>' to activate a focused button, link, or confirm an action.</li>
                    <li>Press '<kbd>Escape</kbd>' to close any open modals (e.g., Message Box, Payment, Receipt Details, this Guide).</li>
                </ul>

                <p><strong>Main Tabs:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>When a tab button (<span class="font-semibold">Sales Terminal</span>, <span class="font-semibold">Product & Coupon Management</span>, etc.) is focused, use '<kbd>Left Arrow</kbd>' and '<kbd>Right Arrow</kbd>' keys to switch between tabs.</li>
                </ul>

                <p><strong>Sales Terminal:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li><span class="font-semibold">Barcode Input:</span> Type barcode, then press '<kbd>Enter</kbd>' to add the item to the cart.</li>
                    <li><span class="font-semibold">Custom Item Price:</span> Enter price, press '<kbd>Enter</kbd>' or '<kbd>Tab</kbd>' to 'Add Custom Item' button then '<kbd>Enter</kbd>' / '<kbd>Space</kbd>'.</li>
                    <li><span class="font-semibold">Cart Items:</span> Navigate quantity adjustment buttons ('<kbd>+</kbd>', '<kbd>-</kbd>') and 'Remove' buttons using '<kbd>Tab</kbd>'. Press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>' to activate.</li>
                    <li><span class="font-semibold">Coupon Input:</span> Type coupon code. Press '<kbd>Enter</kbd>' while the input is focused, or '<kbd>Tab</kbd>' to the 'Apply' button and press '<kbd>Enter</kbd>'/<kbd>Space</kbd>'.</li>
                    <li><span class="font-semibold">Checkout Button:</span> Press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>'.</li>
                </ul>

                <p><strong>Payment Method Dialog:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>Use '<kbd>Tab</kbd>' to switch between 'Cash' and 'Card' buttons.</li>
                    <li>Press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>' on your desired payment selection.</li>
                    <li>Press '<kbd>Escape</kbd>' to cancel payment and return to the sales terminal.</li>
                </ul>

                <p><strong>Product & Coupon Management:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>Navigate all input fields and buttons with '<kbd>Tab</kbd>'.</li>
                    <li>Press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>' on a focused 'Add Product', 'Generate', or 'Add Coupon' button.</li>
                    <li>For product/coupon lists, tab through rows; use '<kbd>Enter</kbd>'/'<kbd>Space</kbd>' on 'Add to Cart' or 'Delete' buttons.</li>
                </ul>

                <p><strong>Receipts History:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li><span class="font-semibold">Search Input:</span> Type to filter receipts; the list updates automatically.</li>
                    <li><span class="font-semibold">Receipt Cards:</span> Tab to 'View Details' button, then press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>'.</li>
                </ul>

                <p><strong>Historical Receipt Details (Modal):</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>Use '<kbd>Tab</kbd>' to navigate the 'Print This Receipt' and 'Return Items' buttons.</li>
                    <li>Press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>' on your selection.</li>
                    <li>Press '<kbd>Escape</kbd>' to close this modal.</li>
                </ul>

                <p><strong>Return Items Dialog:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>Use '<kbd>Tab</kbd>' to navigate input fields and buttons.</li>
                    <li>Use '<kbd>Arrow Up</kbd>' and '<kbd>Arrow Down</kbd>' on number inputs to adjust quantity.</li>
                    <li>Press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>' on 'Process Return & Print' or 'Cancel Return' buttons.</li>
                    <li>Press '<kbd>Escape</kbd>' to close this modal.</li>
                </ul>

                <p><strong>Reports:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>This section provides a summary of sales performance. No direct interaction is needed here via keyboard, as it's a display only. You can navigate the tab itself.</li>
                </ul>

                <p><strong>Settings:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    <li>Navigate input fields and buttons with '<kbd>Tab</kbd>'.</li>
                    <li>Press '<kbd>Enter</kbd>' or '<kbd>Space</kbd>' on focused 'Upload Logo' or 'Save All Settings' buttons.</li>
                </ul>

                <p class="mt-4 text-center"><strong>Special Hotkey:</strong></p>
                <p class="text-center text-xl font-bold text-blue-400">Press '<kbd>Ctrl</kbd> + <kbd>I</kbd>' to show this guide.</p>
            </div>
            <button id="keyboard-instructions-ok-button" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-300 ease-in-out">
                Got It!
            </button>
        </div>
    </div>

    <!-- Return Items Modal -->
    <div id="return-items-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative border border-gray-700">
            <button id="close-return-items-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-100 text-3xl font-bold" aria-label="Close">&times;</button>
            <h3 class="text-2xl font-bold text-gray-100 mb-4 text-center">Return Items from Receipt <span id="return-original-txn-id"></span></h3>

            <div class="mb-4">
                <p class="text-sm text-gray-300 mb-2">Original Purchase Date: <span id="return-original-purchase-date"></span></p>
                <p class="text-sm text-gray-300 mb-2">Original Total: <span id="return-original-total" class="font-bold"></span></p>
                <p class="text-sm text-gray-300 mb-2">Original Discount: <span id="return-original-discount" class="font-bold text-red-400"></span></p>
            </div>

            <div class="flex-1 overflow-auto mb-4 border border-gray-600 rounded-lg">
                <table class="min-w-full divide-y divide-gray-600">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Item</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Price (Paid)</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Qty Purchased</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Qty Return</th>
                        </tr>
                    </thead>
                    <tbody id="return-items-list" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Returnable items will be dynamically added here -->
                    </tbody>
                </table>
            </div>

            <div class="mt-auto pt-4 border-t border-gray-700">
                <div class="flex justify-between items-center text-lg font-bold text-gray-100 mb-2">
                    <span>Estimated Refund Subtotal:</span>
                    <span id="estimated-refund-subtotal">$0.00</span>
                </div>
                <div class="flex justify-between items-center text-lg font-bold text-red-400 mb-2">
                    <span>Prorated Original Discount:</span>
                    <span id="prorated-original-discount">-$0.00</span>
                </div>
                <!-- Tax is calculated but not explicitly shown in this summary for the user to give back -->
                <div class="flex justify-between items-center text-xl font-bold text-gray-100">
                    <span>Total Refund Due (Pre-Tax):</span>
                    <span id="total-refund-amount" class="text-green-400">$0.00</span>
                </div>
                <button id="process-return-button"
                        class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-300 ease-in-out">
                    Process Return & Print
                </button>
                <button id="cancel-return-button"
                        class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-300 ease-in-out">
                    Cancel Return
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Local Storage Keys (Constants) ---
        const LOCAL_STORAGE_KEYS = {
            PRODUCTS: 'pos_products',
            COUPONS: 'pos_coupons',
            RECEIPTS: 'pos_receipts',
            SETTINGS: 'pos_settings'
        };

        // Global variables for products, cart, receipts, coupons and store settings
        let products = [];
        let cart = []; // Cart items will store barcode, name, price, quantity, subtotal
        let receipts = [];
        let coupons = [];
        let appliedCoupon = null; // Stores the currently applied coupon for the transaction
        const TAX_RATE = 0.08; // 8% tax rate
        const NUM_RECOMMENDED_COUPONS_TO_DISPLAY = 5; // Exactly 5 recommended coupons

        let storeSettings = {
            storeName: 'Your Store Name',
            storeAddress: '123 Main St, Anytown, USA',
            storePhone: '(123) 456-7890',
            storeWebsite: 'www.yourstore.com',
            logoUrl: 'https://placehold.co/150x50/1e40af/ffffff?text=Your+Logo', // Default placeholder logo
            receiptFooterMessage: 'Thank you for your purchase! Please come again!' // New default footer message
        };

        // Variables for return functionality
        let currentReceiptForReturn = null; // Stores the receipt object being returned from
        let itemsToReturnQuantities = {}; // Stores {barcode: quantity_to_return}

        // --- DOM Elements ---
        // Tab Navigation
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Sales Terminal
        const barcodeScannerInput = document.getElementById('barcode-scanner-input');
        const customItemDescriptionInput = document.getElementById('custom-item-description'); // New custom item description
        const customItemPriceInput = document.getElementById('custom-item-price');           // New custom item price
        const addCustomItemButton = document.getElementById('add-custom-item-button');       // New add custom item button

        const cartItemsBody = document.getElementById('cart-items');
        const subtotalDisplay = document.getElementById('subtotal-display');
        const grandTotalDisplay = document.getElementById('grand-total-display');
        const discountDisplayRow = document.getElementById('discount-display-row');
        const discountDisplay = document.getElementById('discount-display');
        const taxRateDisplay = document.getElementById('tax-rate-display'); // For displaying the tax rate
        const taxDisplay = document.getElementById('tax-display'); // For displaying the calculated tax
        const checkoutButton = document.getElementById('checkout-button');
        const couponCodeInput = document.getElementById('coupon-code-input');
        const applyCouponButton = document.getElementById('apply-coupon-button');
        const couponStatus = document.getElementById('coupon-status');

        // Product Management
        const newProductBarcodeInput = document.getElementById('new-product-barcode');
        const newProductNameInput = document.getElementById('new-product-name');
        const newProductPriceInput = document.getElementById('new-product-price');
        const addProductButton = document.getElementById('add-product-button');
        const productListBody = document.getElementById('product-list');

        // Coupon Management
        const newCouponCodeInput = document.getElementById('new-coupon-code');
        const generateCouponCodeButton = document.getElementById('generate-coupon-code-button'); // New button
        const newCouponTitleInput = document.getElementById('new-coupon-title');
        const newCouponApplicationTypeSelect = document.getElementById('new-coupon-application-type'); // New application type select
        const minPurchaseAmountDiv = document.getElementById('min-purchase-amount-div');
        const newCouponMinPurchaseAmountInput = document.getElementById('new-coupon-min-purchase-amount');
        const targetProductBarcodeDiv = document.getElementById('target-product-barcode-div');
        const newCouponTargetProductBarcodeInput = document.getElementById('new-coupon-target-product-barcode');
        const newCouponTypeSelect = document.getElementById('new-coupon-type');
        const newCouponValueInput = document.getElementById('new-coupon-value');
        const addCouponButton = document.getElementById('add-coupon-button');
        const couponListBody = document.getElementById('coupon-list');

        // Receipts History
        const receiptsListDiv = document.getElementById('receipts-list');
        const noReceiptsMessage = document.getElementById('no-receipts-message');
        const receiptSearchInput = document.getElementById('receipt-search-input'); // New search input
        const historicalReceiptModal = document.getElementById('historical-receipt-modal');
        const historicalReceiptContent = document.getElementById('historical-receipt-content');
        const closeHistoricalReceiptModalBtn = document.getElementById('close-historical-receipt-modal');
        const printHistoricalReceiptBtn = document.getElementById('print-historical-receipt');
        const returnItemsButton = document.getElementById('return-items-button'); // New Return Items button

        // Reports
        const reportLastHourSpan = document.getElementById('report-last-hour');
        const reportLast24HoursSpan = document.getElementById('report-last-24-hours');
        const reportLastMonthSpan = document.getElementById('report-last-month'); // renamed from report-last-30-days
        const reportTotalSalesSpan = document.getElementById('report-total-sales');


        // Settings
        const storeNameInput = document.getElementById('store-name');
        const storeAddressInput = document.getElementById('store-address');
        const storePhoneInput = document.getElementById('store-phone');
        const storeWebsiteInput = document.getElementById('store-website');
        const receiptFooterMessageInput = document.getElementById('receipt-footer-message'); // New footer message input
        const logoFileInput = document.getElementById('logo-file-input'); // File input for logo
        const uploadLogoButton = document.getElementById('upload-logo-button'); // Button to trigger file input
        const currentLogoPreview = document.getElementById('current-logo-preview');
        const saveSettingsButton = document.getElementById('save-settings-button');

        // Global Utility
        const receiptPrintArea = document.getElementById('receipt-print-area');
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const messageOkButton = document.getElementById('message-ok-button');

        // Payment Method Modal
        const paymentMethodModal = document.getElementById('payment-method-modal');
        const payCashButton = document.getElementById('pay-cash-button');
        const payCardButton = document.getElementById('pay-card-button');

        // Keyboard Instructions Modal
        const keyboardInstructionsModal = document.getElementById('keyboard-instructions-modal');
        const closeKeyboardInstructionsModalBtn = document.getElementById('close-keyboard-instructions-modal');
        const keyboardInstructionsOkButton = document.getElementById('keyboard-instructions-ok-button');

        // Return Items Modal
        const returnItemsModal = document.getElementById('return-items-modal');
        const closeReturnItemsModalBtn = document.getElementById('close-return-items-modal');
        const returnOriginalTxnIdSpan = document.getElementById('return-original-txn-id');
        const returnOriginalPurchaseDateSpan = document.getElementById('return-original-purchase-date');
        const returnOriginalTotalSpan = document.getElementById('return-original-total');
        const returnOriginalDiscountSpan = document.getElementById('return-original-discount');
        const returnItemsListBody = document.getElementById('return-items-list');
        const estimatedRefundSubtotalSpan = document.getElementById('estimated-refund-subtotal');
        const proratedOriginalDiscountSpan = document.getElementById('prorated-original-discount');
        const refundTaxAmountSpan = document.getElementById('refund-tax-amount'); // Kept for internal calculation/return receipt only
        const totalRefundAmountSpan = document.getElementById('total-refund-amount'); // Now shows pre-tax refund
        const processReturnButton = document.getElementById('process-return-button');
        const cancelReturnButton = document.getElementById('cancel-return-button');


        let lastFocusedElement = null; // To store the element that had focus before a modal opened

        // --- Local Storage Functions ---

        /**
         * Saves current state of data (products, coupons, receipts, settings) to local storage.
         */
        function saveData() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                localStorage.setItem(LOCAL_STORAGE_KEYS.COUPONS, JSON.stringify(coupons));
                localStorage.setItem(LOCAL_STORAGE_KEYS.RECEIPTS, JSON.stringify(receipts));
                localStorage.setItem(LOCAL_STORAGE_KEYS.SETTINGS, JSON.stringify(storeSettings));
            } catch (e) {
                console.error("Error saving to local storage:", e);
                // showMessageBox("Error: Could not save data to your browser. Please check storage limits or browser settings."); // Removed per user request
            }
        }

        /**
         * Loads data from local storage into global variables. Adds sample data if storage is empty.
         */
        function loadData() {
            try {
                const storedProducts = localStorage.getItem(LOCAL_STORAGE_KEYS.PRODUCTS);
                if (storedProducts) {
                    products = JSON.parse(storedProducts);
                } else {
                    addSampleProducts();
                }

                const storedCoupons = localStorage.getItem(LOCAL_STORAGE_KEYS.COUPONS);
                if (storedCoupons) {
                    // Important: Ensure old coupon data without new fields get defaults
                    coupons = JSON.parse(storedCoupons).map(coupon => ({
                        ...coupon,
                        title: coupon.title || `${coupon.type === 'percentage' ? coupon.value + '%' : '$' + coupon.value.toFixed(2)} Off`,
                        applicationType: coupon.applicationType || 'full-total', // Default for old coupons
                        minPurchaseAmount: coupon.minPurchaseAmount || 0, // Default to 0
                        targetProductBarcode: coupon.targetProductBarcode || '' // Default to empty string
                    }));
                } else {
                    addSampleCoupons();
                }

                const storedReceipts = localStorage.getItem(LOCAL_STORAGE_KEYS.RECEIPTS);
                if (storedReceipts) {
                    // Ensure historical receipts have recommendedDiscounts array, even if empty, for consistent handling
                    // Also ensure paymentMethod is present, defaulting for old receipts
                    receipts = JSON.parse(storedReceipts).map(receipt => ({
                        ...receipt,
                        recommendedDiscounts: receipt.recommendedDiscounts || [], // Default to empty array for old receipts
                        paymentMethod: receipt.paymentMethod || 'Unknown' // Default to 'Unknown' for old receipts
                    }));
                }

                const storedSettings = localStorage.getItem(LOCAL_STORAGE_KEYS.SETTINGS);
                if (storedSettings) {
                    // Merge loaded settings with default, so new properties in defaults don't break old data
                    storeSettings = { ...storeSettings, ...JSON.parse(storedSettings) };
                }
            } catch (e) {
                console.error("Error loading from local storage:", e);
                // showMessageBox("Error: Could not load saved data. Starting with fresh data. Please check storage limits or browser settings."); // Removed per user request
                // Reset to defaults if load fails
                products = [];
                coupons = [];
                receipts = [];
                storeSettings = {
                    storeName: 'Your Store Name', storeAddress: '123 Main St, Anytown, USA',
                    storePhone: '(123) 456-7890', storeWebsite: 'www.yourstore.com',
                    logoUrl: 'https://placehold.co/150x50/1e40af/ffffff?text=Your+Logo',
                    receiptFooterMessage: 'Thank you for your purchase! Please come again!'
                };
                addSampleProducts();
                addSampleCoupons();
            }
        }

        // --- Utility Functions ---

        /**
         * Displays a custom message box to the user.
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            lastFocusedElement = document.activeElement; // Store current focus
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');
            messageOkButton.focus(); // Focus the OK button
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
            if (lastFocusedElement) {
                lastFocusedElement.focus(); // Restore focus
                lastFocusedElement = null;
            }
        }

        /**
         * Displays the keyboard instructions modal.
         */
        function showKeyboardInstructions() {
            lastFocusedElement = document.activeElement; // Store current focus
            keyboardInstructionsModal.classList.remove('hidden');
            closeKeyboardInstructionsModalBtn.focus(); // Focus close button initially
        }

        /**
         * Hides the keyboard instructions modal.
         */
        function hideKeyboardInstructions() {
            keyboardInstructionsModal.classList.add('hidden');
            if (lastFocusedElement) {
                lastFocusedElement.focus(); // Restore focus
                lastFocusedElement = null;
            }
        }

        /**
         * Switches between tabs based on the clicked button.
         * @param {string} tabId - The ID of the tab content to show.
         */
        function switchTab(tabId) {
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                    button.setAttribute('aria-selected', 'true');
                    button.focus(); // Set focus to the activated tab button
                } else {
                    button.classList.remove('active');
                    button.setAttribute('aria-selected', 'false');
                }
                button.setAttribute('tabindex', '-1'); // Make inactive tabs unfocusable via Tab key
            });
            // Make the active tab button focusable via Tab key
            document.querySelector(`.tab-button.active`).setAttribute('tabindex', '0');


            tabContents.forEach(content => {
                // First, explicitly hide all tab contents by adding 'hidden'
                content.classList.add('hidden');
                content.classList.remove('active'); // Ensure active class is also removed for content
            });

            // Then, show only the selected tab content by removing 'hidden'
            const selectedTabContent = document.getElementById(`${tabId}-tab-content`);
            if (selectedTabContent) {
                selectedTabContent.classList.remove('hidden');
                selectedTabContent.classList.add('active'); // Add active class to content

                // Set initial focus for the active tab and update reports if applicable
                if (tabId === 'sales') {
                    barcodeScannerInput.focus();
                } else if (tabId === 'products') {
                    newProductBarcodeInput.focus();
                } else if (tabId === 'receipts') {
                    receiptSearchInput.focus();
                } else if (tabId === 'reports') {
                    updateReports(); // Refresh reports when tab is opened
                } else if (tabId === 'settings') {
                    storeNameInput.focus();
                }
            }
        }

        /**
         * Generates a random 9-digit number as a string.
         * @returns {string} A 9-digit number string.
         */
        function generateRandomBarcodeNumber() {
            // Generates a number between 100,000,000 and 999,999,999
            return Math.floor(100000000 + Math.random() * 900000000).toString();
        }

        /**
         * Generates a random 30-digit number as a string.
         * @returns {string} A 30-digit number string.
         */
        function generate30DigitCode() {
            let code = '';
            for (let i = 0; i < 30; i++) {
                code += Math.floor(Math.random() * 10); // Append a random digit (0-9)
            }
            return code;
        }

        // --- Product Management Functions ---

        /**
         * Adds initial sample products to the system.
         */
        function addSampleProducts() {
            // Using specific barcodes for samples
            products.push({ barcode: '1000000000', name: 'Laptop', price: 1200.00 });
            products.push({ barcode: '1000000001', name: 'Mouse', price: 25.00 });
            products.push({ barcode: '1000000002', name: 'Keyboard', price: 75.00 });
            products.push({ barcode: '1000000003', name: 'Monitor', price: 300.00 });
            products.push({ barcode: '1000000004', name: 'Coat', price: 12.99 }); // Added for return test case
            products.push({ barcode: '1000000005', name: 'Shirt', price: 10.00 }); // Added for single item return test case
        }

        /**
         * Adds a new product to the global products array.
         * Uses a custom barcode as its ID.
         * @param {string} barcode - The unique barcode for the product.
         * @param {string} name - The name of the product.
         * @param {number} price - The price of the product.
         * @returns {boolean} True if product was added, false if barcode exists.
         */
        function addProduct(barcode, name, price) {
            if (products.some(p => p.barcode === barcode)) {
                showMessageBox('Error: Product with this barcode already exists!');
                return false;
            }
            products.push({ barcode, name, price: parseFloat(price.toFixed(2)) });
            renderProductList();
            saveData(); // Save changes to local storage
            return true;
        }

        /**
         * Renders (or re-renders) the list of available products in the product management section.
         */
        function renderProductList() {
            productListBody.innerHTML = ''; // Clear existing list
            products.forEach(product => {
                const row = productListBody.insertRow();
                row.className = 'hover:bg-gray-700';
                row.insertCell().textContent = product.barcode;
                row.insertCell().textContent = product.name;
                row.insertCell().textContent = `$${product.price.toFixed(2)}`;
                const actionsCell = row.insertCell();
                actionsCell.className = 'flex gap-2 py-2';

                const addToCartButton = document.createElement('button');
                addToCartButton.textContent = 'Add to Cart';
                addToCartButton.className = 'bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-2 rounded-lg';
                addToCartButton.onclick = () => addProductToCart(product.barcode);
                addToCartButton.tabIndex = 0; // Ensure focusable
                actionsCell.appendChild(addToCartButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-2 rounded-lg';
                deleteButton.onclick = () => deleteProduct(product.barcode);
                deleteButton.tabIndex = 0; // Ensure focusable
                actionsCell.appendChild(deleteButton);
            });
        }

        /**
         * Deletes a product from the system.
         * @param {string} productBarcode - The barcode of the product to delete.
         */
        function deleteProduct(productBarcode) {
            products = products.filter(p => p.barcode !== productBarcode);
            renderProductList();
            cart = cart.filter(item => item.barcode !== productBarcode); // Also remove from cart
            updateCartDisplay();
            saveData(); // Save changes to local storage
            showMessageBox(`Product with barcode ${productBarcode} deleted.`);
        }

        // --- Coupon Management Functions ---

        /**
         * Adds initial sample coupons to the system.
         */
        function addSampleCoupons() {
            coupons.push({ code: generate30DigitCode(), title: '10% Off Your Next Order', applicationType: 'full-total', type: 'percentage', value: 10 });
            coupons.push({ code: generate30DigitCode(), title: '$5 Off Any Purchase', applicationType: 'full-total', type: 'fixed', value: 5 });
            coupons.push({ code: generate30DigitCode(), title: '$10 Off $50+ Purchase', applicationType: 'min-purchase', minPurchaseAmount: 50, type: 'fixed', value: 10 });
            coupons.push({ code: generate30DigitCode(), title: '20% Off when buying a Laptop', applicationType: 'by-product', targetProductBarcode: '1000000000', type: 'percentage', value: 20 });
            coupons.push({ code: generate30DigitCode(), title: 'Free Shipping Code', applicationType: 'full-total', type: 'fixed', value: 0 }); // Free shipping, could be handled separately
            coupons.push({ code: generate30DigitCode(), title: '20% Off Holiday Items', applicationType: 'full-total', type: 'percentage', value: 20 });
            // Add a few more to ensure we have enough for 5 recommendations consistently
            for (let i = 0; i < 5; i++) {
                coupons.push({ code: generate30DigitCode(), title: `Special Offer ${i + 1}`, applicationType: 'full-total', type: 'percentage', value: 5 + i });
            }
        }

        /**
         * Adds a new coupon to the global coupons array.
         * @param {Object} couponData - Object containing coupon details.
         * @returns {boolean} True if coupon was added, false if code exists.
         */
        function addCoupon(couponData) {
            if (coupons.some(c => c.code === couponData.code)) {
                showMessageBox('Error: Coupon with this code already exists!');
                return false;
            }
            coupons.push(couponData);
            renderCouponList();
            saveData(); // Save changes to local storage
            return true;
        }

        /**
         * Renders (or re-renders) the list of available coupons.
         */
        function renderCouponList() {
            couponListBody.innerHTML = ''; // Clear existing list
            coupons.forEach(coupon => {
                const row = couponListBody.insertRow();
                row.className = 'hover:bg-gray-700';
                row.insertCell().textContent = coupon.code;
                row.insertCell().textContent = coupon.title; // Display the custom title
                row.insertCell().textContent = coupon.applicationType.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); // Capitalize and space
                row.insertCell().textContent = coupon.type === 'percentage' ? 'Percentage' : 'Fixed Amount';
                row.insertCell().textContent = coupon.type === 'percentage' ? `${coupon.value}%` : `$${coupon.value.toFixed(2)}`;
                const actionsCell = row.insertCell();
                actionsCell.className = 'flex gap-2 py-2';

                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-2 rounded-lg';
                deleteButton.onclick = () => deleteCoupon(coupon.code);
                deleteButton.tabIndex = 0; // Ensure focusable
                actionsCell.appendChild(deleteButton);
            });
        }

        /**
         * Deletes a coupon from the system.
         * @param {string} couponCode - The code of the coupon to delete.
         */
        function deleteCoupon(couponCode) {
            coupons = coupons.filter(c => c.code !== couponCode);
            renderCouponList();
            // If the deleted coupon was applied, clear it
            if (appliedCoupon && appliedCoupon.code === couponCode) {
                appliedCoupon = null;
                couponCodeInput.value = '';
                couponStatus.textContent = '';
                updateCartDisplay();
            }
            saveData(); // Save changes to local storage
            showMessageBox(`Coupon ${couponCode} deleted.`);
        }

        // --- Sales Terminal Functions ---

        /**
         * Adds a product to the cart or updates its quantity if already present.
         * Uses product barcode for lookup.
         * @param {string} productBarcode - The barcode of the product to add.
         */
        function addProductToCart(productBarcode) {
            const product = products.find(p => p.barcode === productBarcode);
            if (!product) {
                showMessageBox(`Product with barcode "${productBarcode}" not found!`);
                return;
            }

            const existingCartItem = cart.find(item => item.barcode === productBarcode);
            if (existingCartItem) {
                existingCartItem.quantity++;
                existingCartItem.subtotal = existingCartItem.quantity * existingCartItem.price;
            } else {
                cart.push({
                    barcode: product.barcode,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    subtotal: product.price
                });
            }
            updateCartDisplay();
        }

        /**
         * Adds a custom item to the cart with a generated barcode.
         * @param {string} description - The description for the custom item.
         * @param {number} price - The price of the custom item.
         */
        function addCustomItemToCart(description, price) {
            const customBarcode = `CUSTOM-${Date.now()}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
            const itemName = description ? description : "Custom Item";

            cart.push({
                barcode: customBarcode,
                name: itemName,
                price: parseFloat(price.toFixed(2)),
                quantity: 1,
                subtotal: parseFloat(price.toFixed(2))
            });
            updateCartDisplay();
            customItemDescriptionInput.value = ''; // Clear description
            customItemPriceInput.value = ''; // Clear price
            customItemPriceInput.focus(); // Keep focus for next custom item
        }


        /**
         * Updates the quantity of an item in the cart.
         * @param {string} productBarcode - The barcode of the product.
         * @param {number} change - The amount to change the quantity by (e.g., 1 or -1).
         */
        function updateQuantity(productBarcode, change) {
            const itemIndex = cart.findIndex(item => item.barcode === productBarcode);
            if (itemIndex > -1) {
                cart[itemIndex].quantity += change;
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1); // Remove if quantity is 0 or less
                } else {
                    cart[itemIndex].subtotal = cart[itemIndex].quantity * cart[itemIndex].price;
                }
                updateCartDisplay();
            }
        }

        /**
         * Removes an item completely from the cart.
         * @param {string} productBarcode - The barcode of the product to remove.
         */
        function removeItemFromCart(productBarcode) {
            cart = cart.filter(item => item.barcode !== productBarcode);
            updateCartDisplay();
        }

        /**
         * Calculates the total cart value and updates the display, including discounts and tax.
         */
        function updateCartDisplay() {
            cartItemsBody.innerHTML = ''; // Clear existing items
            let currentSubtotal = 0;

            if (cart.length === 0) {
                const row = cartItemsBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3; // Adjusted colspan: Product, Price, Actions
                cell.textContent = 'Cart is empty.';
                cell.className = 'text-center py-4 text-gray-500';
            } else {
                cart.forEach(item => {
                    const row = cartItemsBody.insertRow();
                    row.className = 'hover:bg-gray-700';
                    row.insertCell().textContent = item.name;
                    row.insertCell().textContent = `$${item.price.toFixed(2)} x ${item.quantity}`; // Show quantity with price
                    row.cells[1].classList.add('text-right', 'pr-6'); // Add right alignment to price column

                    const actionsCell = row.insertCell();
                    actionsCell.className = 'flex gap-2 py-2';

                    const increaseBtn = document.createElement('button');
                    increaseBtn.textContent = '+';
                    increaseBtn.className = 'bg-gray-600 hover:bg-gray-500 text-gray-100 text-sm font-bold py-1 px-2 rounded-lg';
                    increaseBtn.onclick = () => updateQuantity(item.barcode, 1);
                    increaseBtn.tabIndex = 0; // Ensure focusable
                    actionsCell.appendChild(increaseBtn);

                    const decreaseBtn = document.createElement('button');
                    decreaseBtn.textContent = '-';
                    decreaseBtn.className = 'bg-gray-600 hover:bg-gray-500 text-gray-100 text-sm font-bold py-1 px-2 rounded-lg';
                    decreaseBtn.onclick = () => updateQuantity(item.barcode, -1);
                    decreaseBtn.tabIndex = 0; // Ensure focusable
                    actionsCell.appendChild(decreaseBtn);

                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Remove';
                    removeBtn.className = 'bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-2 rounded-lg';
                    removeBtn.onclick = () => removeItemFromCart(item.barcode);
                    removeBtn.tabIndex = 0; // Ensure focusable
                    actionsCell.appendChild(removeBtn);

                    currentSubtotal += item.subtotal;
                });
            }

            subtotalDisplay.textContent = `$${currentSubtotal.toFixed(2)}`;
            taxRateDisplay.textContent = `${(TAX_RATE * 100).toFixed(2)}`; // Display tax rate percentage

            let discountAmount = 0;
            let totalBeforeTax = currentSubtotal;

            if (appliedCoupon) {
                let canApply = true;
                let errorMessage = '';

                if (appliedCoupon.applicationType === 'min-purchase') {
                    if (currentSubtotal < appliedCoupon.minPurchaseAmount) {
                        canApply = false;
                        errorMessage = `Coupon requires a minimum purchase of $${appliedCoupon.minPurchaseAmount.toFixed(2)}. Current subtotal is $${currentSubtotal.toFixed(2)}.`;
                    }
                } else if (appliedCoupon.applicationType === 'by-product') {
                    if (!cart.some(item => item.barcode === appliedCoupon.targetProductBarcode)) {
                        canApply = false;
                        errorMessage = `Coupon requires product with barcode "${appliedCoupon.targetProductBarcode}" to be in cart.`;
                    }
                }

                if (canApply) {
                    if (appliedCoupon.type === 'percentage') {
                        discountAmount = totalBeforeTax * (appliedCoupon.value / 100);
                    } else if (appliedCoupon.type === 'fixed') {
                        discountAmount = appliedCoupon.value;
                    }
                    // Ensure discount doesn't make total negative
                    totalBeforeTax = Math.max(0, totalBeforeTax - discountAmount);

                    discountDisplay.textContent = `-$${discountAmount.toFixed(2)}`;
                    discountDisplayRow.classList.remove('hidden');
                    couponStatus.textContent = `Coupon "${appliedCoupon.code}" applied: ${appliedCoupon.title}.`;
                    couponStatus.classList.remove('text-red-400');
                    couponStatus.classList.add('text-green-400');
                } else {
                    appliedCoupon = null; // Clear if conditions not met
                    couponStatus.textContent = errorMessage;
                    couponStatus.classList.remove('text-green-400');
                    couponStatus.classList.add('text-red-400');
                    discountDisplayRow.classList.add('hidden'); // Hide discount if not applied
                }
            } else {
                discountDisplayRow.classList.add('hidden');
                couponCodeInput.value = ''; // Clear coupon input if no coupon is active
                couponStatus.textContent = '';
            }

            const taxAmount = totalBeforeTax * TAX_RATE;
            taxDisplay.textContent = `$${taxAmount.toFixed(2)}`;

            const finalTotal = totalBeforeTax + taxAmount;
            grandTotalDisplay.textContent = `$${finalTotal.toFixed(2)}`;
        }

        /**
         * Applies a coupon to the current transaction.
         */
        function applyCoupon() {
            const code = couponCodeInput.value.trim(); // No toUpperCase() as code is numeric
            if (!code) {
                appliedCoupon = null; // Clear if input is empty
                couponStatus.textContent = '';
                updateCartDisplay();
                return;
            }

            const coupon = coupons.find(c => c.code === code);
            if (coupon) {
                appliedCoupon = coupon; // Temporarily set to evaluate conditions
            } else {
                appliedCoupon = null; // Clear if not found
            }
            updateCartDisplay(); // This will re-evaluate and display status/error
        }

        // --- Receipt Generation & History Functions ---

        /**
         * Generates the HTML content for a receipt based on provided data.
         * This function is used by both `generateReceipt` (for current sale)
         * and `viewHistoricalReceipt` (for past sales).
         * @param {Object} receiptData - The data for the receipt.
         * @param {Array} receiptData.cartItems - Array of cart items for the receipt.
         * @param {number} receiptData.subtotal - The subtotal amount.
         * @param {number} receiptData.discountAmount - The discount amount applied.
         * @param {number} receiptData.totalAfterDiscount - Subtotal minus discount.
         * @param {number} receiptData.taxAmount - The tax amount.
         * @param {number} receiptData.finalTotal - The final total amount.
         * @param {string} receiptData.transactionId - The unique transaction ID.
         * @param {string} receiptData.timestamp - The timestamp of the transaction.
         * @param {Object} receiptData.storeInfo - Store information (name, address, etc.).
         * @param {string} receiptData.storeInfo.logoUrl - URL for the store logo.
         * @param {string} receiptData.storeInfo.receiptFooterMessage - Custom footer message for the receipt.
         * @param {Array<Object>} receiptData.recommendedDiscounts - List of recommended coupons to display.
         * @param {string} receiptData.paymentMethod - The payment method used (Cash/Card).
         * @param {boolean} forPrint - If true, generates content suitable for print.
         * @returns {string} HTML string of the receipt.
         */
        function generateReceiptHtml(receiptData, forPrint = true) {
            const { storeName, storeAddress, storePhone, storeWebsite, logoUrl, receiptFooterMessage } = receiptData.storeInfo;
            const recommendedDiscounts = receiptData.recommendedDiscounts; // Use the stored recommended discounts

            let receiptHtml = `
                <div class="receipt-container ${forPrint ? '' : 'bg-gray-800 text-gray-100 p-4 rounded-lg shadow-lg'}">
                    <div class="receipt-header text-center mb-6">
                        ${logoUrl ? `<img id="receipt-logo" src="${logoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/150x50/1e40af/ffffff?text=Logo+Not+Found';" alt="Store Logo">` : ''}
                        <h2>${storeName}</h2>
                        <p>${storeAddress}</p>
                        <p>${storePhone} | ${storeWebsite}</p>
                        <div class="dashed-line"></div>
                        <p>Date: ${new Date(receiptData.timestamp).toLocaleDateString()}</p>
                        <p>Time: ${new Date(receiptData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                        <p class="font-bold">Transaction ID: ${receiptData.transactionId}</p>
                        <div class="dashed-line"></div>
                    </div>

                    <table class="receipt-items w-full mb-6">
                        <thead>
                            <tr>
                                <th class="text-left">Item</th>
                                <th class="text-right">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

            receiptData.cartItems.forEach(item => {
                receiptHtml += `
                    <tr>
                        <td class="text-left">${item.name} x ${item.quantity}</td>
                        <td class="text-right">$${item.subtotal.toFixed(2)}</td>
                    </tr>
                `;
            });

            receiptHtml += `
                        </tbody>
                    </table>

                    <div class="dashed-line"></div>

                    <div class="receipt-totals mb-6">
                        <div>
                            <span>Subtotal:</span>
                            <span>$${receiptData.subtotal.toFixed(2)}</span>
                        </div>
                        ${receiptData.discountAmount > 0 ? `
                            <div class="text-red-600">
                                <span>Discount:</span>
                                <span>-$${receiptData.discountAmount.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div>
                            <span>Tax (${(TAX_RATE * 100).toFixed(2)}%):</span>
                            <span>$${receiptData.taxAmount.toFixed(2)}</span>
                        </div>
                        <h3 class="mt-2 pt-2 border-t-2 border-black">
                            <span>GRAND TOTAL:</span>
                            <span>$${receiptData.finalTotal.toFixed(2)}</span>
                        </h3>
                        <p class="text-right mt-2 font-bold">Payment: ${receiptData.paymentMethod}</p>
                    </div>

                    <div class="dashed-line"></div>

                    <div class="receipt-barcode text-center mb-6">
                        <p class="font-bold">Transaction Barcode:</p>
                        <svg id="receipt-transaction-barcode" class="w-full"></svg>
                    </div>

                    <div class="dashed-line"></div>

                    `;

            if (recommendedDiscounts && recommendedDiscounts.length > 0) {
                receiptHtml += `
                    <div class="receipt-recommended-discounts mb-6">
                        <h4>Recommended Discounts For You!</h4>
                `;
                recommendedDiscounts.forEach((coupon) => {
                    receiptHtml += `
                        <div class="discount-item mb-4">
                            <p>${coupon.title}</p>
                            <svg id="rec-barcode-${coupon.code}" class="w-full"></svg>
                        </div>
                    `;
                });
                receiptHtml += `</div><div class="dashed-line"></div>`;
            }

            // Footer (now uses editable message)
            receiptHtml += `
                <div class="receipt-footer text-center">
                    <p class="font-bold">${receiptFooterMessage}</p>
                </div>
                </div>
            `;

            return receiptHtml;
        }

        /**
         * Generates and prints the receipt for the current sale.
         * Also saves the receipt to history.
         * @param {string} paymentMethod - The method of payment (Cash or Card).
         */
        function generateReceipt(paymentMethod) {
            if (cart.length === 0) {
                // This check should ideally happen before the payment modal is even shown
                console.error("Attempted to generate receipt for empty cart.");
                return;
            }

            const transactionId = `TXN-${generateRandomBarcodeNumber()}`;
            const timestamp = new Date().toISOString();
            const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
            let discountAmount = 0;
            let totalBeforeTax = subtotal;

            // Re-evaluate discount conditions one last time before finalizing receipt data
            if (appliedCoupon) {
                let canApply = true;
                if (appliedCoupon.applicationType === 'min-purchase') {
                    if (subtotal < appliedCoupon.minPurchaseAmount) {
                        canApply = false;
                    }
                } else if (appliedCoupon.applicationType === 'by-product') {
                    if (!cart.some(item => item.barcode === appliedCoupon.targetProductBarcode)) {
                        canApply = false;
                    }
                }

                if (canApply) {
                    if (appliedCoupon.type === 'percentage') {
                        discountAmount = subtotal * (appliedCoupon.value / 100);
                    } else if (appliedCoupon.type === 'fixed') {
                        discountAmount = appliedCoupon.value;
                    }
                    totalBeforeTax = Math.max(0, totalBeforeTax - discountAmount);
                } else {
                    // If coupon became invalid during checkout, clear it for this receipt
                    appliedCoupon = null;
                    discountAmount = 0;
                }
            }

            const taxAmount = totalBeforeTax * TAX_RATE;
            const finalTotal = totalBeforeTax + taxAmount;

            // Select recommended discounts for THIS receipt
            const availableCouponsForReceipt = [...coupons];
            const recommendedDiscountsForThisReceipt = [];

            // Shuffle the available coupons
            for (let i = availableCouponsForReceipt.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableCouponsForReceipt[i], availableCouponsForReceipt[j]] = [availableCouponsForReceipt[j], availableCouponsForReceipt[i]];
            }

            // Pick exactly NUM_RECOMMENDED_COUPONS_TO_DISPLAY or all if fewer are available
            const numToPickForThisReceipt = Math.min(NUM_RECOMMENDED_COUPONS_TO_DISPLAY, availableCouponsForReceipt.length);
            for (let i = 0; i < numToPickForThisReceipt; i++) {
                recommendedDiscountsForThisReceipt.push(availableCouponsForReceipt[i]);
            }

            const receiptData = {
                cartItems: JSON.parse(JSON.stringify(cart)), // Deep copy cart items
                subtotal: subtotal,
                discountAmount: discountAmount,
                totalAfterDiscount: totalBeforeTax,
                taxAmount: taxAmount,
                finalTotal: finalTotal,
                transactionId: transactionId,
                timestamp: timestamp,
                storeInfo: { ...storeSettings }, // Deep copy store settings
                appliedCoupon: appliedCoupon ? { ...appliedCoupon } : null, // Copy applied coupon data
                recommendedDiscounts: recommendedDiscountsForThisReceipt, // Store selected recommended discounts
                paymentMethod: paymentMethod // Store payment method
            };

            // Add receipt to history
            receipts.unshift(receiptData); // Add to the beginning
            saveData(); // Save receipts to local storage
            renderReceiptsHistory(); // Update receipts history view

            // Generate HTML for printing
            receiptPrintArea.innerHTML = generateReceiptHtml(receiptData, true); // true for print-specific styles

            // Render JsBarcodes for the generated receipt HTML
            const transactionBarcodeElement = receiptPrintArea.querySelector('#receipt-transaction-barcode');
            if (transactionBarcodeElement) {
                try {
                    JsBarcode(transactionBarcodeElement, transactionId, {
                        format: "CODE128", // Explicitly Code-128
                        displayValue: true,
                        width: 1.5,
                        height: 50,
                        margin: 5,
                        fontSize: 12,
                        lineColor: "#000", // Ensure black lines for print
                        background: "#fff" // Ensure white background for print
                    });
                } catch (e) {
                    console.error(`Error generating transaction barcode (${transactionId}):`, e);
                    transactionBarcodeElement.textContent = `Code: ${transactionId}`;
                }
            }

            // Render JsBarcodes for recommended discounts on the generated receipt HTML
            if (receiptData.recommendedDiscounts && receiptData.recommendedDiscounts.length > 0) {
                receiptData.recommendedDiscounts.forEach((coupon) => {
                    const recBarcodeElement = receiptPrintArea.querySelector(`#rec-barcode-${coupon.code}`);
                    if (recBarcodeElement) {
                        try {
                            JsBarcode(recBarcodeElement, coupon.code, { // Use actual coupon code (30-digit)
                                format: "CODE128", // Explicitly Code-128
                                displayValue: true,
                                width: 1.5,
                                height: 50,
                                margin: 5,
                                fontSize: 12,
                                lineColor: "#000",
                                background: "#fff"
                            });
                        } catch (e) {
                            console.error(`Error generating recommendation barcode for ${coupon.code}:`, e);
                            recBarcodeElement.textContent = `Code: ${coupon.code}`; // Fallback text
                        }
                    }
                });
            }


            // Show receipt area and print
            receiptPrintArea.classList.remove('hidden');
            window.print();
            // Hide after print to restore normal view
            receiptPrintArea.classList.add('hidden');

            // Clear cart and applied coupon after successful transaction
            cart = [];
            appliedCoupon = null;
            couponCodeInput.value = '';
            couponStatus.textContent = '';
            updateCartDisplay();
            // Removed: showMessageBox('Sale completed and receipt printed!'); // Removed as per user request

            // IMPORTANT: Auto-focus on the barcode scanner input after printing
            barcodeScannerInput.focus();
        }

        /**
         * Renders the list of historical receipts in the Receipts tab.
         * @param {string} searchTerm - Optional search term to filter receipts.
         */
        function renderReceiptsHistory(searchTerm = '') {
            receiptsListDiv.innerHTML = ''; // Clear existing list
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();

            const filteredReceipts = receipts.filter(receipt => {
                const transactionMatch = receipt.transactionId.toLowerCase().includes(lowerCaseSearchTerm);
                const dateMatch = new Date(receipt.timestamp).toLocaleString().toLowerCase().includes(lowerCaseSearchTerm);
                return transactionMatch || dateMatch;
            });


            if (filteredReceipts.length === 0) {
                noReceiptsMessage.classList.remove('hidden');
                if (lowerCaseSearchTerm) {
                    noReceiptsMessage.textContent = `No receipts found for "${searchTerm}".`;
                } else {
                    noReceiptsMessage.textContent = 'No receipts yet. Complete a sale to see receipts here.';
                }
            } else {
                noReceiptsMessage.classList.add('hidden');
                filteredReceipts.forEach((receipt, index) => {
                    const receiptCard = document.createElement('div');
                    receiptCard.className = 'bg-gray-700 p-4 rounded-lg shadow-md flex flex-col justify-between';
                    receiptCard.innerHTML = `
                        <h4 class="text-lg font-bold text-gray-100 mb-2">Transaction: ${receipt.transactionId}</h4>
                        <p class="text-sm text-gray-300">Date: ${new Date(receipt.timestamp).toLocaleString()}</p>
                        ${receipt.discountAmount > 0 ? `<p class="text-sm text-red-400">Discount: -$${receipt.discountAmount.toFixed(2)}</p>` : ''}
                        <p class="text-xl font-semibold text-blue-400 mt-2">Total: $${receipt.finalTotal.toFixed(2)}</p>
                        <button class="view-receipt-details-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md mt-4 transition duration-300 ease-in-out"
                                data-receipt-index="${receipts.indexOf(receipt)}" tabindex="0">View Details</button>
                    `;
                    receiptsListDiv.appendChild(receiptCard);
                });

                // Attach event listeners to "View Details" buttons
                document.querySelectorAll('.view-receipt-details-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const index = event.target.dataset.receiptIndex;
                        lastFocusedElement = event.target; // Store the button that opened the modal
                        viewHistoricalReceipt(receipts[index]);
                    });
                });
            }
        }

        /**
         * Displays a historical receipt in a modal.
         * @param {Object} receiptData - The data of the historical receipt.
         */
        function viewHistoricalReceipt(receiptData) {
            currentReceiptForReturn = receiptData; // Set the global variable for return functionality

            // Generate HTML for modal display (not for print)
            historicalReceiptContent.innerHTML = generateReceiptHtml(receiptData, false);

            // Render JsBarcodes for the modal receipt HTML
            const transactionBarcodeElement = historicalReceiptContent.querySelector('#receipt-transaction-barcode');
            if (transactionBarcodeElement) {
                try {
                    JsBarcode(transactionBarcodeElement, receiptData.transactionId, {
                        format: "CODE128", // Explicitly Code-128
                        displayValue: true,
                        width: 1.5,
                        height: 50,
                        margin: 5,
                        fontSize: 12,
                        background: "transparent",
                        lineColor: "#f7fafc"
                    });
                } catch (e) {
                    console.error(`Error generating transaction barcode for modal (${receiptData.transactionId}):`, e);
                    transactionBarcodeElement.textContent = `Code: ${receiptData.transactionId}`;
                }
            }

            // Render JsBarcodes for recommended discounts on the modal receipt HTML
            if (receiptData.recommendedDiscounts && receiptData.recommendedDiscounts.length > 0) {
                receiptData.recommendedDiscounts.forEach((coupon) => {
                    const recBarcodeElement = historicalReceiptContent.querySelector(`#rec-barcode-${coupon.code}`);
                    if (recBarcodeElement) {
                        try {
                            JsBarcode(recBarcodeElement, coupon.code, { // Use actual coupon code (30-digit)
                                format: "CODE128", // Explicitly Code-128
                                displayValue: true,
                                width: 1.5,
                                height: 50,
                                margin: 5,
                                fontSize: 12,
                                background: "transparent",
                                lineColor: "#f7fafc"
                            });
                        } catch (e) {
                            console.error(`Error generating recommendation barcode for ${coupon.code} in modal:`, e);
                            recBarcodeElement.textContent = `Code: ${coupon.code}`; // Fallback text
                        }
                    }
                });
            }

            historicalReceiptModal.classList.remove('hidden');
            // Set initial focus inside the modal
            closeHistoricalReceiptModalBtn.focus();

            // Set up print button for the historical receipt modal
            printHistoricalReceiptBtn.onclick = () => {
                // Temporarily populate receipt print area for printing
                receiptPrintArea.innerHTML = generateReceiptHtml(receiptData, true); // Re-generate for print styles
                receiptPrintArea.classList.remove('hidden');
                historicalReceiptModal.classList.add('hidden'); // Hide modal while printing

                // Re-render JsBarcodes for print area (needed after innerHTML change)
                const printTransactionBarcodeElement = receiptPrintArea.querySelector('#receipt-transaction-barcode');
                if (printTransactionBarcodeElement) {
                     try {
                        JsBarcode(printTransactionBarcodeElement, receiptData.transactionId, { format: "CODE128", displayValue: true, width: 1.5, height: 50, margin: 5, fontSize: 12, lineColor: "#000", background: "#fff" });
                    } catch (e) { console.error(`Error generating print transaction barcode:`, e); printTransactionBarcodeElement.textContent = `Code: ${receiptData.transactionId}`; }
                }

                // Render recommended barcodes for print
                if (receiptData.recommendedDiscounts && receiptData.recommendedDiscounts.length > 0) {
                    receiptData.recommendedDiscounts.forEach((coupon) => {
                        const recBarcodeElement = receiptPrintArea.querySelector(`#rec-barcode-${coupon.code}`);
                        if (recBarcodeElement) {
                            try {
                                JsBarcode(recBarcodeElement, coupon.code, { format: "CODE128", displayValue: true, width: 1.5, height: 50, margin: 5, fontSize: 12, lineColor: "#000", background: "#fff" });
                            } catch (e) { console.error(`Error generating print rec barcode:`, e); recBarcodeElement.textContent = `Code: ${coupon.code}`; }
                        }
                    });
                }

                window.print();

                // Restore original state
                receiptPrintArea.classList.add('hidden');
                receiptPrintArea.innerHTML = '';
                historicalReceiptModal.classList.remove('hidden');
                if (lastFocusedElement) {
                    lastFocusedElement.focus(); // Restore focus after print
                }
            };
        }

        // --- Return Items Functions ---

        /**
         * Opens the return items modal for a specific receipt.
         * @param {Object} receiptData - The original receipt object.
         */
        function openReturnItemsModal(receiptData) {
            lastFocusedElement = document.activeElement; // Store current focus
            currentReceiptForReturn = receiptData;
            itemsToReturnQuantities = {}; // Reset return quantities

            // Populate modal header
            returnOriginalTxnIdSpan.textContent = receiptData.transactionId;
            returnOriginalPurchaseDateSpan.textContent = new Date(receiptData.timestamp).toLocaleString();
            returnOriginalTotalSpan.textContent = `$${receiptData.finalTotal.toFixed(2)}`;
            returnOriginalDiscountSpan.textContent = `-$${receiptData.discountAmount.toFixed(2)}`;

            // Populate items to return list
            returnItemsListBody.innerHTML = '';
            receiptData.cartItems.forEach(item => {
                const row = returnItemsListBody.insertRow();
                row.className = 'hover:bg-gray-700';
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = `$${item.price.toFixed(2)}`;
                row.cells[1].classList.add('text-right');
                row.insertCell().textContent = item.quantity;
                row.cells[2].classList.add('text-center');

                const qtyReturnCell = row.insertCell();
                qtyReturnCell.classList.add('text-center');

                const qtyReturnInput = document.createElement('input');
                qtyReturnInput.type = 'number';
                qtyReturnInput.min = '0';
                qtyReturnInput.max = item.quantity.toString();
                qtyReturnInput.value = '0';
                qtyReturnInput.className = 'w-20 p-1 border border-gray-600 rounded-md bg-gray-700 text-gray-100 text-center focus:outline-none focus:ring-2 focus:ring-yellow-500';
                qtyReturnInput.dataset.barcode = item.barcode;
                qtyReturnInput.dataset.originalPrice = item.price.toFixed(2); // Store original price
                qtyReturnInput.addEventListener('input', updateRefundAmounts);
                qtyReturnInput.addEventListener('change', (e) => { // Ensure valid number on blur
                    const val = parseInt(e.target.value);
                    const max = parseInt(e.target.max);
                    if (isNaN(val) || val < 0) e.target.value = 0;
                    else if (val > max) e.target.value = max;
                    updateRefundAmounts();
                });
                qtyReturnCell.appendChild(qtyReturnInput);

                // Initialize itemsToReturnQuantities
                itemsToReturnQuantities[item.barcode] = 0;
            });

            updateRefundAmounts(); // Calculate initial refund (should be $0.00)
            returnItemsModal.classList.remove('hidden');
            // Focus the first quantity input in the return modal
            const firstQtyInput = returnItemsListBody.querySelector('input[type="number"]');
            if (firstQtyInput) {
                firstQtyInput.focus();
            } else {
                closeReturnItemsModalBtn.focus(); // Fallback if no items
            }
        }

        /**
         * Calculates and updates the refund amounts displayed in the return modal.
         */
        function updateRefundAmounts() {
            let totalOriginalPriceOfReturnedItems = 0;

            // Collect quantities to return and calculate subtotal based on original prices
            returnItemsListBody.querySelectorAll('input[type="number"]').forEach(input => {
                const barcode = input.dataset.barcode;
                const qty = parseInt(input.value) || 0; // Default to 0 if not a number
                const originalPrice = parseFloat(input.dataset.originalPrice);

                itemsToReturnQuantities[barcode] = qty;
                totalOriginalPriceOfReturnedItems += qty * originalPrice;
            });

            // Calculate prorated discount and tax
            const originalReceipt = currentReceiptForReturn;
            let proratedDiscount = 0;
            if (originalReceipt.subtotal > 0 && originalReceipt.discountAmount > 0) {
                const discountProportion = originalReceipt.discountAmount / originalReceipt.subtotal;
                proratedDiscount = totalOriginalPriceOfReturnedItems * discountProportion;
            }

            const subtotalAfterProratedDiscount = totalOriginalPriceOfReturnedItems - proratedDiscount;
            const refundTax = subtotalAfterProratedDiscount * TAX_RATE; // Calculate tax on the refunded subtotal for the receipt

            // Update display. Total Refund Due is now pre-tax.
            estimatedRefundSubtotalSpan.textContent = `$${totalOriginalPriceOfReturnedItems.toFixed(2)}`;
            proratedOriginalDiscountSpan.textContent = `-$${proratedDiscount.toFixed(2)}`;
            // refundTaxAmountSpan.textContent = `$${refundTax.toFixed(2)}`; // This span is now hidden from the user, but calculation is kept
            totalRefundAmountSpan.textContent = `$${subtotalAfterProratedDiscount.toFixed(2)}`;
        }

        /**
         * Generates the HTML content for a return receipt.
         * @param {Object} returnData - The data for the return receipt.
         * @returns {string} HTML string of the return receipt.
         */
        function generateReturnReceiptHtml(returnData) {
            const { storeName, storeAddress, storePhone, storeWebsite, logoUrl, receiptFooterMessage } = storeSettings; // Use current store settings

            let receiptHtml = `
                <div class="receipt-container">
                    <div class="receipt-header text-center mb-6">
                        ${logoUrl ? `<img id="receipt-logo" src="${logoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/150x50/1e40af/ffffff?text=Logo+Not+Found';" alt="Store Logo">` : ''}
                        <h2>${storeName}</h2>
                        <p>${storeAddress}</p>
                        <p>${storePhone} | ${storeWebsite}</p>
                        <div class="dashed-line"></div>
                        <h3 class="text-xl font-bold">RETURN RECEIPT</h3>
                        <div class="dashed-line"></div>
                        <p>Date: ${new Date(returnData.timestamp).toLocaleDateString()}</p>
                        <p>Time: ${new Date(returnData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                        <p>Return ID: ${returnData.returnId}</p>
                        <p>Original Txn ID: ${returnData.originalTransactionId}</p>
                        <div class="dashed-line"></div>
                    </div>

                    <table class="receipt-items w-full mb-6">
                        <thead>
                            <tr>
                                <th class="text-left">Item (Returned)</th>
                                <th class="text-right">Price (Paid)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

            returnData.returnedItems.forEach(item => {
                receiptHtml += `
                    <tr>
                        <td class="text-left">${item.name} x ${item.returnedQuantity}</td>
                        <td class="text-right">$${item.originalPriceAtPurchase.toFixed(2)}</td>
                    </tr>
                `;
            });

            receiptHtml += `
                        </tbody>
                    </table>

                    <div class="dashed-line"></div>

                    <div class="receipt-totals mb-6">
                        <div>
                            <span>Refund Subtotal:</span>
                            <span>$${returnData.refundSubtotal.toFixed(2)}</span>
                        </div>
                        ${returnData.proratedOriginalDiscount > 0 ? `
                            <div class="text-red-600">
                                <span>Prorated Original Discount:</span>
                                <span>-$${returnData.proratedOriginalDiscount.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div>
                            <span>Refund Tax (${(TAX_RATE * 100).toFixed(2)}%):</span>
                            <span>$${returnData.refundTax.toFixed(2)}</span>
                        </div>
                        <h3 class="mt-2 pt-2 border-t-2 border-black">
                            <span>TOTAL REFUND:</span>
                            <span>$${returnData.finalRefundAmount.toFixed(2)}</span>
                        </h3>
                    </div>

                    <div class="dashed-line"></div>

                    <div class="receipt-barcode text-center mb-6">
                        <p class="font-bold">Return Barcode:</p>
                        <svg id="return-transaction-barcode" class="w-full"></svg>
                    </div>

                    <div class="dashed-line"></div>

                    <div class="receipt-footer text-center">
                        <p class="font-bold">${receiptFooterMessage}</p>
                        <p class="text-xs">Refunds processed based on original purchase price.</p>
                    </div>
                </div>
            `;
            return receiptHtml;
        }


        /**
         * Processes the return, calculates final refund, and prints a return receipt.
         */
        function processReturnAndPrint() {
            const returnedItems = [];
            let totalOriginalPriceOfReturnedItems = 0;

            // Collect selected items for return
            currentReceiptForReturn.cartItems.forEach(originalItem => {
                const qtyToReturn = itemsToReturnQuantities[originalItem.barcode] || 0;
                if (qtyToReturn > 0) {
                    returnedItems.push({
                        barcode: originalItem.barcode,
                        name: originalItem.name,
                        originalPriceAtPurchase: originalItem.price, // Use price from original receipt
                        returnedQuantity: qtyToReturn,
                        subtotalReturned: originalItem.price * qtyToReturn
                    });
                    totalOriginalPriceOfReturnedItems += originalItem.price * qtyToReturn;
                }
            });

            if (returnedItems.length === 0) {
                showMessageBox("No items selected for return.");
                return;
            }

            // Calculate prorated discount and tax based on the original receipt
            const originalReceipt = currentReceiptForReturn;
            let proratedOriginalDiscount = 0;
            if (originalReceipt.subtotal > 0 && originalReceipt.discountAmount > 0) {
                const discountProportion = originalReceipt.discountAmount / originalReceipt.subtotal;
                proratedOriginalDiscount = totalOriginalPriceOfReturnedItems * discountProportion;
            }

            const subtotalRefundAfterDiscount = totalOriginalPriceOfReturnedItems - proratedOriginalDiscount;
            const refundTax = subtotalRefundAfterDiscount * TAX_RATE;
            const finalRefundAmountTotal = subtotalRefundAfterDiscount + refundTax; // This is the actual total refund including tax for accounting

            const returnTransactionId = `RET-${generateRandomBarcodeNumber()}`;
            const returnTimestamp = new Date().toISOString();

            const returnData = {
                returnId: returnTransactionId,
                originalTransactionId: originalReceipt.transactionId,
                timestamp: returnTimestamp,
                returnedItems: returnedItems,
                refundSubtotal: totalOriginalPriceOfReturnedItems,
                proratedOriginalDiscount: proratedOriginalDiscount,
                refundTax: refundTax,
                finalRefundAmount: finalRefundAmountTotal, // Pass the full amount for printing on receipt
                storeInfo: { ...storeSettings } // Snapshot current store settings for return receipt
            };

            // Generate HTML for return receipt and print
            receiptPrintArea.innerHTML = generateReturnReceiptHtml(returnData);

            // Render barcode for return receipt
            const returnBarcodeElement = receiptPrintArea.querySelector('#return-transaction-barcode');
            if (returnBarcodeElement) {
                try {
                    JsBarcode(returnBarcodeElement, returnTransactionId, {
                        format: "CODE128",
                        displayValue: true,
                        width: 1.5,
                        height: 50,
                        margin: 5,
                        fontSize: 12,
                        lineColor: "#000",
                        background: "#fff"
                    });
                } catch (e) {
                    console.error(`Error generating return barcode (${returnTransactionId}):`, e);
                    returnBarcodeElement.textContent = `Code: ${returnTransactionId}`;
                }
            }

            receiptPrintArea.classList.remove('hidden');
            window.print();
            receiptPrintArea.classList.add('hidden');

            // --- Handle Original Receipt Deletion (if applicable) ---
            // If all items from a single-item original receipt are returned, delete the original receipt.
            if (returnedItems.length === originalReceipt.cartItems.length && originalReceipt.cartItems.length === 1) {
                const receiptIndex = receipts.findIndex(r => r.transactionId === originalReceipt.transactionId);
                if (receiptIndex > -1) {
                    receipts.splice(receiptIndex, 1);
                    saveData(); // Save updated receipts array
                    renderReceiptsHistory(); // Re-render receipts list
                    console.log(`Original receipt ${originalReceipt.transactionId} deleted as all items from a single-item purchase were returned.`);
                }
            }

            // Close modals and refocus
            returnItemsModal.classList.add('hidden');
            historicalReceiptModal.classList.add('hidden');
            if (lastFocusedElement) {
                lastFocusedElement.focus(); // Restore focus to the button that opened the receipt details
                lastFocusedElement = null;
            }
            // After successful return, always refocus the sales terminal barcode input
            barcodeScannerInput.focus();

            showMessageBox(`Return processed! Give customer: $${subtotalRefundAfterDiscount.toFixed(2)}`); // Display pre-tax refund
        }


        // --- Reports Functionality ---
        /**
         * Calculates and updates sales reports for various time periods.
         */
        function updateReports() {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            let salesLastHour = 0;
            let salesLast24Hours = 0;
            let salesLast30Days = 0;
            let salesAllTime = 0;

            receipts.forEach(receipt => {
                const receiptTime = new Date(receipt.timestamp);
                const finalTotal = receipt.finalTotal;

                salesAllTime += finalTotal;

                if (receiptTime > thirtyDaysAgo) {
                    salesLast30Days += finalTotal;
                }
                if (receiptTime > twentyFourHoursAgo) {
                    salesLast24Hours += finalTotal;
                }
                if (receiptTime > oneHourAgo) {
                    salesLastHour += finalTotal;
                }
            });

            reportLastHourSpan.textContent = `$${salesLastHour.toFixed(2)}`;
            reportLast24HoursSpan.textContent = `$${salesLast24Hours.toFixed(2)}`;
            reportLastMonthSpan.textContent = `$${salesLast30Days.toFixed(2)}`;
            reportTotalSalesSpan.textContent = `$${salesAllTime.toFixed(2)}`;
        }


        // --- Settings Functions ---

        /**
         * Loads current store settings into the settings form fields.
         */
        function loadSettingsIntoForm() {
            storeNameInput.value = storeSettings.storeName;
            storeAddressInput.value = storeSettings.storeAddress;
            storePhoneInput.value = storeSettings.storePhone;
            storeWebsiteInput.value = storeSettings.storeWebsite;
            receiptFooterMessageInput.value = storeSettings.receiptFooterMessage; // Load footer message
            currentLogoPreview.src = storeSettings.logoUrl;
            // Add fallback for logo if URL is broken or not set
            currentLogoPreview.onerror = function() {
                this.src = 'https://placehold.co/150x50/1e40af/ffffff?text=Logo+Not+Found';
            };
             if (!storeSettings.logoUrl) {
                currentLogoPreview.src = 'https://placehold.co/150x50/1e40af/ffffff?text=Your+Logo'; // Set default if empty
            }
        }

        /**
         * Saves settings from the form into the global storeSettings object.
         */
        function saveSettings() {
            storeSettings.storeName = storeNameInput.value.trim();
            storeSettings.storeAddress = storeAddressInput.value.trim();
            storeSettings.storePhone = storePhoneInput.value.trim();
            storeSettings.storeWebsite = storeWebsiteInput.value.trim();
            storeSettings.receiptFooterMessage = receiptFooterMessageInput.value.trim(); // Save footer message
            // logoUrl is updated directly by handleLogoUpload and saveData() is called there
            saveData(); // Save other settings changes
            showMessageBox('Settings saved successfully!');
        }

        /**
         * Handles the logo file input change event. Reads the selected file as a Data URL.
         */
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showMessageBox('Please upload an image file (e.g., JPG, PNG, GIF).');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    storeSettings.logoUrl = e.target.result; // Save Data URL
                    currentLogoPreview.src = e.target.result; // Update preview
                    saveData(); // Save changes to local storage immediately
                    showMessageBox('Logo uploaded and saved!');
                };
                reader.onerror = () => {
                    showMessageBox('Error reading file. Please try again.');
                };
                reader.readAsDataURL(file); // Read file as Data URL
            }
        }


        // --- Event Listeners ---

        // Tab Switching
        tabButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                switchTab(button.dataset.tab);
            });
            // Add keydown listener for arrow keys on tab buttons
            button.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowRight' || event.key === 'ArrowLeft') {
                    event.preventDefault(); // Prevent default browser behavior (e.g., scrolling)
                    const currentTabIndex = Array.from(tabButtons).indexOf(event.target);
                    let nextTabIndex;

                    if (event.key === 'ArrowRight') {
                        nextTabIndex = (currentTabIndex + 1) % tabButtons.length;
                    } else { // ArrowLeft
                        nextTabIndex = (currentTabIndex - 1 + tabButtons.length) % tabButtons.length;
                    }
                    switchTab(tabButtons[nextTabIndex].dataset.tab);
                }
            });
        });

        // Sales Terminal: Custom Item
        addCustomItemButton.addEventListener('click', () => {
            const price = parseFloat(customItemPriceInput.value);
            const description = customItemDescriptionInput.value.trim();

            if (!isNaN(price) && price > 0) {
                addCustomItemToCart(description, price);
            } else {
                showMessageBox('Please enter a valid price for the custom item.');
            }
        });

        customItemPriceInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                addCustomItemButton.click(); // Trigger the add custom item logic
            }
        });


        // Product Management: Add Product Button
        addProductButton.addEventListener('click', () => {
            const barcode = newProductBarcodeInput.value.trim();
            const name = newProductNameInput.value.trim();
            const price = parseFloat(newProductPriceInput.value);

            if (barcode && name && !isNaN(price) && price > 0) {
                if (addProduct(barcode, name, price)) {
                    newProductBarcodeInput.value = '';
                    newProductNameInput.value = '';
                    newProductPriceInput.value = '';
                    showMessageBox('Product added successfully!');
                }
            } else {
                showMessageBox('Please enter a unique barcode, valid product name, and price.');
            }
        });

        // Coupon Management: Generate Coupon Code Button
        generateCouponCodeButton.addEventListener('click', () => {
            newCouponCodeInput.value = generate30DigitCode();
        });

        // Coupon Management: Dynamic fields based on application type
        newCouponApplicationTypeSelect.addEventListener('change', () => {
            minPurchaseAmountDiv.classList.add('hidden');
            newCouponMinPurchaseAmountInput.removeAttribute('required');
            targetProductBarcodeDiv.classList.add('hidden');
            newCouponTargetProductBarcodeInput.removeAttribute('required');

            const selectedType = newCouponApplicationTypeSelect.value;
            if (selectedType === 'min-purchase') {
                minPurchaseAmountDiv.classList.remove('hidden');
                newCouponMinPurchaseAmountInput.setAttribute('required', 'required');
            } else if (selectedType === 'by-product') {
                targetProductBarcodeDiv.classList.remove('hidden');
                newCouponTargetProductBarcodeInput.setAttribute('required', 'required');
            }
        });

        // Coupon Management: Add Coupon Button
        addCouponButton.addEventListener('click', () => {
            const code = newCouponCodeInput.value.trim(); // Code is already generated
            const title = newCouponTitleInput.value.trim();
            const applicationType = newCouponApplicationTypeSelect.value;
            const discountType = newCouponTypeSelect.value;
            const discountValue = parseFloat(newCouponValueInput.value);
            let minPurchaseAmount = 0;
            let targetProductBarcode = '';

            let isValid = true;
            let errorMessage = '';

            if (!code || !title || isNaN(discountValue) || discountValue < 0) {
                isValid = false;
                errorMessage = 'Please ensure a code is generated, and fill in coupon title and valid discount value.';
            }

            if (applicationType === 'min-purchase') {
                minPurchaseAmount = parseFloat(newCouponMinPurchaseAmountInput.value);
                if (isNaN(minPurchaseAmount) || minPurchaseAmount < 0) {
                    isValid = false;
                    errorMessage = 'Please enter a valid minimum purchase amount.';
                }
            } else if (applicationType === 'by-product') {
                targetProductBarcode = newCouponTargetProductBarcodeInput.value.trim();
                if (!targetProductBarcode) {
                    isValid = false;
                    errorMessage = 'Please enter a target product barcode for "By Product" coupons.';
                } else if (!products.some(p => p.barcode === targetProductBarcode)) {
                    isValid = false;
                    errorMessage = `Product with barcode "${targetProductBarcode}" does not exist. Please add it first.`;
                }
            }

            if (isValid) {
                const newCoupon = {
                    code: code,
                    title: title,
                    applicationType: applicationType,
                    type: discountType,
                    value: discountValue,
                    minPurchaseAmount: minPurchaseAmount,
                    targetProductBarcode: targetProductBarcode
                };
                if (addCoupon(newCoupon)) {
                    newCouponCodeInput.value = generate30DigitCode(); // Generate new code for next entry
                    newCouponTitleInput.value = '';
                    newCouponApplicationTypeSelect.value = 'full-total'; // Reset dropdown
                    newCouponMinPurchaseAmountInput.value = ''; // Clear conditionally hidden fields
                    newCouponTargetProductBarcodeInput.value = '';
                    minPurchaseAmountDiv.classList.add('hidden'); // Hide them
                    targetProductBarcodeDiv.classList.add('hidden');
                    newCouponMinPurchaseAmountInput.removeAttribute('required');
                    newCouponTargetProductBarcodeInput.removeAttribute('required');
                    newCouponTypeSelect.value = 'percentage'; // Reset discount type
                    newCouponValueInput.value = '';
                    showMessageBox('Coupon added successfully!');
                }
            } else {
                showMessageBox(errorMessage);
            }
        });


        // Sales Terminal: Barcode Scanner Input (for adding to cart)
        barcodeScannerInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const barcode = barcodeScannerInput.value.trim();
                if (barcode) {
                    addProductToCart(barcode);
                    barcodeScannerInput.value = ''; // Clear input after "scan"
                    barcodeScannerInput.focus(); // Keep focus for next scan
                } else {
                    showMessageBox('Please enter a barcode to add to cart.');
                }
            }
        });

        // Sales Terminal: Apply Coupon Button
        applyCouponButton.addEventListener('click', applyCoupon);

        // Checkout Button - show payment method modal instead of direct print
        checkoutButton.addEventListener('click', () => {
            if (cart.length === 0) {
                showMessageBox('Cart is empty. Please add items before checking out.');
                return;
            }
            lastFocusedElement = document.activeElement; // Store current focus before opening modal
            paymentMethodModal.classList.remove('hidden');
            payCashButton.focus(); // Focus on the first button in the modal
        });

        // Payment Method Modal Buttons
        payCashButton.addEventListener('click', () => {
            paymentMethodModal.classList.add('hidden');
            generateReceipt('Cash');
            // Focus will be handled by generateReceipt now
        });

        payCardButton.addEventListener('click', () => {
            paymentMethodModal.classList.add('hidden');
            generateReceipt('Card');
            // Focus will be handled by generateReceipt now
        });

        // Message box OK button
        messageOkButton.addEventListener('click', hideMessageBox);
        messageBox.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' || event.key === 'Enter' || event.key === 'Space') { // Also allow Enter/Space to dismiss
                hideMessageBox();
            }
        });

        // Close Historical Receipt Modal
        closeHistoricalReceiptModalBtn.addEventListener('click', () => {
            historicalReceiptModal.classList.add('hidden');
            historicalReceiptContent.innerHTML = ''; // Clear content
            currentReceiptForReturn = null; // Clear global variable
            if (lastFocusedElement) {
                lastFocusedElement.focus(); // Restore focus
                lastFocusedElement = null;
            }
        });
        historicalReceiptModal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeHistoricalReceiptModalBtn.click(); // Trigger click to use the existing close logic
            }
             if (event.key === 'Enter' || event.key === 'Space') {
                // If focus is on Print button, trigger it. Otherwise, close modal.
                if (document.activeElement === printHistoricalReceiptBtn) {
                    printHistoricalReceiptBtn.click();
                } else if (document.activeElement === returnItemsButton) {
                    returnItemsButton.click();
                }
                // Don't close with enter/space on the close button itself, allow it to be focused but keep it explicit
            }
        });

        // NEW: Return Items Button on Historical Receipt Modal
        returnItemsButton.addEventListener('click', () => {
            if (currentReceiptForReturn) {
                historicalReceiptModal.classList.add('hidden'); // Hide original receipt modal
                openReturnItemsModal(currentReceiptForReturn);
            }
        });

        // Return Items Modal: Close button
        closeReturnItemsModalBtn.addEventListener('click', () => {
            returnItemsModal.classList.add('hidden');
            returnItemsListBody.innerHTML = ''; // Clear items
            currentReceiptForReturn = null; // Clear active return receipt
            if (lastFocusedElement) {
                lastFocusedElement.focus(); // Restore focus to the element that opened the return modal (likely 'Return Items' button)
                lastFocusedElement = null;
            }
        });
        returnItemsModal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeReturnItemsModalBtn.click();
            }
            if (event.key === 'Enter' || event.key === 'Space') {
                 // If focus is on Process button, trigger it. Otherwise, if on Cancel, trigger it.
                if (document.activeElement === processReturnButton) {
                    processReturnButton.click();
                } else if (document.activeElement === cancelReturnButton) {
                    cancelReturnButton.click();
                }
            }
        });

        // Return Items Modal: Process Return Button
        processReturnButton.addEventListener('click', processReturnAndPrint);

        // Return Items Modal: Cancel Return Button
        cancelReturnButton.addEventListener('click', () => {
            returnItemsModal.classList.add('hidden');
            returnItemsListBody.innerHTML = ''; // Clear items
            currentReceiptForReturn = null; // Clear active return receipt
            if (lastFocusedElement) {
                lastFocusedElement.focus(); // Restore focus
                lastFocusedElement = null;
            }
        });


        // Keyboard Instructions Modal Buttons
        closeKeyboardInstructionsModalBtn.addEventListener('click', hideKeyboardInstructions);
        keyboardInstructionsOkButton.addEventListener('click', hideKeyboardInstructions);
        keyboardInstructionsModal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' || event.key === 'Enter' || event.key === 'Space') { // Allow Enter/Space to dismiss
                hideKeyboardInstructions();
            }
        });

        // Receipts History Search Input
        receiptSearchInput.addEventListener('keyup', (event) => {
            renderReceiptsHistory(event.target.value);
        });

        // Settings: Save All Settings Button
        saveSettingsButton.addEventListener('click', saveSettings);

        // Settings: Logo Upload related event listeners
        uploadLogoButton.addEventListener('click', () => logoFileInput.click());
        logoFileInput.addEventListener('change', handleLogoUpload);

        // Global hotkey listener for Ctrl + I
        document.addEventListener('keydown', (event) => {
            // Check for Ctrl (or Command on Mac) + I
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'i') {
                event.preventDefault(); // Prevent browser default action for Ctrl+I
                showKeyboardInstructions();
            }
            // Allow Escape to close payment modal if open
            if (event.key === 'Escape' && !paymentMethodModal.classList.contains('hidden')) {
                paymentMethodModal.classList.add('hidden');
                if (lastFocusedElement) {
                    lastFocusedElement.focus(); // Restore focus
                    lastFocusedElement = null;
                }
            }
        });

        // --- Initial setup ---
        window.onload = () => {
            loadData(); // Load all data from local storage first
            updateCartDisplay(); // Initialize empty cart display
            loadSettingsIntoForm(); // Populate settings form with loaded data
            switchTab('sales'); // Start on the Sales Terminal tab (this will also render initial lists)

            // Ensure tab buttons are correctly initialized for keyboard navigation
            tabButtons.forEach((button, index) => {
                button.setAttribute('role', 'tab');
                button.setAttribute('aria-controls', `${button.dataset.tab}-tab-content`);
                if (index === 0) { // Set first tab as initially selected and focusable
                    button.setAttribute('tabindex', '0');
                    button.setAttribute('aria-selected', 'true');
                } else {
                    button.setAttribute('tabindex', '-1');
                    button.setAttribute('aria-selected', 'false');
                }
            });
        };
    </script>
</body>
</html>
