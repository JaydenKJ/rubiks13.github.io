<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Search Library Books</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      padding: 30px;
      max-width: 800px;
      margin: auto;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin: 10px 0 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 10px 16px;
      background-color: #2c7be5;
      border: none;
      color: #fff;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #1a5ec8;
    }

    .book-card {
      background: #fff;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .book-title {
      font-weight: bold;
      font-size: 18px;
    }

    .book-author, .book-callnumber, .book-barcode, .book-status {
      font-size: 14px;
      margin-top: 4px;
    }

    .status-checked-in {
      color: green;
      font-weight: bold;
    }

    .status-checked-out {
      color: red;
      font-weight: bold;
    }

    #noResults {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üìö Search Library Books</h1>
  <input type="text" id="searchTitle" placeholder="Enter book title or author..." onkeydown="if(event.key === 'Enter') searchBooks()" />
  <button onclick="searchBooks()">Search</button>

  <!-- Admin Button -->
  <button id="adminToggleBtn" onclick="toggleAdminMode()" style="position: fixed; top: 20px; right: 20px; background-color: #e74c3c; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">Admin</button>

  <div id="results"></div>

  <script>
    let books = JSON.parse(localStorage.getItem("bookDB")) || {
      "123": { title: "The Berenstain Bears Go to School", author: "Stan Berenstain", callNumber: "BER123" },
      "456": { title: "Charlotte's Web", author: "E. B. White", callNumber: "CHA456" },
      "789": { title: "The Bearenstein Bears and the Messy Room", author: "Jan Berenstain", callNumber: "BER789" }
    };

    let checkouts = JSON.parse(localStorage.getItem("checkoutLog")) || [];
    let adminMode = false;

    function toggleAdminMode() {
      if (!adminMode) {
        const code = prompt("Enter admin code:");
        if (code === "82184088") {
          adminMode = true;
          alert("Admin mode enabled.");
          document.getElementById("adminToggleBtn").style.backgroundColor = "#27ae60";
        } else {
          alert("Incorrect code.");
        }
      } else {
        adminMode = false;
        alert("Admin mode disabled.");
        document.getElementById("adminToggleBtn").style.backgroundColor = "#e74c3c";
      }
      searchBooks();
    }

    function searchBooks() {
      const query = document.getElementById("searchTitle").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      let matches = [];

      if (!query) {
        matches = Object.entries(books).map(([barcode, book]) => ({ barcode, book }))
          .sort((a, b) => a.book.title.localeCompare(b.book.title));
      } else {
        for (const [barcode, book] of Object.entries(books)) {
          const titleScore = similarityScore(book.title, query);
          const authorScore = similarityScore(book.author, query);
          const score = Math.max(titleScore, authorScore);
          if (score > 0.5) {
            matches.push({ book, barcode, score });
          }
        }

        if (matches.length === 0) {
          resultsDiv.innerHTML = `<p id="noResults">No books found matching "${query}".</p>`;
          return;
        }

        matches.sort((a, b) => b.score - a.score);
      }

      matches.forEach(({ book, barcode }) => {
        const activeCheckout = checkouts.find(c => c.barcode === barcode && !c.checkedIn);
        let statusHTML = activeCheckout ?
          `<div class="book-status status-checked-out">‚ùå Checked Out by ${activeCheckout.name} (Due: ${formatDate(activeCheckout.dueDate)})</div>` :
          `<div class="book-status status-checked-in">‚úÖ Checked In</div>`;

        const bookCard = document.createElement("div");
        bookCard.className = "book-card";

        if (adminMode) {
          bookCard.innerHTML = `
            <div><strong>Title:</strong> <input value="${book.title}" onchange="updateBook('${barcode}', 'title', this.value)" /></div>
            <div><strong>Author:</strong> <input value="${book.author}" onchange="updateBook('${barcode}', 'author', this.value)" /></div>
            <div><strong>Call Number:</strong> <input value="${book.callNumber}" onchange="updateBook('${barcode}', 'callNumber', this.value)" /></div>
            <div><strong>Barcode:</strong> <input value="${barcode}" onchange="changeBarcode('${barcode}', this.value)" /></div>
            ${statusHTML}
            <button onclick="deleteBook('${barcode}')" style="margin-top: 10px; background-color: #c0392b; color: white; padding: 6px 10px; border: none; border-radius: 4px;">Delete Book</button>
          `;
        } else {
          bookCard.innerHTML = `
            <div class="book-title">${book.title}</div>
            <div class="book-author"><strong>Author:</strong> ${book.author}</div>
            <div class="book-callnumber"><strong>Call Number:</strong> ${book.callNumber}</div>
            <div class="book-barcode"><strong>Barcode:</strong> ${barcode}</div>
            ${statusHTML}
          `;
        }

        resultsDiv.appendChild(bookCard);
      });
    }

    function updateBook(barcode, field, value) {
      books[barcode][field] = value;
      localStorage.setItem("bookDB", JSON.stringify(books));
    }

    function changeBarcode(oldBarcode, newBarcode) {
      if (!newBarcode || newBarcode === oldBarcode || books[newBarcode]) {
        alert("Invalid or duplicate barcode.");
        searchBooks();
        return;
      }
      books[newBarcode] = books[oldBarcode];
      delete books[oldBarcode];
      localStorage.setItem("bookDB", JSON.stringify(books));
      searchBooks();
    }

    function deleteBook(barcode) {
      if (confirm("Are you sure you want to delete this book?")) {
        delete books[barcode];
        localStorage.setItem("bookDB", JSON.stringify(books));
        searchBooks();
      }
    }

    function levenshtein(a, b) {
      const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);
      for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + (b[i - 1] === a[j - 1] ? 0 : 1),
            matrix[i][j - 1] + 1,
            matrix[i - 1][j] + 1
          );
        }
      }
      return matrix[b.length][a.length];
    }

    function normalize(text) {
      return text.toLowerCase().replace(/[^a-z0-9\s]/g, "").trim();
    }

    function similarityScore(a, b) {
      const normA = normalize(a);
      const normB = normalize(b);
      const dist = levenshtein(normA, normB);
      return 1 - dist / Math.max(normA.length, normB.length);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
    }

    let idleTimer;
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        location.reload();
      }, 10000);
    }
    ['mousemove', 'keydown', 'mousedown', 'touchstart'].forEach(event => {
      document.addEventListener(event, resetIdleTimer);
    });
    resetIdleTimer();

    window.onload = searchBooks;
  </script>
</body>
</html>
